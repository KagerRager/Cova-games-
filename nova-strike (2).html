<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOVA STRIKE</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#000;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    font-family:'Rajdhani',sans-serif;
    overflow:hidden;
  }
  #wrap {
    position:relative;
    width:480px;
    height:680px;
  }
  canvas {
    display:block;
    width:480px;
    height:680px;
    border:1px solid #1a1a2e;
    box-shadow: 0 0 60px rgba(0,200,255,0.15), 0 0 120px rgba(0,200,255,0.05);
  }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c"></canvas>
</div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = 480;
canvas.height = 680;
const W = 480, H = 680, CX = W/2;

// â”€â”€ SHIP SKINS â”€â”€
const SKINS = [
  { name:'VIPER',   color:'#00e5ff', accent:'#ffffff', trail:'#0077ff' },
  { name:'PHANTOM', color:'#ff3cac', accent:'#ffffff', trail:'#cc0088' },
  { name:'TITAN',   color:'#39ff14', accent:'#ffffff', trail:'#00bb00' },
  { name:'SHADOW',  color:'#bb86fc', accent:'#ffffff', trail:'#7c4dff' },
  { name:'INFERNO', color:'#ff6b35', accent:'#ffee00', trail:'#ff2200' },
  { name:'AURORA',  color:'#00ffcc', accent:'#ffffff', trail:'#00aaaa' },
];

// â”€â”€ STATE â”€â”€
let state = 'menu';
let chosenSkin = 0;
let score = 0, lives = 3, wave = 1;
let hiScore = +localStorage.getItem('ns2_hi')||0;
let shakeX=0, shakeY=0, shakeDur=0;

// â”€â”€ STARS â”€â”€
const stars = Array.from({length:130}, ()=>({
  x: Math.random()*W, y: Math.random()*H,
  r: Math.random()*1.5+0.3,
  speed: Math.random()*0.9+0.15,
  phase: Math.random()*Math.PI*2
}));

// â”€â”€ PLAYER â”€â”€
let player, bullets, eBullets, enemies, particles, powerups, trails, divers;

function makePlayer(){
  return {x:CX, y:H-80, speed:4.8,
    shootTimer:0, invincible:0, shield:0, rapidFire:0, dead:false};
}

// â”€â”€ UTILS â”€â”€
function rand(a,b){ return a+Math.random()*(b-a); }
function randInt(a,b){ return Math.floor(rand(a,b+1)); }
function shake(amt,dur){ shakeDur=dur; shakeX=(Math.random()-0.5)*amt; shakeY=(Math.random()-0.5)*amt; }
function burst(x,y,color,n=12){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, s=rand(1,4.5);
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:rand(1.5,4),life:1,color,fade:rand(0.02,0.045)});
  }
}

let tick = 0;

// â”€â”€ WAVE â”€â”€
const ROWS=4, COLS=9;
function spawnWave(){
  enemies=[]; divers=[];
  const types = wave<2?['basic']:wave<4?['basic','fast']:['basic','fast','tank'];
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(r===0 && c%3!==1) continue; // sparse top row
      const type = types[randInt(0,types.length-1)];
      const hx = 45 + c*(W-90)/(COLS-1);
      const hy = 75 + r*52;
      enemies.push({
        x:hx, y:-60-r*55,
        hx, hy,
        type, hp:type==='tank'?3:1,
        inFormation:false,
        enterT: r*16+c*5,
        t:0, animT:Math.random()*Math.PI*2,
        diving:false, divePath:[], divePathIdx:0,
        shootTimer:randInt(60,200),
        w:26, h:26
      });
    }
  }
}

function buildDivePath(e){
  const path=[];
  const steps=90;
  const cp1x=e.x+rand(-120,120), cp1y=e.y+rand(90,200);
  const cp2x=player.x+rand(-80,80), cp2y=player.y-rand(60,140);
  const ex=e.hx+rand(-15,15), ey=-90;
  for(let i=0;i<=steps;i++){
    const t=i/steps, it=1-t;
    path.push({
      x:it*it*it*e.x+3*it*it*t*cp1x+3*it*t*t*cp2x+t*t*t*ex,
      y:it*it*it*e.y+3*it*it*t*cp1y+3*it*t*t*cp2y+t*t*t*ey
    });
  }
  return path;
}

function resetGame(){
  score=0; lives=3; wave=1;
  player=makePlayer();
  bullets=[]; eBullets=[]; particles=[]; powerups=[]; trails=[]; divers=[];
  spawnWave();
}

// â”€â”€ INPUT â”€â”€
const keys={};
document.addEventListener('keydown',e=>{ keys[e.key]=true; if(e.key===' ')e.preventDefault(); });
document.addEventListener('keyup',e=>{ keys[e.key]=false; });

// â”€â”€ DRAW HELPERS â”€â”€
function hexRgb(h){ return [parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)]; }

function drawShip(x,y,skinIdx,sc=1,engine=true){
  const s=SKINS[skinIdx];
  ctx.save();
  ctx.translate(x,y); ctx.scale(sc,sc);
  if(engine){
    const [r,g,b]=hexRgb(s.trail);
    const g2=ctx.createRadialGradient(0,16,0,0,16,22);
    g2.addColorStop(0,`rgba(${r},${g},${b},0.9)`);
    g2.addColorStop(1,'transparent');
    ctx.fillStyle=g2; ctx.fillRect(-22,8,44,34);
  }
  ctx.shadowBlur=20; ctx.shadowColor=s.color; ctx.fillStyle=s.color;
  ctx.beginPath();
  ctx.moveTo(0,-18); ctx.lineTo(-14,14); ctx.lineTo(-6,9); ctx.lineTo(0,15);
  ctx.lineTo(6,9); ctx.lineTo(14,14); ctx.closePath(); ctx.fill();
  ctx.shadowBlur=8; ctx.shadowColor='#fff'; ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.arc(0,-3,5,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=0.5; ctx.strokeStyle=s.accent; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(-11,8); ctx.lineTo(-14,14); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(11,8); ctx.lineTo(14,14); ctx.stroke();
  ctx.globalAlpha=1; ctx.shadowBlur=0; ctx.restore();
}

function drawEnemy(e){
  ctx.save();
  ctx.translate(e.x,e.y);
  const pulse=0.92+Math.sin(e.animT*3)*0.08;
  if(e.type==='basic'){
    ctx.shadowBlur=14; ctx.shadowColor='#ff3333'; ctx.fillStyle='#ff3333';
    ctx.save(); ctx.scale(pulse,pulse);
    ctx.beginPath();
    ctx.moveTo(0,-12); ctx.lineTo(-9,-4); ctx.lineTo(-13,5);
    ctx.lineTo(-7,12); ctx.lineTo(0,8); ctx.lineTo(7,12);
    ctx.lineTo(13,5); ctx.lineTo(9,-4); ctx.closePath(); ctx.fill();
    ctx.fillStyle='#ffee00'; ctx.shadowColor='#ffee00'; ctx.shadowBlur=8;
    ctx.beginPath(); ctx.arc(-4,-2,2.5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(4,-2,2.5,0,Math.PI*2); ctx.fill();
    ctx.restore();
  } else if(e.type==='fast'){
    ctx.shadowBlur=12; ctx.shadowColor='#ff9900'; ctx.fillStyle='#ff9900';
    ctx.save(); ctx.scale(pulse,pulse);
    ctx.beginPath();
    ctx.moveTo(0,-13); ctx.lineTo(-5,-2); ctx.lineTo(-12,3);
    ctx.lineTo(-5,8); ctx.lineTo(0,13); ctx.lineTo(5,8);
    ctx.lineTo(12,3); ctx.lineTo(5,-2); ctx.closePath(); ctx.fill();
    ctx.fillStyle='#fff'; ctx.shadowColor='#fff'; ctx.shadowBlur=4;
    ctx.beginPath(); ctx.arc(-3,-1,2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(3,-1,2,0,Math.PI*2); ctx.fill();
    ctx.restore();
  } else {
    const c=e.hp===3?'#cc00ff':e.hp===2?'#aa00cc':'#880099';
    ctx.shadowBlur=16; ctx.shadowColor=c; ctx.fillStyle=c;
    ctx.save(); ctx.scale(pulse*1.15,pulse*1.15);
    ctx.beginPath(); ctx.arc(0,0,13,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#ff88ff'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.stroke();
    ctx.fillStyle='#ffaaff'; ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  ctx.shadowBlur=0; ctx.restore();
}

function drawBullet(b,enemy=false){
  ctx.save(); ctx.shadowBlur=12;
  if(enemy){
    ctx.shadowColor='#ff3333'; ctx.fillStyle='#ff5555';
    ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fill();
  } else {
    const s=SKINS[chosenSkin];
    ctx.shadowColor=s.color; ctx.fillStyle=s.color;
    ctx.fillRect(b.x-2,b.y-9,4,14);
    ctx.fillStyle='#fff'; ctx.shadowColor='#fff';
    ctx.fillRect(b.x-1,b.y-9,2,6);
  }
  ctx.shadowBlur=0; ctx.restore();
}

function drawPowerup(p){
  ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.t*0.025);
  const cols={life:'#ff3366',rapid:'#ffcc00',shield:'#00ccff'};
  const c=cols[p.type]||'#fff';
  ctx.shadowBlur=18; ctx.shadowColor=c;
  const g=ctx.createRadialGradient(0,0,2,0,0,13);
  g.addColorStop(0,c); g.addColorStop(1,'transparent');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,13,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold 13px sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.shadowBlur=0;
  ctx.fillText(p.type==='life'?'â™¥':p.type==='rapid'?'âš¡':'ðŸ›¡',0,1);
  ctx.restore();
}

function drawStarfield(){
  ctx.fillStyle='#000010'; ctx.fillRect(0,0,W,H);
  stars.forEach(s=>{
    s.y+=s.speed; if(s.y>H){s.y=0;s.x=Math.random()*W;}
    ctx.globalAlpha=0.3+Math.sin(s.phase+=0.02)*0.2;
    ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1;
}

function drawHUD(){
  const s=SKINS[chosenSkin];
  ctx.save();
  ctx.font='bold 14px Orbitron'; ctx.fillStyle=s.color; ctx.shadowBlur=8; ctx.shadowColor=s.color;
  ctx.textAlign='left'; ctx.fillText('SCORE  '+score,14,26);
  ctx.textAlign='right'; ctx.fillText('HI  '+Math.max(score,hiScore),W-14,26);
  for(let i=0;i<lives;i++){
    ctx.save(); ctx.translate(14+i*24,H-22); ctx.scale(0.48,0.48);
    drawShip(0,0,chosenSkin,1,false); ctx.restore();
  }
  ctx.textAlign='center'; ctx.font='11px Rajdhani'; ctx.fillStyle='#555'; ctx.shadowBlur=0;
  ctx.fillText('WAVE '+wave,CX,H-13);
  ctx.restore();
}

// â”€â”€ SCREENS â”€â”€
function drawMenu(){
  drawStarfield();
  ctx.save(); ctx.textAlign='center';
  ctx.font='900 58px Orbitron'; ctx.shadowBlur=50; ctx.shadowColor='#00e5ff'; ctx.fillStyle='#00e5ff';
  ctx.fillText('NOVA',CX,200);
  ctx.fillStyle='#fff'; ctx.shadowColor='#fff'; ctx.shadowBlur=20;
  ctx.fillText('STRIKE',CX,268);
  ctx.shadowBlur=0; ctx.font='14px Rajdhani'; ctx.fillStyle='#666';
  ctx.fillText('HI-SCORE: '+hiScore,CX,310);
  const p=0.8+Math.sin(Date.now()*0.004)*0.2;
  ctx.globalAlpha=p;
  ctx.font='bold 18px Orbitron'; ctx.fillStyle='#00e5ff'; ctx.shadowBlur=14; ctx.shadowColor='#00e5ff';
  ctx.fillText('[ PRESS SPACE TO START ]',CX,400);
  ctx.globalAlpha=1; ctx.shadowBlur=0;
  ctx.font='13px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText('C  â†’  CUSTOMIZE SHIP',CX,450);
  drawShip(CX,540,chosenSkin,2.2,false);
  ctx.font='bold 12px Orbitron'; ctx.fillStyle=SKINS[chosenSkin].color;
  ctx.shadowBlur=8; ctx.shadowColor=SKINS[chosenSkin].color;
  ctx.fillText(SKINS[chosenSkin].name,CX,590);
  ctx.restore();
}

function drawCustomize(){
  drawStarfield();
  ctx.save(); ctx.textAlign='center';
  ctx.font='bold 30px Orbitron'; ctx.fillStyle='#fff'; ctx.shadowBlur=20; ctx.shadowColor='#fff';
  ctx.fillText('CHOOSE YOUR SHIP',CX,55);
  const cols=3;
  for(let i=0;i<SKINS.length;i++){
    const col=i%cols, row=Math.floor(i/cols);
    const x=80+col*160, y=155+row*200;
    const sel=i===chosenSkin;
    ctx.globalAlpha=sel?0.25:0.07;
    ctx.fillStyle=SKINS[i].color;
    ctx.fillRect(x-52,y-65,104,148);
    ctx.globalAlpha=1;
    if(sel){
      ctx.strokeStyle=SKINS[i].color; ctx.lineWidth=2; ctx.shadowBlur=14; ctx.shadowColor=SKINS[i].color;
      ctx.strokeRect(x-52,y-65,104,148);
    }
    drawShip(x,y,i,1.5,false);
    ctx.shadowBlur=sel?10:0; ctx.shadowColor=SKINS[i].color;
    ctx.font=(sel?'bold ':'')+'12px Orbitron';
    ctx.fillStyle=sel?SKINS[i].color:'#666';
    ctx.fillText(SKINS[i].name,x,y+65);
    if(sel){
      ctx.shadowBlur=0; ctx.font='11px Rajdhani'; ctx.fillStyle='#aaa';
      ctx.fillText('â† â†’  to change',x,y+82);
    }
  }
  ctx.shadowBlur=0;
  ctx.font='bold 15px Orbitron'; ctx.fillStyle='#00e5ff'; ctx.shadowBlur=10; ctx.shadowColor='#00e5ff';
  ctx.fillText('[ SPACE ]  PLAY',CX,H-58);
  ctx.shadowBlur=0; ctx.font='12px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText('ESC  â†’  BACK',CX,H-30);
  ctx.restore();
}

function drawGameOver(){
  drawStarfield();
  ctx.save(); ctx.textAlign='center';
  ctx.font='bold 50px Orbitron'; ctx.fillStyle='#ff3366'; ctx.shadowBlur=30; ctx.shadowColor='#ff3366';
  ctx.fillText('GAME OVER',CX,220);
  ctx.shadowBlur=0; ctx.font='22px Rajdhani'; ctx.fillStyle='#aaa';
  ctx.fillText('SCORE: '+score,CX,280);
  if(score>0&&score>=hiScore){
    ctx.fillStyle='#ffcc00'; ctx.font='bold 16px Orbitron'; ctx.shadowBlur=10; ctx.shadowColor='#ffcc00';
    ctx.fillText('âœ¦  NEW HIGH SCORE  âœ¦',CX,318);
  }
  ctx.shadowBlur=0; ctx.font='14px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText('HI-SCORE: '+Math.max(score,hiScore),CX,352);
  const p=0.65+Math.sin(Date.now()*0.004)*0.35;
  ctx.globalAlpha=p;
  ctx.font='bold 18px Orbitron'; ctx.fillStyle='#00e5ff'; ctx.shadowBlur=12; ctx.shadowColor='#00e5ff';
  ctx.fillText('[ SPACE ]  PLAY AGAIN',CX,428);
  ctx.globalAlpha=1; ctx.shadowBlur=0;
  ctx.font='13px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText('C  â†’  CHANGE SHIP',CX,468);
  ctx.restore();
}

// â”€â”€ UPDATE â”€â”€
function update(){
  tick++;

  if(state==='menu'){
    if(keys[' ']){ state='playing'; resetGame(); keys[' ']=false; return; }
    if(keys['c']||keys['C']){ state='customize'; keys['c']=keys['C']=false; return; }
    return;
  }
  if(state==='customize'){
    if(keys['ArrowRight']||keys['d']){ chosenSkin=(chosenSkin+1)%SKINS.length; keys['ArrowRight']=keys['d']=false; }
    if(keys['ArrowLeft']||keys['a']){ chosenSkin=(chosenSkin+SKINS.length-1)%SKINS.length; keys['ArrowLeft']=keys['a']=false; }
    if(keys[' ']){ state='playing'; resetGame(); keys[' ']=false; return; }
    if(keys['Escape']){ state='menu'; keys['Escape']=false; return; }
    return;
  }
  if(state==='gameover'){
    if(keys[' ']){ state='playing'; resetGame(); keys[' ']=false; return; }
    if(keys['c']||keys['C']){ state='customize'; keys['c']=keys['C']=false; return; }
    return;
  }

  // â”€â”€ PLAYING â”€â”€
  // Player move
  if((keys['ArrowLeft']||keys['a'])&&player.x>26) player.x-=player.speed;
  if((keys['ArrowRight']||keys['d'])&&player.x<W-26) player.x+=player.speed;
  if((keys['ArrowUp']||keys['w'])&&player.y>H/2) player.y-=player.speed;
  if((keys['ArrowDown']||keys['s'])&&player.y<H-28) player.y+=player.speed;

  // Trail
  if(tick%3===0){
    const s=SKINS[chosenSkin];
    trails.push({x:player.x+(Math.random()-0.5)*8,y:player.y+16,
      vx:(Math.random()-0.5)*0.4,vy:rand(1,2.5),life:1,r:rand(1,3),color:s.trail});
  }

  // Shoot
  const rate=player.rapidFire>0?5:13;
  player.shootTimer++;
  if(player.shootTimer>=rate&&keys[' ']){
    player.shootTimer=0;
    bullets.push({x:player.x,y:player.y-18,speed:12});
    if(player.rapidFire>0){
      bullets.push({x:player.x-11,y:player.y-10,speed:12,dx:-0.6});
      bullets.push({x:player.x+11,y:player.y-10,speed:12,dx:0.6});
    }
  }

  // Move bullets
  bullets=bullets.filter(b=>{b.y-=b.speed;if(b.dx)b.x+=b.dx;return b.y>-10&&b.x>-10&&b.x<W+10;});
  eBullets=eBullets.filter(b=>{b.x+=b.vx;b.y+=b.vy;return b.y<H+10&&b.x>-10&&b.x<W+10;});

  // Timers
  if(player.invincible>0) player.invincible--;
  if(player.shield>0) player.shield--;
  if(player.rapidFire>0) player.rapidFire--;

  // Formation oscillation
  const formX=Math.sin(tick*0.013)*24;
  const formY=Math.sin(tick*0.008)*7;

  // Enemy update
  enemies.forEach(e=>{
    e.animT+=0.05; e.t++;
    if(e.diving){
      const spd=e.type==='fast'?2.5:1.8;
      e.divePathIdx+=spd;
      if(e.divePathIdx>=e.divePath.length-1){
        e.diving=false; e.inFormation=true;
        e.x=e.hx+formX; e.y=e.hy+formY;
      } else {
        const idx=Math.floor(e.divePathIdx);
        const next=Math.min(idx+1,e.divePath.length-1);
        const frac=e.divePathIdx-idx;
        e.x=e.divePath[idx].x*(1-frac)+e.divePath[next].x*frac;
        e.y=e.divePath[idx].y*(1-frac)+e.divePath[next].y*frac;
        // Shoot during dive
        if(Math.random()<0.006&&e.type!=='tank'){
          const ang=Math.atan2(player.y-e.y,player.x-e.x);
          eBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*3.2,vy:Math.sin(ang)*3.2});
        }
      }
    } else if(!e.inFormation){
      if(e.t<e.enterT) return;
      const tx=e.hx+formX, ty=e.hy+formY;
      const dx=tx-e.x, dy=ty-e.y, d=Math.sqrt(dx*dx+dy*dy);
      const spd=3.5+wave*0.18;
      if(d<spd+2){ e.x=tx; e.y=ty; e.inFormation=true; }
      else { e.x+=dx/d*spd; e.y+=dy/d*spd; }
    } else {
      e.x=e.hx+formX; e.y=e.hy+formY;
      // Random dive attempt
      const diveChance=(0.00025+wave*0.0001)*(divers.length<3?1:0);
      if(Math.random()<diveChance&&e.y>0&&e.y<H-80){
        e.diving=true; e.inFormation=false;
        e.divePath=buildDivePath(e); e.divePathIdx=0;
        divers.push(e);
      }
      // Formation shooting
      e.shootTimer--;
      if(e.shootTimer<=0&&e.y>0){
        e.shootTimer=randInt(80,220-wave*8);
        const ang=Math.atan2(player.y-e.y,player.x-e.x);
        eBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*2.6,vy:Math.sin(ang)*2.6});
      }
    }
  });

  // Clean divers
  divers=divers.filter(d=>d.diving);

  // Bullet-enemy collisions
  for(let bi=bullets.length-1;bi>=0;bi--){
    const b=bullets[bi];
    for(let ei=enemies.length-1;ei>=0;ei--){
      const e=enemies[ei];
      if(Math.abs(b.x-e.x)<15&&Math.abs(b.y-e.y)<15){
        bullets.splice(bi,1);
        e.hp--;
        burst(e.x,e.y,e.type==='tank'?'#cc00ff':'#ff4444',8);
        if(e.hp<=0){
          const pts=e.type==='tank'?150:e.type==='fast'?75:50;
          score+=pts;
          burst(e.x,e.y,e.type==='tank'?'#cc00ff':e.type==='fast'?'#ff9900':'#ff4444',18);
          if(Math.random()<0.12){
            const t=['life','rapid','shield'][randInt(0,2)];
            powerups.push({x:e.x,y:e.y,type:t,vy:1.5,t:0});
          }
          enemies.splice(ei,1);
          shake(4,8);
        }
        break;
      }
    }
  }

  // Enemy bullet - player
  if(player.invincible<=0){
    for(let i=eBullets.length-1;i>=0;i--){
      const b=eBullets[i];
      if(Math.abs(b.x-player.x)<16&&Math.abs(b.y-player.y)<14){
        eBullets.splice(i,1);
        if(player.shield>0){ player.shield=0; shake(6,12); }
        else { hitPlayer(); }
      }
    }
    // Enemy body collision (diving enemies)
    enemies.forEach(e=>{
      if(e.diving&&Math.abs(e.x-player.x)<20&&Math.abs(e.y-player.y)<20){
        if(player.shield>0){ player.shield=0; shake(8,14); }
        else { hitPlayer(); }
      }
    });
  }

  // Powerups
  for(let i=powerups.length-1;i>=0;i--){
    const p=powerups[i]; p.y+=p.vy; p.t++;
    if(Math.abs(p.x-player.x)<22&&Math.abs(p.y-player.y)<22){
      if(p.type==='life') lives=Math.min(lives+1,5);
      else if(p.type==='rapid') player.rapidFire=300;
      else player.shield=400;
      burst(p.x,p.y,'#ffff00',12);
      powerups.splice(i,1);
    } else if(p.y>H+20) powerups.splice(i,1);
  }

  // Particles & trails
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=p.fade; if(p.life<=0)particles.splice(i,1);
  }
  for(let i=trails.length-1;i>=0;i--){
    const t=trails[i]; t.x+=t.vx; t.y+=t.vy; t.life-=0.045; if(t.life<=0)trails.splice(i,1);
  }

  // Shake decay
  if(shakeDur>0) shakeDur--;
  else { shakeX*=0.75; shakeY*=0.75; }

  // Next wave
  if(enemies.length===0){ wave++; spawnWave(); }
}

function hitPlayer(){
  lives--;
  burst(player.x,player.y,SKINS[chosenSkin].color,22);
  shake(10,20);
  player.invincible=160;
  if(lives<=0){
    hiScore=Math.max(score,hiScore);
    localStorage.setItem('ns2_hi',hiScore);
    state='gameover';
  }
}

// â”€â”€ RENDER GAME â”€â”€
function renderGame(){
  drawStarfield();
  ctx.save();
  if(shakeDur>0||Math.abs(shakeX)>0.1) ctx.translate(shakeX,shakeY);

  trails.forEach(t=>{
    ctx.globalAlpha=t.life*0.55;
    ctx.fillStyle=t.color; ctx.shadowBlur=6; ctx.shadowColor=t.color;
    ctx.beginPath(); ctx.arc(t.x,t.y,t.r,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1; ctx.shadowBlur=0;

  particles.forEach(p=>{
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color; ctx.shadowBlur=10; ctx.shadowColor=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1; ctx.shadowBlur=0;

  powerups.forEach(drawPowerup);
  eBullets.forEach(b=>drawBullet(b,true));
  bullets.forEach(b=>drawBullet(b,false));
  enemies.forEach(drawEnemy);

  // Player
  if(!player.dead){
    const show=player.invincible<=0||Math.floor(player.invincible/6)%2===0;
    if(show){
      if(player.shield>0){
        ctx.save(); ctx.globalAlpha=0.28+Math.sin(Date.now()*0.012)*0.12;
        ctx.strokeStyle='#00ccff'; ctx.lineWidth=3; ctx.shadowBlur=22; ctx.shadowColor='#00ccff';
        ctx.beginPath(); ctx.arc(player.x,player.y,30,0,Math.PI*2); ctx.stroke();
        ctx.globalAlpha=1; ctx.restore();
      }
      drawShip(player.x,player.y,chosenSkin,1,true);
    }
  }

  ctx.restore();
  drawHUD();
}

// â”€â”€ MAIN LOOP â”€â”€
resetGame();
function loop(){
  requestAnimationFrame(loop);
  update();
  if(state==='menu') drawMenu();
  else if(state==='customize') drawCustomize();
  else if(state==='playing') renderGame();
  else if(state==='gameover') drawGameOver();
}
loop();
</script>
</body>
</html>
