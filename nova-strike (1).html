<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOVA STRIKE ‚Äî Cova Games</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
    font-family: 'Exo 2', sans-serif;
  }
  canvas { display: block; image-rendering: pixelated; }

  /* Leaderboard overlay */
  #lbOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,20,0.92);
    z-index: 100;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  #lbOverlay.show { display: flex; }

  .lb-box {
    background: #050518;
    border: 2px solid #00e5ff;
    border-radius: 16px;
    padding: 2rem;
    width: 340px;
    box-shadow: 0 0 60px rgba(0,229,255,0.2);
  }

  .lb-title {
    font-family: 'Orbitron', monospace;
    font-size: 1.1rem;
    font-weight: 900;
    color: #00e5ff;
    text-align: center;
    letter-spacing: 0.2em;
    margin-bottom: 1.5rem;
    text-shadow: 0 0 20px rgba(0,229,255,0.6);
  }

  .lb-entry {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.4rem;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
  }

  .lb-entry.gold { background: rgba(255,214,0,0.08); border-color: rgba(255,214,0,0.3); }
  .lb-entry.silver { background: rgba(200,200,200,0.06); border-color: rgba(200,200,200,0.2); }
  .lb-entry.bronze { background: rgba(205,127,50,0.08); border-color: rgba(205,127,50,0.2); }
  .lb-entry.you { background: rgba(0,229,255,0.08); border-color: rgba(0,229,255,0.3); }

  .lb-rank {
    font-family: 'Orbitron', monospace;
    font-size: 0.75rem;
    font-weight: 700;
    color: #5a5a8a;
    min-width: 1.5rem;
    text-align: center;
  }
  .lb-entry.gold .lb-rank { color: #ffd700; }
  .lb-entry.silver .lb-rank { color: #c8c8c8; }
  .lb-entry.bronze .lb-rank { color: #cd7f32; }

  .lb-name {
    flex: 1;
    font-size: 0.82rem;
    font-weight: 600;
    color: #dde1f0;
  }
  .lb-entry.you .lb-name { color: #00e5ff; }

  .lb-score {
    font-family: 'Orbitron', monospace;
    font-size: 0.78rem;
    font-weight: 700;
    color: #ffe566;
  }

  .lb-wave {
    font-size: 0.65rem;
    color: #5a5a8a;
    text-align: right;
  }

  #nameInput {
    width: 100%;
    background: rgba(0,229,255,0.05);
    border: 1px solid rgba(0,229,255,0.3);
    border-radius: 8px;
    color: #fff;
    font-family: 'Orbitron', monospace;
    font-size: 0.85rem;
    padding: 0.6rem 1rem;
    margin-bottom: 0.75rem;
    outline: none;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  #nameInput::placeholder { color: #5a5a8a; }
  #nameInput:focus { border-color: #00e5ff; box-shadow: 0 0 12px rgba(0,229,255,0.2); }

  .lb-btn {
    width: 100%;
    padding: 0.65rem;
    background: #00e5ff;
    color: #000;
    border: none;
    border-radius: 8px;
    font-family: 'Orbitron', monospace;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
    margin-bottom: 0.5rem;
  }
  .lb-btn:hover { opacity: 0.85; transform: scale(1.02); }
  .lb-btn.secondary {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.15);
    color: #888;
    font-size: 0.7rem;
  }

  .lb-divider {
    height: 1px;
    background: rgba(255,255,255,0.08);
    margin: 1rem 0;
  }

  .lb-empty {
    text-align: center;
    color: #5a5a8a;
    font-size: 0.75rem;
    padding: 1rem;
  }
</style>
</head>
<body>
<canvas id="c"></canvas>

<!-- Leaderboard overlay -->
<div id="lbOverlay">
  <div class="lb-box">
    <div class="lb-title">üèÜ LEADERBOARD</div>
    <div id="lbSubmit">
      <div style="color:#aaa;font-size:0.78rem;margin-bottom:0.75rem;text-align:center">Enter your name to save your score</div>
      <input id="nameInput" maxlength="12" placeholder="YOUR NAME" autocomplete="off">
      <button class="lb-btn" onclick="submitScore()">SAVE SCORE</button>
    </div>
    <div class="lb-divider"></div>
    <div id="lbList"></div>
    <div class="lb-divider"></div>
    <button class="lb-btn secondary" onclick="closeLB()">PLAY AGAIN</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOVA STRIKE ‚Äî Space Shooter
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = canvas.width  = Math.min(window.innerWidth,  560);
const H = canvas.height = Math.min(window.innerHeight, 700);
const CX = W/2, CY = H/2;

// ‚îÄ‚îÄ LEADERBOARD (localStorage) ‚îÄ‚îÄ
function getLB() {
  try { return JSON.parse(localStorage.getItem('novaStrikeLB') || '[]'); } catch { return []; }
}
function saveLB(lb) {
  try { localStorage.setItem('novaStrikeLB', JSON.stringify(lb)); } catch {}
}

let pendingScore = 0, pendingWave = 0;

function openLB(score, wave) {
  pendingScore = score; pendingWave = wave;
  document.getElementById('lbSubmit').style.display = 'block';
  document.getElementById('nameInput').value = '';
  renderLBList();
  document.getElementById('lbOverlay').classList.add('show');
  setTimeout(() => document.getElementById('nameInput').focus(), 100);
}

function closeLB() {
  document.getElementById('lbOverlay').classList.remove('show');
  restartGame();
}

function submitScore() {
  const name = (document.getElementById('nameInput').value.trim() || 'PILOT').toUpperCase().slice(0,12);
  const lb = getLB();
  lb.push({ name, score: pendingScore, wave: pendingWave, date: Date.now() });
  lb.sort((a,b) => b.score - a.score);
  saveLB(lb.slice(0, 10));
  document.getElementById('lbSubmit').style.display = 'none';
  renderLBList(name);
}

function renderLBList(highlight) {
  const lb = getLB();
  const el = document.getElementById('lbList');
  if (!lb.length) { el.innerHTML = '<div class="lb-empty">No scores yet ‚Äî be the first!</div>'; return; }
  const medals = ['ü•á','ü•à','ü•â'];
  const cls = ['gold','silver','bronze'];
  el.innerHTML = lb.slice(0,8).map((e,i) => `
    <div class="lb-entry ${cls[i]||''} ${e.name===highlight?'you':''}">
      <div class="lb-rank">${medals[i]||('#'+(i+1))}</div>
      <div>
        <div class="lb-name">${e.name}${e.name===highlight?' ‚óÄ YOU':''}</div>
        <div class="lb-wave">Wave ${e.wave}</div>
      </div>
      <div class="lb-score">${e.score.toLocaleString()}</div>
    </div>
  `).join('');
}

document.getElementById('nameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitScore();
});

// ‚îÄ‚îÄ STARS ‚îÄ‚îÄ
const STARS = Array.from({length:180}, () => ({
  x: Math.random()*W, y: Math.random()*H,
  r: Math.random()*1.8+0.2,
  speed: Math.random()*0.6+0.1,
  bright: Math.random()*0.6+0.2
}));

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ
let state = 'title'; // title | playing | dead
let score, wave, lives, shakeX, shakeY, shakeTime;
let player, bullets, enemies, eBullets, particles, powerups;
let waveTimer, waveActive, waveCountdown;
let keys = {};
let invincible = 0;
let rapidFire = 0;
let shootCooldown = 0;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function initGame() {
  score = 0; wave = 0; lives = 3;
  shakeX = shakeY = shakeTime = 0;
  bullets = []; enemies = []; eBullets = [];
  particles = []; powerups = [];
  waveActive = false; waveCountdown = 0;
  invincible = 0; rapidFire = 0; shootCooldown = 0;

  player = {
    x: CX, y: H - 80,
    w: 24, h: 32,
    vx: 0, vy: 0,
    speed: 4.5,
    angle: 0,
    thrustParticleTimer: 0
  };

  startWave();
}

function restartGame() {
  state = 'playing';
  initGame();
}

// ‚îÄ‚îÄ WAVE SYSTEM ‚îÄ‚îÄ
function startWave() {
  wave++;
  waveActive = false;
  waveCountdown = 180; // 3 second countdown
}

function spawnWaveEnemies() {
  waveActive = true;
  const count = 4 + wave * 2;
  const cols = Math.min(count, 8);
  const rows = Math.ceil(count / cols);
  let spawned = 0;
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols && spawned < count; c++, spawned++) {
      const type = wave >= 3 && Math.random() < 0.3 ? 'tank' :
                   wave >= 2 && Math.random() < 0.2 ? 'fast' : 'normal';
      enemies.push({
        x: 60 + c * ((W-120)/Math.max(cols-1,1)),
        y: -80 - r * 55,
        w: type==='tank' ? 28 : 20,
        h: type==='tank' ? 28 : 20,
        vx: (Math.random()-0.5) * 1.2,
        vy: 0.8 + wave * 0.08,
        type,
        hp: type==='tank' ? 3 : 1,
        maxHp: type==='tank' ? 3 : 1,
        shootTimer: Math.random() * 120,
        shootRate: type==='fast' ? 60 : 100 - wave*3,
        zigzag: type==='fast' ? Math.random()*Math.PI*2 : 0,
        points: type==='tank' ? 150 : type==='fast' ? 75 : 50,
        flash: 0
      });
    }
  }
}

// ‚îÄ‚îÄ POWERUPS ‚îÄ‚îÄ
function maybeSpawnPowerup(x, y) {
  if (Math.random() < 0.12) {
    const types = ['life','rapid','shield'];
    powerups.push({
      x, y, vy: 1.2,
      type: types[Math.floor(Math.random()*types.length)],
      r: 14, pulse: Math.random()*Math.PI*2
    });
  }
}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
function burst(x, y, color, count=12, speed=4) {
  for (let i=0; i<count; i++) {
    const a = (Math.PI*2/count)*i + Math.random()*0.5;
    const s = speed * (0.5 + Math.random());
    particles.push({
      x, y,
      vx: Math.cos(a)*s, vy: Math.sin(a)*s,
      life: 1, decay: 0.02+Math.random()*0.03,
      r: 2+Math.random()*4,
      color
    });
  }
}

function thrustParticle(x, y) {
  particles.push({
    x: x + (Math.random()-0.5)*8,
    y,
    vx: (Math.random()-0.5)*1.5,
    vy: 1.5+Math.random()*2.5,
    life: 1, decay: 0.06+Math.random()*0.05,
    r: 2+Math.random()*4,
    color: Math.random()<0.5 ? '#ff6600' : '#ffcc00'
  });
}

// ‚îÄ‚îÄ SCREEN SHAKE ‚îÄ‚îÄ
function shake(amount) {
  shakeTime = 12;
  shakeX = (Math.random()-0.5)*amount*2;
  shakeY = (Math.random()-0.5)*amount*2;
}

// ‚îÄ‚îÄ DRAW HELPERS ‚îÄ‚îÄ
function drawPlayer() {
  const p = player;
  if (invincible > 0 && Math.floor(invincible/4)%2===0) return;

  ctx.save();
  ctx.translate(p.x, p.y);

  // Engine glow
  ctx.shadowBlur = 20;
  ctx.shadowColor = '#00aaff';

  // Ship body
  ctx.fillStyle = '#aad4ff';
  ctx.beginPath();
  ctx.moveTo(0, -p.h/2);       // nose
  ctx.lineTo(-p.w/2, p.h/2);   // left wing
  ctx.lineTo(-p.w/4, p.h/4);   // left indent
  ctx.lineTo(0, p.h/3);        // bottom center
  ctx.lineTo(p.w/4, p.h/4);    // right indent
  ctx.lineTo(p.w/2, p.h/2);    // right wing
  ctx.closePath();
  ctx.fill();

  // Cockpit
  ctx.fillStyle = '#00e5ff';
  ctx.shadowColor = '#00e5ff';
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.ellipse(0, -p.h/6, 5, 8, 0, 0, Math.PI*2);
  ctx.fill();

  // Shield ring if active
  if (invincible > 60) {
    ctx.strokeStyle = `rgba(0,229,255,${(invincible-60)/60})`;
    ctx.lineWidth = 2;
    ctx.shadowColor = '#00e5ff';
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.arc(0, 0, p.w, 0, Math.PI*2);
    ctx.stroke();
  }

  ctx.shadowBlur = 0;
  ctx.restore();
}

function drawEnemy(e) {
  ctx.save();
  ctx.translate(e.x, e.y);

  if (e.flash > 0) {
    ctx.globalAlpha = 0.5 + 0.5 * Math.sin(e.flash * 0.8);
  }

  const colors = { normal: '#ff4fa3', fast: '#ff8c00', tank: '#9b5de5' };
  const glow   = { normal: '#ff003c', fast: '#ff6600', tank: '#6600cc' };

  ctx.shadowBlur = 12;
  ctx.shadowColor = glow[e.type];

  if (e.type === 'tank') {
    // Hexagon
    ctx.fillStyle = colors[e.type];
    ctx.beginPath();
    for (let i=0; i<6; i++) {
      const a = (Math.PI/3)*i - Math.PI/6;
      i===0 ? ctx.moveTo(Math.cos(a)*e.w/2, Math.sin(a)*e.h/2)
             : ctx.lineTo(Math.cos(a)*e.w/2, Math.sin(a)*e.h/2);
    }
    ctx.closePath();
    ctx.fill();
    // HP bar
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(-e.w/2, e.h/2+3, e.w, 4);
    ctx.fillStyle = '#9b5de5';
    ctx.fillRect(-e.w/2, e.h/2+3, e.w*(e.hp/e.maxHp), 4);
  } else if (e.type === 'fast') {
    // Diamond
    ctx.fillStyle = colors[e.type];
    ctx.beginPath();
    ctx.moveTo(0, -e.h/2);
    ctx.lineTo(e.w/2, 0);
    ctx.lineTo(0, e.h/2);
    ctx.lineTo(-e.w/2, 0);
    ctx.closePath();
    ctx.fill();
  } else {
    // Inverted triangle
    ctx.fillStyle = colors[e.type];
    ctx.beginPath();
    ctx.moveTo(0, e.h/2);
    ctx.lineTo(-e.w/2, -e.h/2);
    ctx.lineTo(e.w/2, -e.h/2);
    ctx.closePath();
    ctx.fill();
  }

  ctx.shadowBlur = 0;
  ctx.restore();
}

function drawBullet(b, isEnemy) {
  ctx.save();
  ctx.shadowBlur = 10;
  ctx.shadowColor = isEnemy ? '#ff4444' : '#00e5ff';
  ctx.fillStyle = isEnemy ? '#ff6666' : '#00e5ff';
  ctx.beginPath();
  ctx.ellipse(b.x, b.y, isEnemy?3:2, isEnemy?5:8, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.restore();
}

function drawPowerup(p) {
  p.pulse += 0.06;
  const glow = 0.6 + 0.4*Math.sin(p.pulse);
  const colors = { life:'#ff4fa3', rapid:'#ffe566', shield:'#00e5ff' };
  const icons  = { life:'‚ô•', rapid:'‚ö°', shield:'üõ°' };

  ctx.save();
  ctx.translate(p.x, p.y);
  ctx.shadowBlur = 20 * glow;
  ctx.shadowColor = colors[p.type];
  ctx.strokeStyle = colors[p.type];
  ctx.lineWidth = 2;
  ctx.globalAlpha = glow;
  ctx.beginPath();
  ctx.arc(0, 0, p.r, 0, Math.PI*2);
  ctx.stroke();
  ctx.globalAlpha = 1;
  ctx.fillStyle = colors[p.type];
  ctx.font = `${p.r}px serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(icons[p.type], 0, 0);
  ctx.shadowBlur = 0;
  ctx.restore();
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
function drawHUD() {
  // Score
  ctx.fillStyle = 'rgba(0,0,0,0.4)';
  ctx.fillRect(8,8,160,36);
  ctx.fillStyle = '#ffe566';
  ctx.font = 'bold 11px Orbitron';
  ctx.fillText('SCORE', 18, 22);
  ctx.font = 'bold 16px Orbitron';
  ctx.fillText(score.toLocaleString(), 18, 38);

  // Wave
  ctx.fillStyle = 'rgba(0,0,0,0.4)';
  ctx.fillRect(W/2-50, 8, 100, 36);
  ctx.fillStyle = '#00e5ff';
  ctx.font = 'bold 11px Orbitron';
  ctx.textAlign = 'center';
  ctx.fillText('WAVE', W/2, 22);
  ctx.font = 'bold 16px Orbitron';
  ctx.fillText(wave, W/2, 38);
  ctx.textAlign = 'left';

  // Lives
  ctx.fillStyle = 'rgba(0,0,0,0.4)';
  ctx.fillRect(W-120, 8, 112, 36);
  ctx.fillStyle = '#ff4fa3';
  ctx.font = 'bold 11px Orbitron';
  ctx.textAlign = 'right';
  ctx.fillText('LIVES', W-18, 22);
  ctx.font = '16px serif';
  ctx.fillText('‚ô•'.repeat(Math.max(0,lives)), W-18, 38);
  ctx.textAlign = 'left';

  // Rapid fire indicator
  if (rapidFire > 0) {
    ctx.fillStyle = `rgba(255,229,102,${0.5+0.5*Math.sin(Date.now()*0.01)})`;
    ctx.font = 'bold 11px Orbitron';
    ctx.textAlign = 'center';
    ctx.fillText('‚ö° RAPID FIRE', W/2, H-12);
    ctx.textAlign = 'left';
  }
}

// ‚îÄ‚îÄ TITLE SCREEN ‚îÄ‚îÄ
function drawTitle() {
  // Starfield
  drawStars();

  ctx.fillStyle = 'rgba(0,0,0,0.4)';
  ctx.fillRect(0,0,W,H);

  // Title
  ctx.save();
  ctx.shadowBlur = 40;
  ctx.shadowColor = '#00e5ff';
  ctx.fillStyle = '#00e5ff';
  ctx.font = 'bold 48px Orbitron';
  ctx.textAlign = 'center';
  ctx.fillText('NOVA', CX, CY - 60);
  ctx.fillStyle = '#ffe566';
  ctx.shadowColor = '#ffe566';
  ctx.fillText('STRIKE', CX, CY - 8);
  ctx.shadowBlur = 0;
  ctx.restore();

  ctx.fillStyle = '#aaa';
  ctx.font = '13px Exo 2';
  ctx.textAlign = 'center';
  ctx.fillText('A COVA GAMES ORIGINAL', CX, CY + 22);

  ctx.fillStyle = '#dde1f0';
  ctx.font = '12px Exo 2';
  ctx.fillText('WASD / Arrow Keys to move', CX, CY + 60);
  ctx.fillText('SPACE to shoot', CX, CY + 80);

  // Blink
  if (Math.floor(Date.now()/600)%2===0) {
    ctx.fillStyle = '#00e5ff';
    ctx.font = 'bold 14px Orbitron';
    ctx.fillText('PRESS SPACE TO START', CX, CY + 120);
  }

  // Leaderboard teaser
  const lb = getLB();
  if (lb.length) {
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(CX-110, CY+140, 220, 26);
    ctx.fillStyle = '#ffe566';
    ctx.font = 'bold 11px Orbitron';
    ctx.fillText(`üèÜ BEST: ${lb[0].name} ‚Äî ${lb[0].score.toLocaleString()}`, CX, CY+157);
  }

  ctx.textAlign = 'left';
}

// ‚îÄ‚îÄ DRAW STARS ‚îÄ‚îÄ
function drawStars() {
  STARS.forEach(s => {
    s.y += s.speed;
    if (s.y > H) { s.y = 0; s.x = Math.random()*W; }
    ctx.globalAlpha = s.bright;
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;
}

// ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ
let frame = 0;
function loop() {
  requestAnimationFrame(loop);
  frame++;

  // ‚îÄ‚îÄ TITLE ‚îÄ‚îÄ
  if (state === 'title') {
    ctx.fillStyle = '#000010';
    ctx.fillRect(0,0,W,H);
    drawTitle();
    if (keys[' '] || keys['Enter']) { state='playing'; initGame(); }
    return;
  }

  // ‚îÄ‚îÄ PLAYING ‚îÄ‚îÄ
  if (state === 'playing') {

    // Player movement
    if (keys['ArrowLeft']||keys['a']||keys['A'])  player.vx -= 0.5;
    if (keys['ArrowRight']||keys['d']||keys['D']) player.vx += 0.5;
    if (keys['ArrowUp']||keys['w']||keys['W'])    player.vy -= 0.5;
    if (keys['ArrowDown']||keys['s']||keys['S'])  player.vy += 0.5;
    player.vx *= 0.82; player.vy *= 0.82;
    const spd = Math.sqrt(player.vx**2+player.vy**2);
    if (spd > player.speed) { player.vx=(player.vx/spd)*player.speed; player.vy=(player.vy/spd)*player.speed; }
    player.x = Math.max(player.w, Math.min(W-player.w, player.x+player.vx));
    player.y = Math.max(player.h, Math.min(H-player.h, player.y+player.vy));

    // Thrust particles
    if (spd > 1) {
      player.thrustParticleTimer++;
      if (player.thrustParticleTimer % 3 === 0) thrustParticle(player.x, player.y+player.h/2);
    }

    // Shooting
    shootCooldown--;
    const fireRate = rapidFire > 0 ? 8 : 18;
    if ((keys[' ']||keys['z']||keys['Z']) && shootCooldown <= 0) {
      bullets.push({ x:player.x, y:player.y-player.h/2, vy:-12 });
      if (rapidFire > 0) {
        bullets.push({ x:player.x-10, y:player.y-player.h/3, vy:-11 });
        bullets.push({ x:player.x+10, y:player.y-player.h/3, vy:-11 });
      }
      shootCooldown = fireRate;
    }

    // Timers
    if (invincible > 0) invincible--;
    if (rapidFire > 0) rapidFire--;

    // Wave countdown
    if (!waveActive) {
      waveCountdown--;
      if (waveCountdown <= 0) spawnWaveEnemies();
    }

    // Move bullets
    bullets.forEach(b => b.y += b.vy);
    bullets = bullets.filter(b => b.y > -20);

    // Enemy bullets
    eBullets.forEach(b => { b.x += b.vx; b.y += b.vy; });
    eBullets = eBullets.filter(b => b.y < H+20 && b.x > -10 && b.x < W+10);

    // Move enemies
    enemies.forEach(e => {
      if (e.type === 'fast') {
        e.zigzag += 0.05;
        e.vx = Math.sin(e.zigzag) * 2.5;
      }
      e.x += e.vx; e.y += e.vy;
      if (e.x < e.w/2 || e.x > W-e.w/2) e.vx *= -1;
      if (e.flash > 0) e.flash--;

      // Enemy shooting
      e.shootTimer--;
      if (e.shootTimer <= 0) {
        const ang = Math.atan2(player.y-e.y, player.x-e.x);
        const spd = e.type==='fast' ? 4 : 3;
        eBullets.push({ x:e.x, y:e.y, vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd });
        e.shootTimer = Math.max(30, (e.shootRate||80) - wave*2);
      }
    });

    // Check if wave cleared
    if (waveActive && enemies.length === 0) {
      waveActive = false;
      score += wave * 200; // wave clear bonus
      burst(CX, CY, '#ffe566', 20, 6);
      startWave();
    }

    // Remove enemies off-screen (bottom)
    enemies = enemies.filter(e => {
      if (e.y > H+40) {
        // Enemy reached bottom ‚Äî lose a life
        if (invincible === 0) { lives--; shake(6); invincible=120; }
        return false;
      }
      return true;
    });

    // Bullet ‚Üí enemy collision
    for (let i = bullets.length-1; i >= 0; i--) {
      for (let j = enemies.length-1; j >= 0; j--) {
        const b = bullets[i], e = enemies[j];
        if (!b||!e) continue;
        if (Math.abs(b.x-e.x)<e.w/2 && Math.abs(b.y-e.y)<e.h/2) {
          bullets.splice(i,1);
          e.hp--;
          e.flash = 8;
          if (e.hp <= 0) {
            score += e.points + wave * 10;
            burst(e.x, e.y, e.type==='tank'?'#9b5de5':e.type==='fast'?'#ff8c00':'#ff4fa3', 16, 5);
            maybeSpawnPowerup(e.x, e.y);
            enemies.splice(j,1);
          }
          break;
        }
      }
    }

    // Enemy bullet ‚Üí player collision
    if (invincible === 0) {
      for (let i = eBullets.length-1; i >= 0; i--) {
        const b = eBullets[i];
        if (Math.abs(b.x-player.x)<player.w/2 && Math.abs(b.y-player.y)<player.h/2) {
          eBullets.splice(i,1);
          lives--; shake(8); invincible=120;
          burst(player.x, player.y, '#00e5ff', 12, 4);
          if (lives <= 0) { state='dead'; burst(player.x,player.y,'#00e5ff',30,8); }
          break;
        }
      }
    }

    // Enemy ‚Üí player collision
    if (invincible === 0) {
      for (const e of enemies) {
        if (Math.abs(e.x-player.x)<(e.w+player.w)/2 && Math.abs(e.y-player.y)<(e.h+player.h)/2) {
          lives--; shake(10); invincible=150;
          burst(player.x,player.y,'#ffffff',16,6);
          if (lives<=0) { state='dead'; }
          break;
        }
      }
    }

    // Powerup collection
    powerups.forEach((p,i) => {
      p.y += p.vy;
      if (Math.abs(p.x-player.x)<p.r+player.w/2 && Math.abs(p.y-player.y)<p.r+player.h/2) {
        if (p.type==='life') { lives=Math.min(lives+1,5); burst(p.x,p.y,'#ff4fa3',12,4); }
        if (p.type==='rapid') { rapidFire=300; burst(p.x,p.y,'#ffe566',12,4); }
        if (p.type==='shield') { invincible=300; burst(p.x,p.y,'#00e5ff',12,4); }
        powerups.splice(i,1);
      }
    });
    powerups = powerups.filter(p => p.y < H+30);

    // Update particles
    particles.forEach(p => {
      p.x+=p.vx; p.y+=p.vy; p.vx*=0.93; p.vy*=0.93; p.life-=p.decay;
    });
    particles = particles.filter(p=>p.life>0);

    // Screen shake decay
    if (shakeTime > 0) {
      shakeTime--;
      shakeX *= 0.7; shakeY *= 0.7;
    } else { shakeX=shakeY=0; }

    if (state==='dead') { openLB(score, wave); return; }
  }

  // ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
  ctx.save();
  if (shakeTime>0) ctx.translate(shakeX, shakeY);

  // Background
  ctx.fillStyle = '#000010';
  ctx.fillRect(0,0,W,H);
  drawStars();

  // Particles (behind everything)
  particles.forEach(p => {
    ctx.globalAlpha = p.life * 0.85;
    ctx.fillStyle = p.color;
    ctx.shadowBlur = 8; ctx.shadowColor = p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1; ctx.shadowBlur=0;

  // Powerups
  powerups.forEach(drawPowerup);

  // Enemy bullets
  eBullets.forEach(b => drawBullet(b, true));

  // Player bullets
  bullets.forEach(b => drawBullet(b, false));

  // Enemies
  enemies.forEach(drawEnemy);

  // Player
  if (state==='playing') drawPlayer();

  // HUD
  drawHUD();

  // Wave announcement
  if (!waveActive && waveCountdown > 120) {
    const alpha = Math.min(1, (waveCountdown-120)/30);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = '#00e5ff';
    ctx.font = 'bold 32px Orbitron';
    ctx.textAlign = 'center';
    ctx.shadowBlur = 30; ctx.shadowColor = '#00e5ff';
    ctx.fillText(`WAVE ${wave}`, CX, CY);
    ctx.font = '14px Exo 2';
    ctx.fillStyle = '#aaa';
    ctx.shadowBlur = 0;
    ctx.fillText(wave===1?'GOOD LUCK PILOT':'INCOMING!', CX, CY+28);
    ctx.globalAlpha=1; ctx.textAlign='left';
  }

  ctx.restore();
}

// ‚îÄ‚îÄ KEYS ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  keys[e.key] = true;
  if (e.key===' ') e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.key] = false; });

loop();
</script>
</body>
</html>
