<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P1VFNJ21V0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-P1VFNJ21V0');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9556113318001178"
     crossorigin="anonymous"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Desert Chase</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #1a0f00;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
    font-family: 'Courier New', monospace;
    touch-action: none;
  }
  canvas { display: block; cursor: none; touch-action: none; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');

let W = Math.min(window.innerWidth,  700);
let H = Math.min(window.innerHeight, 700);
canvas.width  = W;
canvas.height = H;

const isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function darken(hex, amt) {
  const r = Math.max(0, Math.floor(parseInt(hex.slice(1,3),16)*(1-amt)));
  const g = Math.max(0, Math.floor(parseInt(hex.slice(3,5),16)*(1-amt)));
  const b = Math.max(0, Math.floor(parseInt(hex.slice(5,7),16)*(1-amt)));
  return `rgb(${r},${g},${b})`;
}
function lighten(hex, amt) {
  const r = Math.min(255, Math.floor(parseInt(hex.slice(1,3),16)+(255-parseInt(hex.slice(1,3),16))*amt));
  const g = Math.min(255, Math.floor(parseInt(hex.slice(3,5),16)+(255-parseInt(hex.slice(3,5),16))*amt));
  const b = Math.min(255, Math.floor(parseInt(hex.slice(5,7),16)+(255-parseInt(hex.slice(5,7),16))*amt));
  return `rgb(${r},${g},${b})`;
}

// â”€â”€ LEVELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LEVELS = [
  { name:'ROOKIE',   goal:20, spawnRate:120, copSpeedMult:0.8, maxCops:4,  copLifetime:1200, description:'Survive 20s' },
  { name:'WANTED',   goal:35, spawnRate:90,  copSpeedMult:1.0, maxCops:6,  copLifetime:1000, description:'Survive 35s' },
  { name:'FUGITIVE', goal:50, spawnRate:70,  copSpeedMult:1.2, maxCops:8,  copLifetime:900,  description:'Survive 50s' },
  { name:'OUTLAW',   goal:75, spawnRate:50,  copSpeedMult:1.5, maxCops:10, copLifetime:750,  description:'Survive 75s' },
];

// â”€â”€ CAR COLORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CAR_COLORS = ['#cc2200','#ff8800','#ddcc00','#00aa44','#0055cc','#8800cc','#eeeeee','#222222'];

// â”€â”€ CAR DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// All draw(ctx, color) called with ctx already translated to car center
// Front of car = negative-y  (car points "up")
const CARS = [
  {
    id:'sedan', name:'SEDAN', unlockLevel:-1, w:18, h:30,
    desc:'The reliable classic.',
    draw(ctx, color) {
      // body
      ctx.fillStyle = color;
      ctx.fillRect(-9,-15,18,30);
      // roof
      ctx.fillStyle = darken(color, 0.18);
      ctx.fillRect(-7,-7,14,15);
      // windshield
      ctx.fillStyle = 'rgba(150,220,255,0.8)';
      ctx.fillRect(-6,-6,12,6);
      // rear window
      ctx.fillRect(-5,4,10,5);
      // headlights
      ctx.fillStyle = '#ffffaa';
      ctx.fillRect(-8,-14,4,3); ctx.fillRect(4,-14,4,3);
      // taillights
      ctx.fillStyle = '#ff2200';
      ctx.fillRect(-8,11,4,3); ctx.fillRect(4,11,4,3);
      // wheels
      ctx.fillStyle = '#111';
      ctx.fillRect(-12,-11,5,7); ctx.fillRect(7,-11,5,7);
      ctx.fillRect(-12, 5,5,7); ctx.fillRect(7,  5,5,7);
      ctx.fillStyle = '#444';
      ctx.fillRect(-11,-10,3,5); ctx.fillRect(8,-10,3,5);
      ctx.fillRect(-11,  6,3,5); ctx.fillRect(8,  6,3,5);
    }
  },
  {
    id:'muscle', name:'MUSCLE', unlockLevel:0, w:24, h:32,
    desc:'Wide body. Brute power.\nBeat Level 1 to unlock.',
    draw(ctx, color) {
      // flared body
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(-12,16); ctx.lineTo(-10,-16);
      ctx.lineTo(10,-16); ctx.lineTo(12,16);
      ctx.closePath(); ctx.fill();
      // hood scoop
      ctx.fillStyle = darken(color, 0.35);
      ctx.fillRect(-4,-16,8,7);
      ctx.fillStyle = '#111';
      ctx.fillRect(-3,-15,6,5);
      // roof
      ctx.fillStyle = darken(color, 0.2);
      ctx.fillRect(-8,-6,16,14);
      // windshield
      ctx.fillStyle = 'rgba(150,220,255,0.8)';
      ctx.fillRect(-7,-5,14,6);
      // rear window
      ctx.fillRect(-6,4,12,4);
      // wide headlights
      ctx.fillStyle = '#ffffaa';
      ctx.fillRect(-10,-15,6,3); ctx.fillRect(4,-15,6,3);
      // taillights (full width)
      ctx.fillStyle = '#ff2200';
      ctx.fillRect(-11,12,22,3);
      // fat wheels
      ctx.fillStyle = '#111';
      ctx.fillRect(-14,-12,6,9); ctx.fillRect(8,-12,6,9);
      ctx.fillRect(-14, 4,6,9); ctx.fillRect(8,  4,6,9);
      ctx.fillStyle = '#444';
      ctx.fillRect(-13,-11,4,7); ctx.fillRect(9,-11,4,7);
      ctx.fillRect(-13,  5,4,7); ctx.fillRect(9,  5,4,7);
    }
  },
  {
    id:'sports', name:'SPORTS', unlockLevel:1, w:18, h:26,
    desc:'Low and fast. Built to win.\nBeat Level 2 to unlock.',
    draw(ctx, color) {
      // wedge body
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(-9,13); ctx.lineTo(-9, 0);
      ctx.lineTo(-7,-13); ctx.lineTo(7,-13);
      ctx.lineTo(9,0);  ctx.lineTo(9,13);
      ctx.closePath(); ctx.fill();
      // pointed nose
      ctx.beginPath();
      ctx.moveTo(-5,-13); ctx.lineTo(5,-13);
      ctx.lineTo(3,-16); ctx.lineTo(-3,-16);
      ctx.closePath(); ctx.fill();
      // spoiler
      ctx.fillStyle = darken(color, 0.25);
      ctx.fillRect(-10,11,20,3);
      ctx.fillRect(-11,10,3,5); ctx.fillRect(8,10,3,5);
      // low cockpit
      ctx.fillStyle = darken(color, 0.22);
      ctx.fillRect(-7,-1,14,10);
      // windshield (raked)
      ctx.fillStyle = 'rgba(150,220,255,0.8)';
      ctx.fillRect(-6, 0,12,5);
      // thin LED headlights
      ctx.fillStyle = '#ffffcc';
      ctx.fillRect(-8,-12,6,2); ctx.fillRect(2,-12,6,2);
      // taillights strip
      ctx.fillStyle = '#ff2200';
      ctx.fillRect(-9,12,18,2);
      // wheels
      ctx.fillStyle = '#111';
      ctx.fillRect(-12,-10,5,7); ctx.fillRect(7,-10,5,7);
      ctx.fillRect(-12,  3,5,7); ctx.fillRect(7,  3,5,7);
      ctx.fillStyle = '#555';
      ctx.fillRect(-11,-9,3,5); ctx.fillRect(8,-9,3,5);
      ctx.fillRect(-11, 4,3,5); ctx.fillRect(8, 4,3,5);
    }
  },
  {
    id:'pickup', name:'PICKUP', unlockLevel:1, w:20, h:38,
    desc:'Cab and bed. Built tough.\nBeat Level 2 to unlock.',
    draw(ctx, color) {
      // bed (rear, darker)
      ctx.fillStyle = darken(color, 0.28);
      ctx.fillRect(-9, 5,18,14);
      // bed floor
      ctx.fillStyle = darken(color, 0.45);
      ctx.fillRect(-8, 7,16,10);
      // cab
      ctx.fillStyle = color;
      ctx.fillRect(-9,-19,18,26);
      // roof
      ctx.fillStyle = darken(color, 0.18);
      ctx.fillRect(-8,-17,16,13);
      // windshield
      ctx.fillStyle = 'rgba(150,220,255,0.8)';
      ctx.fillRect(-7,-16,14,8);
      // rear cab window
      ctx.fillRect(-6,-3,12,4);
      // bed walls (side lines)
      ctx.fillStyle = darken(color, 0.4);
      ctx.fillRect(-9, 5,1,14); ctx.fillRect(8, 5,1,14);
      // headlights
      ctx.fillStyle = '#ffffaa';
      ctx.fillRect(-8,-18,4,3); ctx.fillRect(4,-18,4,3);
      // taillights
      ctx.fillStyle = '#ff4400';
      ctx.fillRect(-8,17,4,2); ctx.fillRect(4,17,4,2);
      // wheels (bigger)
      ctx.fillStyle = '#111';
      ctx.fillRect(-13,-14,6,9); ctx.fillRect(7,-14,6,9);
      ctx.fillRect(-13,  6,6,9); ctx.fillRect(7,  6,6,9);
      ctx.fillStyle = '#444';
      ctx.fillRect(-12,-13,4,7); ctx.fillRect(8,-13,4,7);
      ctx.fillRect(-12,  7,4,7); ctx.fillRect(8,  7,4,7);
    }
  },
  {
    id:'van', name:'VAN', unlockLevel:2, w:24, h:34,
    desc:'Tall. Boxy. Unstoppable.\nBeat Level 3 to unlock.',
    draw(ctx, color) {
      // boxy main body
      ctx.fillStyle = color;
      ctx.fillRect(-11,-17,22,34);
      // flat cab face
      ctx.fillStyle = darken(color, 0.12);
      ctx.fillRect(-10,-17,20,7);
      // big windshield
      ctx.fillStyle = 'rgba(150,220,255,0.8)';
      ctx.fillRect(-9,-16,18,6);
      // side windows
      ctx.fillRect(-9,-5,8,8); ctx.fillRect(1,-5,8,8);
      // rear window
      ctx.fillRect(-8,9,16,5);
      // sliding door divider
      ctx.fillStyle = darken(color, 0.3);
      ctx.fillRect(0,-10,1,16);
      // headlights
      ctx.fillStyle = '#ffffaa';
      ctx.fillRect(-10,-16,5,3); ctx.fillRect(5,-16,5,3);
      // taillights
      ctx.fillStyle = '#ff2200';
      ctx.fillRect(-10,14,5,3); ctx.fillRect(5,14,5,3);
      // roof rack line
      ctx.fillStyle = darken(color, 0.35);
      ctx.fillRect(-10,-17,20,2);
      // wheels
      ctx.fillStyle = '#111';
      ctx.fillRect(-13,-12,5,8); ctx.fillRect(8,-12,5,8);
      ctx.fillRect(-13,  5,5,8); ctx.fillRect(8,  5,5,8);
      ctx.fillStyle = '#444';
      ctx.fillRect(-12,-11,3,6); ctx.fillRect(9,-11,3,6);
      ctx.fillRect(-12,  6,3,6); ctx.fillRect(9,  6,3,6);
    }
  },
  {
    id:'racecar', name:'RACE CAR', unlockLevel:2, w:30, h:26,
    desc:'Formula machine. Pure speed.\nBeat Level 3 to unlock.',
    draw(ctx, color) {
      // nose cone
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(-4,-13); ctx.lineTo(4,-13);
      ctx.lineTo(5,-8); ctx.lineTo(-5,-8);
      ctx.closePath(); ctx.fill();
      // body pod
      ctx.fillRect(-7,-8,14,18);
      // rear pod
      ctx.fillRect(-5,10,10,3);
      // front wing (wide)
      ctx.fillStyle = darken(color, 0.22);
      ctx.fillRect(-14,-10,28,3);
      ctx.fillRect(-15,-11,4,5); ctx.fillRect(11,-11,4,5);
      // rear wing
      ctx.fillRect(-13, 9,26,3);
      ctx.fillRect(-13, 8,4,6); ctx.fillRect(9,  8,4,6);
      // cockpit opening
      ctx.fillStyle = darken(color, 0.5);
      ctx.beginPath(); ctx.ellipse(0,-1,5,7,0,0,Math.PI*2); ctx.fill();
      // visor
      ctx.fillStyle = 'rgba(100,200,255,0.9)';
      ctx.beginPath(); ctx.ellipse(0,-2,4,4,0,0,Math.PI*2); ctx.fill();
      // headlight dots
      ctx.fillStyle = '#ffffcc';
      ctx.fillRect(-4,-12,2,2); ctx.fillRect(2,-12,2,2);
      // F1 wide wheels
      ctx.fillStyle = '#111';
      ctx.fillRect(-16,-9,7,8); ctx.fillRect(9,-9,7,8);
      ctx.fillRect(-16, 4,7,8); ctx.fillRect(9, 4,7,8);
      ctx.fillStyle = '#444';
      ctx.fillRect(-15,-8,5,6); ctx.fillRect(10,-8,5,6);
      ctx.fillRect(-15, 5,5,6); ctx.fillRect(10, 5,5,6);
    }
  },
  {
    id:'hotrod', name:'HOT ROD', unlockLevel:3, w:16, h:42,
    desc:'Long hood. Chrome pipes. Legend.\nBeat Level 4 to unlock.',
    draw(ctx, color) {
      // very long hood
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(-8,20); ctx.lineTo(-8,-5);
      ctx.lineTo(-6,-21); ctx.lineTo(6,-21);
      ctx.lineTo(8,-5); ctx.lineTo(8,20);
      ctx.closePath(); ctx.fill();
      // engine block on top of hood
      ctx.fillStyle = '#888';
      ctx.fillRect(-5,-20,10,5);
      ctx.fillStyle = '#666';
      ctx.fillRect(-4,-19,8,3);
      // intake scoops
      ctx.fillStyle = '#555';
      ctx.fillRect(-3,-19,2,4); ctx.fillRect(1,-19,2,4);
      // chopped tiny roof
      ctx.fillStyle = darken(color, 0.25);
      ctx.fillRect(-6, 3,12,11);
      // windshield (low raked)
      ctx.fillStyle = 'rgba(150,220,255,0.8)';
      ctx.beginPath();
      ctx.moveTo(-5,3); ctx.lineTo(5,3);
      ctx.lineTo(4,9); ctx.lineTo(-4,9);
      ctx.closePath(); ctx.fill();
      // exhaust pipes (both sides, long)
      ctx.fillStyle = '#777';
      ctx.fillRect(-11,-8,4,18);
      ctx.fillRect( 7,-8,4,18);
      ctx.fillStyle = '#555';
      ctx.fillRect(-10,-7,2,16); ctx.fillRect(8,-7,2,16);
      // round headlights
      ctx.fillStyle = '#ffffaa';
      ctx.beginPath(); ctx.arc(-4,-19,3,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc( 4,-19,3,0,Math.PI*2); ctx.fill();
      // taillights
      ctx.fillStyle = '#ff2200';
      ctx.fillRect(-7,18,4,3); ctx.fillRect(3,18,4,3);
      // vintage narrow wheels with whitewall
      ctx.fillStyle = '#111';
      ctx.fillRect(-11,-15,5,8); ctx.fillRect(6,-15,5,8);
      ctx.fillRect(-11, 9,5,8); ctx.fillRect(6,  9,5,8);
      ctx.fillStyle = '#ddd';
      ctx.fillRect(-10,-14,3,6); ctx.fillRect(7,-14,3,6);
      ctx.fillRect(-10, 10,3,6); ctx.fillRect(7, 10,3,6);
    }
  },
  {
    id:'jeep', name:'JEEP', unlockLevel:3, w:24, h:28,
    desc:'Square, rugged, off-road king.\nBeat Level 4 to unlock.',
    draw(ctx, color) {
      // square boxy body
      ctx.fillStyle = color;
      ctx.fillRect(-10,-14,20,28);
      // flat hood
      ctx.fillStyle = darken(color, 0.12);
      ctx.fillRect(-9,-14,18,6);
      // roll cage verticals
      ctx.strokeStyle = darken(color, 0.4);
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(-9,-8); ctx.lineTo(-9,10); ctx.stroke();
      ctx.beginPath(); ctx.moveTo( 9,-8); ctx.lineTo( 9,10); ctx.stroke();
      // roll cage horizontals
      ctx.beginPath(); ctx.moveTo(-9,-8); ctx.lineTo(9,-8); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(-9,10); ctx.lineTo(9,10); ctx.stroke();
      // X brace
      ctx.beginPath(); ctx.moveTo(-9,-8); ctx.lineTo(9,10); ctx.stroke();
      ctx.beginPath(); ctx.moveTo( 9,-8); ctx.lineTo(-9,10); ctx.stroke();
      // windshield (upright)
      ctx.fillStyle = 'rgba(150,220,255,0.8)';
      ctx.fillRect(-8,-7,16,6);
      // open side panels (dark)
      ctx.fillStyle = 'rgba(0,0,0,0.35)';
      ctx.fillRect(-9,-1,3,8); ctx.fillRect(6,-1,3,8);
      // prominent round headlights
      ctx.fillStyle = '#ffffaa';
      ctx.beginPath(); ctx.arc(-5,-12,3,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc( 5,-12,3,0,Math.PI*2); ctx.fill();
      // front brush guard
      ctx.strokeStyle = '#666'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(-9,-14); ctx.lineTo(0,-17); ctx.lineTo(9,-14); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(-5,-14); ctx.lineTo(0,-16); ctx.lineTo(5,-14); ctx.stroke();
      // taillights
      ctx.fillStyle = '#ff2200';
      ctx.fillRect(-9,12,4,3); ctx.fillRect(5,12,4,3);
      // big knobby tires
      ctx.fillStyle = '#111';
      ctx.fillRect(-14,-12,6,9); ctx.fillRect(8,-12,6,9);
      ctx.fillRect(-14,  4,6,9); ctx.fillRect(8,  4,6,9);
      // tread marks
      ctx.fillStyle = '#333';
      for (let y = -11; y < -4; y += 2) {
        ctx.fillRect(-13,y,4,1); ctx.fillRect(9,y,4,1);
      }
      for (let y = 5; y < 12; y += 2) {
        ctx.fillRect(-13,y,4,1); ctx.fillRect(9,y,4,1);
      }
    }
  },
];

// â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state          = 'home'; // home|garage|playing|dead|win
let currentLevel   = 0;
let score          = 0;
let highScores     = [0,0,0,0];
let levelsBeaten   = [false,false,false,false];
let frame          = 0;
let newUnlockNames = [];

let selectedCarIdx = 0;
let playerColor    = '#cc2200';
let garageIdx      = 0;

// home screen keyboard focus: 0-3=levels, 4=garage
let homeKeyFocus = 0;
// garage key focus: 'car' or 'color'
let garageKeyFocus = 'car';
let garageColorIdx = 0;

let dustParticles=[], explosions=[], cops=[], powerups=[];
let copTimer=0, powerupTimer=0;
let activeEffects = { shield:0, speed:0, freeze:0, ghost:0 };
let shieldHit = false;
let homePulse = 0;

// â”€â”€ PLAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const player = { x:W/2, y:H/2, vx:0, vy:0, angle:0, w:18, h:30 };

// â”€â”€ MOUSE/TOUCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mouse    = { x:W/2, y:H/2 };
let joystick = { active:false, ox:0, oy:0, x:0, y:0, id:null };

canvas.addEventListener('mousemove', e => {
  const r = canvas.getBoundingClientRect();
  mouse.x = e.clientX - r.left;
  mouse.y = e.clientY - r.top;
});

canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  const r  = canvas.getBoundingClientRect();
  const t  = e.changedTouches[0];
  const tx = t.clientX - r.left;
  const ty = t.clientY - r.top;
  if (state === 'playing') {
    joystick.active = true;
    joystick.id     = t.identifier;
    joystick.ox     = tx;
    joystick.oy     = ty;
    joystick.x      = tx;
    joystick.y      = ty;
  } else {
    mouse.x = tx;
    mouse.y = ty;
  }
}, { passive:false });

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  const r = canvas.getBoundingClientRect();
  for (const t of e.changedTouches) {
    const tx = t.clientX - r.left;
    const ty = t.clientY - r.top;
    if (state === 'playing' && t.identifier === joystick.id) {
      joystick.x = tx;
      joystick.y = ty;
    } else if (state !== 'playing') {
      mouse.x = tx;
      mouse.y = ty;
    }
  }
}, { passive:false });

canvas.addEventListener('touchend', e => {
  e.preventDefault();
  const r = canvas.getBoundingClientRect();
  for (const t of e.changedTouches) {
    if (state === 'playing' && t.identifier === joystick.id) {
      joystick.active = false;
    } else if (state !== 'playing') {
      const tx = t.clientX - r.left;
      const ty = t.clientY - r.top;
      mouse.x = tx;
      mouse.y = ty;
      handleClick(tx, ty);
    }
  }
}, { passive:false });

canvas.addEventListener('click', e => {
  e.preventDefault();
  handleClick(mouse.x, mouse.y);
});
canvas.addEventListener('contextmenu', e => {
  e.preventDefault();
  if (state==='dead'||state==='win') state='home';
});

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  const key = e.key;

  if (state === 'home') {
    if (key==='ArrowDown'||key==='s'||key==='S')  homeKeyFocus = Math.min(4, homeKeyFocus+1);
    if (key==='ArrowUp'  ||key==='w'||key==='W')  homeKeyFocus = Math.max(0, homeKeyFocus-1);
    if (key==='Enter'||key===' ') {
      if (homeKeyFocus < 4) { currentLevel=homeKeyFocus; startGame(); }
      else { state='garage'; garageIdx=selectedCarIdx; garageKeyFocus='car'; }
    }
  }
  else if (state === 'garage') {
    if (key==='ArrowLeft' ||key==='a'||key==='A') garageIdx=(garageIdx-1+CARS.length)%CARS.length;
    if (key==='ArrowRight'||key==='d'||key==='D') garageIdx=(garageIdx+1)%CARS.length;
    if (key==='ArrowUp'   ||key==='w'||key==='W') { garageKeyFocus='car'; }
    if (key==='ArrowDown' ||key==='s'||key==='S') { garageKeyFocus='color'; }
    if (garageKeyFocus==='color') {
      if (key==='ArrowLeft' ||key==='a'||key==='A') garageColorIdx=(garageColorIdx-1+CAR_COLORS.length)%CAR_COLORS.length;
      if (key==='ArrowRight'||key==='d'||key==='D') { garageColorIdx=(garageColorIdx+1)%CAR_COLORS.length; playerColor=CAR_COLORS[garageColorIdx]; }
    }
    if (key==='Enter'||key===' ') {
      if (isUnlocked(garageIdx)) { selectedCarIdx=garageIdx; playerColor=CAR_COLORS[garageColorIdx]; state='home'; }
    }
    if (key==='Escape'||key==='Backspace') state='home';
  }
  else if (state==='dead') {
    if (key==='Enter'||key===' '||key==='r'||key==='R') restart(currentLevel);
    if (key==='Escape') state='home';
  }
  else if (state==='win') {
    if (key==='Enter'||key===' ') {
      const n=currentLevel+1;
      if (n<LEVELS.length) { currentLevel=n; startGame(); }
      else state='home';
    }
    if (key==='Escape') state='home';
  }
});

// â”€â”€ UNLOCK CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isUnlocked(idx) {
  return CARS[idx].unlockLevel === -1 || levelsBeaten[CARS[idx].unlockLevel];
}

// â”€â”€ CLICK HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleClick(cx, cy) {
  if (state==='home') {
    // level buttons
    for (let i=0;i<LEVELS.length;i++) {
      const {bx,by,bw,bh} = levelBtnRect(i);
      if (cx>=bx&&cx<=bx+bw&&cy>=by&&cy<=by+bh) { currentLevel=i; startGame(); return; }
    }
    // garage button
    const g = garageBtnRect();
    if (cx>=g.bx&&cx<=g.bx+g.bw&&cy>=g.by&&cy<=g.by+g.bh) {
      state='garage'; garageIdx=selectedCarIdx; garageKeyFocus='car';
      garageColorIdx=CAR_COLORS.indexOf(playerColor); if(garageColorIdx<0) garageColorIdx=0;
    }
  }
  else if (state==='garage') {
    // left arrow
    if (cx < W/2-80) { garageIdx=(garageIdx-1+CARS.length)%CARS.length; return; }
    // right arrow
    if (cx > W/2+80) { garageIdx=(garageIdx+1)%CARS.length; return; }
    // color swatches
    const cy0 = garageColorY();
    CAR_COLORS.forEach((c,i)=>{
      const sx = W/2 - (CAR_COLORS.length*34)/2 + i*34 + 3;
      if (cx>=sx&&cx<=sx+28&&cy>=cy0&&cy<=cy0+28) {
        playerColor=c; garageColorIdx=i;
      }
    });
    // select button
    const s = garageSelectRect();
    if (cx>=s.bx&&cx<=s.bx+s.bw&&cy>=s.by&&cy<=s.by+s.bh) {
      if (isUnlocked(garageIdx)) { selectedCarIdx=garageIdx; state='home'; }
    }
    // back button
    const b = garageBackRect();
    if (cx>=b.bx&&cx<=b.bx+b.bw&&cy>=b.by&&cy<=b.by+b.bh) { state='home'; }
  }
  else if (state==='dead') { restart(currentLevel); }
  else if (state==='win') {
    const n=currentLevel+1;
    if (n<LEVELS.length) { currentLevel=n; startGame(); }
    else state='home';
  }
}

// â”€â”€ BUTTON LAYOUT HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function levelBtnRect(i) {
  const bw=280, bh=52, bx=W/2-bw/2, by=190+i*62;
  return {bx,by,bw,bh};
}
function garageBtnRect() {
  const bw=200, bh=52, bx=W/2-100, by=190+4*62;
  return {bx,by,bw,bh};
}
function garageColorY() { return H-120; }
function garageSelectRect() {
  return { bx:W/2-70, by:H-70, bw:140, bh:44 };
}
function garageBackRect() {
  return { bx:16, by:H-70, bw:110, bh:44 };
}

// â”€â”€ SCENERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ROCKS=[], CACTI=[], TRACKS=[];
function genScenery() {
  ROCKS  = Array.from({length:35},()=>({x:Math.random()*W,y:Math.random()*H,r:3+Math.random()*9,shade:Math.random()}));
  CACTI  = Array.from({length:15},()=>({x:Math.random()*W,y:Math.random()*H,h:14+Math.random()*20}));
  TRACKS = Array.from({length:6}, ()=>({x:Math.random()*W,y:Math.random()*H,angle:Math.random()*Math.PI*2,len:40+Math.random()*90}));
}
genScenery();

// â”€â”€ POWERUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const POWERUP_TYPES = [
  {type:'shield',color:'#00cfff',glow:'#00cfff',label:'SHIELD',duration:600},
  {type:'speed', color:'#ffdd00',glow:'#ffaa00',label:'BOOST', duration:300},
  {type:'freeze',color:'#aaffff',glow:'#00ffee',label:'FREEZE',duration:360},
  {type:'ghost', color:'#dd88ff',glow:'#aa44ff',label:'GHOST', duration:240},
];

function spawnPowerup() {
  const t = POWERUP_TYPES[Math.floor(Math.random()*POWERUP_TYPES.length)];
  const m = 70;
  powerups.push({...t, x:m+Math.random()*(W-m*2), y:m+Math.random()*(H-m*2), pulse:Math.random()*Math.PI*2, life:600});
}

// â”€â”€ COPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnCop() {
  const lvl = LEVELS[currentLevel];
  if (cops.length >= lvl.maxCops) return;
  const side = Math.floor(Math.random()*4);
  let x, y;
  if      (side===0){x=Math.random()*W;y=-40;}
  else if (side===1){x=W+40;y=Math.random()*H;}
  else if (side===2){x=Math.random()*W;y=H+40;}
  else              {x=-40;y=Math.random()*H;}
  cops.push({x,y,vx:0,vy:0,angle:0,w:18,h:30,
    speed:(1.8+Math.min(score*0.006,1.5))*lvl.copSpeedMult,
    lt:0, age:0, lifetime:lvl.copLifetime});
}

// â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnDust(x,y,color) {
  for (let i=0;i<4;i++) {
    const a=Math.random()*Math.PI*2, s=0.5+Math.random()*2;
    dustParticles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:0.035+Math.random()*0.025,r:2+Math.random()*4,color:color||'#c4a257'});
  }
}
function spawnExplosion(x,y) {
  for (let i=0;i<45;i++) {
    const a=Math.random()*Math.PI*2, s=1+Math.random()*7;
    explosions.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:0.012+Math.random()*0.018,r:4+Math.random()*12,
      color:['#ff6600','#ff3300','#ffcc00','#ff9900','#fff'][Math.floor(Math.random()*5)]});
  }
}

// â”€â”€ COLLISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh) {
  return ax-aw/2<bx+bw/2&&ax+aw/2>bx-bw/2&&ay-ah/2<by+bh/2&&ay+ah/2>by-bh/2;
}
function separateCops(a,b) {
  const dx=b.x-a.x,dy=b.y-a.y,dist=Math.sqrt(dx*dx+dy*dy)||0.001;
  const minD=(a.w+b.w)/2;
  if (dist>=minD) return;
  const ov=(minD-dist)/2,nx=dx/dist,ny=dy/dist;
  a.x-=nx*ov; a.y-=ny*ov; b.x+=nx*ov; b.y+=ny*ov;
  const dot=(b.vx-a.vx)*nx+(b.vy-a.vy)*ny;
  if (dot<0){a.vx+=dot*nx;a.vy+=dot*ny;b.vx-=dot*nx;b.vy-=dot*ny;}
}

// â”€â”€ DRAW FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCopCar(x,y,angle,lt) {
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(angle);
  // shadow
  ctx.fillStyle='rgba(0,0,0,0.2)';
  ctx.fillRect(-9+3,-15+3,18,30);
  // white police sedan
  CARS[0].draw(ctx,'#f0f0f0',true);
  // black stripe across middle
  ctx.fillStyle='#111';
  ctx.fillRect(-9,-4,18,8);
  // "POLICE" text omitted (too small) â€” shield badge
  ctx.fillStyle='#ffdd44';
  ctx.fillRect(-2,-2,4,5);
  ctx.restore();
  // flashing lights
  ctx.save();
  ctx.translate(x,y); ctx.rotate(angle);
  const f=Math.floor(lt/7)%2;
  ctx.shadowBlur=18;
  ctx.fillStyle=f===0?'#ff2222':'#0044ff'; ctx.shadowColor=ctx.fillStyle;
  ctx.fillRect(-6,-13,5,4);
  ctx.fillStyle=f===0?'#0044ff':'#ff2222'; ctx.shadowColor=ctx.fillStyle;
  ctx.fillRect(1,-13,5,4);
  ctx.shadowBlur=0;
  ctx.restore();
}

function drawPlayerCar(x,y,angle) {
  const car = CARS[selectedCarIdx];
  ctx.save();
  ctx.translate(x,y); ctx.rotate(angle);
  ctx.fillStyle='rgba(0,0,0,0.22)';
  ctx.fillRect(-car.w/2+3,-car.h/2+3,car.w,car.h);
  car.draw(ctx, playerColor, false);
  ctx.restore();
}

function drawCarPreview(carIdx,cx,cy,sc,color) {
  const car = CARS[carIdx];
  ctx.save();
  ctx.translate(cx,cy);
  ctx.scale(sc,sc);
  ctx.fillStyle='rgba(0,0,0,0.3)';
  ctx.fillRect(-car.w/2+3,-car.h/2+3,car.w,car.h);
  car.draw(ctx, color, false);
  ctx.restore();
}

function drawShield(x,y,r) {
  ctx.save(); ctx.translate(x,y);
  const pulse=(frame*0.05)%(Math.PI*2);
  ctx.strokeStyle=`rgba(0,207,255,${0.6+0.4*Math.sin(pulse)})`;
  ctx.lineWidth=3; ctx.shadowBlur=18; ctx.shadowColor='#00cfff';
  ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
  ctx.shadowBlur=0; ctx.restore();
}

function drawDesert() {
  const g=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,W*0.8);
  g.addColorStop(0,'#e8c97a'); g.addColorStop(0.6,'#d4a84b'); g.addColorStop(1,'#b8882a');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  TRACKS.forEach(t=>{
    ctx.save(); ctx.translate(t.x,t.y); ctx.rotate(t.angle);
    ctx.strokeStyle='rgba(100,60,0,0.2)'; ctx.lineWidth=3; ctx.setLineDash([6,8]);
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,t.len); ctx.stroke();
    ctx.setLineDash([]); ctx.restore();
  });
  ROCKS.forEach(rock=>{
    ctx.fillStyle=`rgba(${120+rock.shade*40},${90+rock.shade*20},50,0.7)`;
    ctx.beginPath(); ctx.ellipse(rock.x,rock.y,rock.r*1.4,rock.r,0,0,Math.PI*2); ctx.fill();
  });
  CACTI.forEach(c=>{
    ctx.fillStyle='#4a7c3f';
    ctx.fillRect(c.x-3,c.y-c.h,6,c.h);
    ctx.fillRect(c.x-10,c.y-c.h*0.6,8,4); ctx.fillRect(c.x-10,c.y-c.h*0.8,4,c.h*0.2);
    ctx.fillRect(c.x+2,c.y-c.h*0.5,8,4);  ctx.fillRect(c.x+6, c.y-c.h*0.7,4,c.h*0.2);
  });
}

function drawPowerups() {
  powerups.forEach(p=>{
    p.pulse=(p.pulse+0.07)%(Math.PI*2);
    const gl=0.6+0.4*Math.sin(p.pulse);
    ctx.save(); ctx.translate(p.x,p.y);
    ctx.shadowBlur=18*gl; ctx.shadowColor=p.glow;
    ctx.fillStyle=p.color;
    ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    ctx.fillStyle='#000'; ctx.font='bold 8px Courier New'; ctx.textAlign='center';
    ctx.fillText(p.label,0,3);
    ctx.restore();
    if (p.life<120) {
      ctx.save(); ctx.globalAlpha=(p.life/120)*0.5+0.1;
      ctx.strokeStyle=p.color; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(p.x,p.y,15+Math.sin(p.pulse*4)*3,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }
  });
}

function drawHUD() {
  const lvl=LEVELS[currentLevel];
  ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(8,8,160,34);
  ctx.fillStyle='#ffdd44'; ctx.font='bold 14px Courier New'; ctx.textAlign='left';
  ctx.fillText(`SCORE: ${score}s`,18,30);

  ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(W-158,8,150,34);
  ctx.fillStyle='#ff4444'; ctx.textAlign='right';
  ctx.fillText(`COPS: ${cops.length}/${lvl.maxCops}`,W-14,30);
  ctx.textAlign='left';

  const pct=Math.min(score/lvl.goal,1);
  const bw=W-20;
  ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.fillRect(10,H-28,bw,16);
  ctx.fillStyle=`rgba(0,${Math.floor(200*pct+55)},${Math.floor(120*pct)},0.85)`;
  ctx.fillRect(10,H-28,bw*pct,16);
  ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.lineWidth=1; ctx.strokeRect(10,H-28,bw,16);
  ctx.fillStyle='#fff'; ctx.font='bold 10px Courier New'; ctx.textAlign='center';
  ctx.fillText(`${lvl.name} â€” SURVIVE ${Math.max(0,lvl.goal-score)}s MORE`,W/2,H-16);
  ctx.textAlign='left';

  let px=8,py=50;
  if (activeEffects.shield>0){drawEffectIcon(px,py,'#00cfff','SHIELD',activeEffects.shield,600);px+=68;}
  if (activeEffects.speed>0) {drawEffectIcon(px,py,'#ffdd00','BOOST', activeEffects.speed,300); px+=68;}
  if (activeEffects.freeze>0){drawEffectIcon(px,py,'#aaffff','FREEZE',activeEffects.freeze,360);px+=68;}
  if (activeEffects.ghost>0) {drawEffectIcon(px,py,'#dd88ff','GHOST', activeEffects.ghost,240); px+=68;}
}
function drawEffectIcon(x,y,color,label,rem,max) {
  ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(x,y,60,30);
  ctx.strokeStyle=color; ctx.lineWidth=2; ctx.strokeRect(x,y,60,30);
  ctx.fillStyle=color; ctx.font='bold 9px Courier New'; ctx.textAlign='center';
  ctx.fillText(label,x+30,y+12);
  ctx.fillStyle=color+'55'; ctx.fillRect(x+2,y+17,56*(rem/max),9);
  ctx.textAlign='left';
}

function drawJoystick() {
  if (!joystick.active) return;
  const jdx=joystick.x-joystick.ox, jdy=joystick.y-joystick.oy;
  const jdist=Math.sqrt(jdx*jdx+jdy*jdy), maxJoy=55;
  const kx=joystick.ox+(jdx/Math.max(jdist,1))*Math.min(jdist,maxJoy);
  const ky=joystick.oy+(jdy/Math.max(jdist,1))*Math.min(jdist,maxJoy);
  ctx.globalAlpha=0.3;
  ctx.strokeStyle='#fff'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(joystick.ox,joystick.oy,maxJoy,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,0.4)';
  ctx.beginPath(); ctx.arc(kx,ky,22,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;
}

// â”€â”€ HOME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawHomeScreen() {
  homePulse=(homePulse+0.02)%(Math.PI*2);
  drawDesert();
  ctx.fillStyle='rgba(10,5,0,0.72)'; ctx.fillRect(0,0,W,H);

  // Title
  ctx.save();
  ctx.shadowBlur=30; ctx.shadowColor='#ff6600';
  ctx.fillStyle='#ff6600'; ctx.font=`bold ${W>500?52:38}px Courier New`;
  ctx.textAlign='center';
  ctx.fillText('DESERT CHASE',W/2,100);
  ctx.shadowBlur=0;
  ctx.fillStyle='#ffaa44'; ctx.font='15px Courier New';
  ctx.fillText('Outrun the law. Survive.',W/2,128);
  ctx.restore();

  // Selected car mini preview on title
  ctx.save();
  ctx.translate(W/2-130,106);
  ctx.rotate(-0.3+Math.sin(homePulse)*0.08);
  CARS[selectedCarIdx].draw(ctx,playerColor,false);
  ctx.restore();

  // Level buttons
  for (let i=0;i<LEVELS.length;i++) {
    const {bx,by,bw,bh}=levelBtnRect(i);
    const hovered=mouse.x>=bx&&mouse.x<=bx+bw&&mouse.y>=by&&mouse.y<=by+bh;
    const focused=(homeKeyFocus===i);
    ctx.fillStyle=(hovered||focused)?'rgba(255,100,0,0.28)':'rgba(0,0,0,0.5)';
    ctx.fillRect(bx,by,bw,bh);
    ctx.strokeStyle=(hovered||focused)?'#ff6600':'#663300';
    ctx.lineWidth=(hovered||focused)?3:1.5;
    ctx.strokeRect(bx,by,bw,bh);
    if (focused) {
      ctx.fillStyle='#ff6600'; ctx.font='bold 16px Courier New'; ctx.textAlign='left';
      ctx.fillText('â–¶',bx-20,by+bh/2+6);
    }
    ctx.fillStyle=(hovered||focused)?'#ff9944':'#ffcc44';
    ctx.font=`bold ${W>500?17:14}px Courier New`; ctx.textAlign='center';
    ctx.fillText(`LEVEL ${i+1}: ${LEVELS[i].name}`,W/2,by+22);
    ctx.fillStyle='#999'; ctx.font='11px Courier New';
    ctx.fillText(LEVELS[i].description,W/2,by+38);
    if (highScores[i]>0) {
      ctx.fillStyle='#ffdd44'; ctx.font='10px Courier New'; ctx.textAlign='right';
      ctx.fillText(`Best: ${highScores[i]}s`,bx+bw-8,by+bh-6);
    }
  }

  // Garage button
  const g=garageBtnRect();
  const ghov=mouse.x>=g.bx&&mouse.x<=g.bx+g.bw&&mouse.y>=g.by&&mouse.y<=g.by+g.bh;
  const gfoc=(homeKeyFocus===4);
  ctx.fillStyle=(ghov||gfoc)?'rgba(0,180,100,0.28)':'rgba(0,0,0,0.5)';
  ctx.fillRect(g.bx,g.by,g.bw,g.bh);
  ctx.strokeStyle=(ghov||gfoc)?'#00cc66':'#336633';
  ctx.lineWidth=(ghov||gfoc)?3:1.5;
  ctx.strokeRect(g.bx,g.by,g.bw,g.bh);
  if (gfoc) {
    ctx.fillStyle='#00cc66'; ctx.font='bold 16px Courier New'; ctx.textAlign='left';
    ctx.fillText('â–¶',g.bx-20,g.by+g.bh/2+6);
  }
  ctx.fillStyle=(ghov||gfoc)?'#44ff99':'#88cc88';
  ctx.font='bold 16px Courier New'; ctx.textAlign='center';
  ctx.fillText('ðŸš—  GARAGE',W/2,g.by+32);

  // Keyboard hint
  ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.font='11px Courier New'; ctx.textAlign='center';
  ctx.fillText(isMobile?'Tap a level to play':'â†‘â†“ navigate  â€¢  Enter to select',W/2,H-14);
  ctx.textAlign='left';
}

// â”€â”€ GARAGE SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGarageScreen() {
  drawDesert();
  ctx.fillStyle='rgba(5,5,15,0.82)'; ctx.fillRect(0,0,W,H);

  ctx.fillStyle='#ffcc44'; ctx.font=`bold ${W>500?30:22}px Courier New`; ctx.textAlign='center';
  ctx.fillText('GARAGE',W/2,50);

  const car=CARS[garageIdx];
  const unlocked=isUnlocked(garageIdx);

  // Car nav arrows (big touch targets)
  const arrowY=H/2-40;
  // Left arrow
  const lhov=(mouse.x<W/2-80&&mouse.y>120&&mouse.y<H-130);
  ctx.fillStyle=lhov?'rgba(255,255,255,0.15)':'rgba(255,255,255,0.05)';
  ctx.fillRect(0,130,W/2-80,H-260);
  ctx.fillStyle=lhov?'#fff':'rgba(255,255,255,0.5)';
  ctx.font='bold 40px Courier New'; ctx.textAlign='center';
  ctx.fillText('â€¹',W/2-110,arrowY+50);
  // Right arrow
  const rhov=(mouse.x>W/2+80&&mouse.y>120&&mouse.y<H-130);
  ctx.fillStyle=rhov?'rgba(255,255,255,0.15)':'rgba(255,255,255,0.05)';
  ctx.fillRect(W/2+80,130,W/2-80,H-260);
  ctx.fillStyle=rhov?'#fff':'rgba(255,255,255,0.5)';
  ctx.fillText('â€º',W/2+110,arrowY+50);

  // Car preview (big)
  const previewScale=3.2;
  if (unlocked) {
    drawCarPreview(garageIdx, W/2, H/2-30, previewScale, playerColor);
  } else {
    ctx.globalAlpha=0.25;
    drawCarPreview(garageIdx, W/2, H/2-30, previewScale, '#888');
    ctx.globalAlpha=1;
    // Lock overlay
    ctx.fillStyle='rgba(0,0,0,0.55)';
    ctx.beginPath(); ctx.arc(W/2,H/2-30,50,0,Math.PI*2); ctx.fill();
    ctx.font='36px serif'; ctx.textAlign='center';
    ctx.fillText('ðŸ”’',W/2,H/2-14);
  }

  // Car name
  ctx.textAlign='center';
  ctx.fillStyle=unlocked?'#ffdd44':'#888';
  ctx.font=`bold ${W>500?22:17}px Courier New`;
  ctx.fillText(car.name,W/2,H/2+80);

  // Lock / desc text
  ctx.font='12px Courier New';
  if (!unlocked) {
    const req=LEVELS[car.unlockLevel].name;
    ctx.fillStyle='#ff8844';
    ctx.fillText(`Beat Level ${car.unlockLevel+1}: ${req} to unlock`,W/2,H/2+102);
  } else if (selectedCarIdx===garageIdx) {
    ctx.fillStyle='#44ff88';
    ctx.fillText('âœ“ EQUIPPED',W/2,H/2+102);
  } else {
    ctx.fillStyle='#888';
    const lines=car.desc.split('\n');
    ctx.fillText(lines[0],W/2,H/2+102);
  }

  // Dot indicators
  const dotY=H/2+122;
  for (let i=0;i<CARS.length;i++) {
    const dx=W/2+(i-(CARS.length-1)/2)*16;
    ctx.fillStyle=i===garageIdx?'#ffdd44':isUnlocked(i)?'#556644':'#333';
    ctx.beginPath(); ctx.arc(dx,dotY,i===garageIdx?5:3,0,Math.PI*2); ctx.fill();
  }

  // Color picker (only if unlocked)
  if (unlocked) {
    const cy0=garageColorY();
    ctx.fillStyle='#aaa'; ctx.font='12px Courier New'; ctx.textAlign='center';
    ctx.fillText('COLOR',W/2,cy0-6);
    CAR_COLORS.forEach((c,i)=>{
      const sx=W/2-(CAR_COLORS.length*34)/2+i*34+3;
      const sel=(c===playerColor&&garageIdx===garageIdx);
      ctx.fillStyle=c; ctx.fillRect(sx,cy0,28,28);
      if (sel&&c===playerColor) {
        ctx.strokeStyle='#fff'; ctx.lineWidth=3;
        ctx.strokeRect(sx-2,cy0-2,32,32);
      }
      const hov=mouse.x>=sx&&mouse.x<=sx+28&&mouse.y>=cy0&&mouse.y<=cy0+28;
      if (hov&&!sel) { ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=1.5; ctx.strokeRect(sx,cy0,28,28); }
    });
  }

  // Select / already equipped button
  const s=garageSelectRect();
  if (unlocked) {
    const already=selectedCarIdx===garageIdx;
    const shov=mouse.x>=s.bx&&mouse.x<=s.bx+s.bw&&mouse.y>=s.by&&mouse.y<=s.by+s.bh;
    ctx.fillStyle=already?'rgba(0,200,80,0.2)':shov?'rgba(255,100,0,0.3)':'rgba(0,0,0,0.5)';
    ctx.fillRect(s.bx,s.by,s.bw,s.bh);
    ctx.strokeStyle=already?'#00cc55':shov?'#ff6600':'#555';
    ctx.lineWidth=2; ctx.strokeRect(s.bx,s.by,s.bw,s.bh);
    ctx.fillStyle=already?'#44ff88':shov?'#ff9944':'#fff';
    ctx.font='bold 14px Courier New'; ctx.textAlign='center';
    ctx.fillText(already?'EQUIPPED':'SELECT',W/2,s.by+28);
  }

  // Back button
  const b=garageBackRect();
  const bhov=mouse.x>=b.bx&&mouse.x<=b.bx+b.bw&&mouse.y>=b.by&&mouse.y<=b.by+b.bh;
  ctx.fillStyle=bhov?'rgba(255,255,255,0.15)':'rgba(0,0,0,0.5)';
  ctx.fillRect(b.bx,b.by,b.bw,b.bh);
  ctx.strokeStyle=bhov?'#aaa':'#444'; ctx.lineWidth=2; ctx.strokeRect(b.bx,b.by,b.bw,b.bh);
  ctx.fillStyle=bhov?'#fff':'#888'; ctx.font='bold 13px Courier New'; ctx.textAlign='center';
  ctx.fillText('â—€ BACK',b.bx+b.bw/2,b.by+28);

  // Keyboard hint
  ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.font='11px Courier New'; ctx.textAlign='center';
  ctx.fillText(isMobile?'Tap sides to browse':'â—€ â–¶ browse  â€¢  Enter to equip  â€¢  Esc back',W/2,H-14);
  ctx.textAlign='left';
}

// â”€â”€ GAME OVER / WIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGameOver() {
  ctx.fillStyle='rgba(0,0,0,0.65)'; ctx.fillRect(0,0,W,H);
  const pw=300,ph=270,px=W/2-pw/2,py=H/2-ph/2;
  ctx.fillStyle='#1a0800'; ctx.strokeStyle='#ff4400'; ctx.lineWidth=3;
  ctx.fillRect(px,py,pw,ph); ctx.strokeRect(px,py,pw,ph);
  ctx.fillStyle='#ff4400'; ctx.font='bold 40px Courier New'; ctx.textAlign='center';
  ctx.fillText('BUSTED!',W/2,py+60);
  ctx.font='32px serif'; ctx.fillText('ðŸš”ðŸ’¥',W/2,py+104);
  ctx.fillStyle='#ffcc44'; ctx.font='bold 17px Courier New';
  ctx.fillText('Survived: '+score+'s',W/2,py+144);
  ctx.fillStyle='#888'; ctx.font='13px Courier New';
  ctx.fillText('Best: '+highScores[currentLevel]+'s',W/2,py+168);
  ctx.fillStyle='#fff'; ctx.font='13px Courier New';
  ctx.fillText(isMobile?'Tap â€” play again':'Click  or  R â€” play again',W/2,py+206);
  ctx.fillStyle='#aaa'; ctx.font='11px Courier New';
  ctx.fillText(isMobile?'':'Esc â€” back to menu',W/2,py+228);
  ctx.textAlign='left';
}

function drawWinScreen() {
  ctx.fillStyle='rgba(0,20,0,0.75)'; ctx.fillRect(0,0,W,H);
  const pw=320,ph=300,px=W/2-pw/2,py=H/2-ph/2;
  ctx.fillStyle='#001a00'; ctx.strokeStyle='#00ff88'; ctx.lineWidth=3;
  ctx.fillRect(px,py,pw,ph); ctx.strokeRect(px,py,pw,ph);
  ctx.shadowBlur=20; ctx.shadowColor='#00ff88';
  ctx.fillStyle='#00ff88'; ctx.font='bold 30px Courier New'; ctx.textAlign='center';
  ctx.fillText('YOU SURVIVED!',W/2,py+50);
  ctx.shadowBlur=0;
  ctx.font='30px serif'; ctx.fillText('ðŸ†ðŸš—ðŸ’¨',W/2,py+94);
  ctx.fillStyle='#ffdd44'; ctx.font='bold 17px Courier New';
  ctx.fillText('Survived: '+score+'s',W/2,py+134);
  ctx.fillStyle='#888'; ctx.font='12px Courier New';
  ctx.fillText('Best: '+highScores[currentLevel]+'s',W/2,py+156);
  // unlocks
  if (newUnlockNames.length>0) {
    ctx.fillStyle='#ffaa00'; ctx.font='bold 12px Courier New';
    ctx.fillText('ðŸ”“ UNLOCKED: '+newUnlockNames.join(', '),W/2,py+180);
    ctx.fillStyle='#ffaa00'; ctx.font='11px Courier New';
    ctx.fillText('Check the Garage!',W/2,py+196);
  }
  const nextLvl=currentLevel+1;
  if (nextLvl<LEVELS.length) {
    ctx.fillStyle='#aaffcc'; ctx.font='12px Courier New';
    ctx.fillText('Next: Level '+(nextLvl+1)+' â€” '+LEVELS[nextLvl].name,W/2,py+222);
    ctx.fillStyle='#fff'; ctx.font='13px Courier New';
    ctx.fillText(isMobile?'Tap â€” next level':'Click  or  Enter â€” next level',W/2,py+248);
    ctx.fillStyle='#aaa'; ctx.font='11px Courier New';
    ctx.fillText(isMobile?'':'Esc â€” back to menu',W/2,py+268);
  } else {
    ctx.fillStyle='#ffdd44'; ctx.font='14px Courier New';
    ctx.fillText('ALL LEVELS COMPLETE!',W/2,py+222);
    ctx.fillStyle='#fff'; ctx.font='13px Courier New';
    ctx.fillText(isMobile?'Tap â€” menu':'Click  or  Enter â€” menu',W/2,py+258);
  }
  ctx.textAlign='left';
}

// â”€â”€ START / RESTART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame() {
  player.x=W/2; player.y=H/2; player.vx=0; player.vy=0; player.angle=0;
  player.w=CARS[selectedCarIdx].w; player.h=CARS[selectedCarIdx].h;
  cops=[]; dustParticles=[]; explosions=[]; powerups=[];
  score=0; frame=0; copTimer=0; powerupTimer=0;
  activeEffects={shield:0,speed:0,freeze:0,ghost:0};
  shieldHit=false; newUnlockNames=[];
  joystick.active=false;
  genScenery();
  state='playing';
  gtag('event','game_start',{game:'Desert Chase',level:currentLevel});
}
function restart(lvl) { currentLevel=lvl||0; startGame(); }

// â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop() {
  requestAnimationFrame(loop);
  frame++;

  if (state==='home')   { drawHomeScreen();   return; }
  if (state==='garage') { drawGarageScreen(); return; }

  const lvl=LEVELS[currentLevel];

  if (state==='playing') {
    // â”€â”€ Movement â”€â”€
    const maxSpd = activeEffects.speed>0 ? 8.5 : 5.5;
    const accel=0.18, friction=0.88;

    if (joystick.active) {
      // Mobile joystick
      const jdx=joystick.x-joystick.ox, jdy=joystick.y-joystick.oy;
      const jdist=Math.sqrt(jdx*jdx+jdy*jdy);
      if (jdist>8) {
        const jang=Math.atan2(jdy,jdx);
        const jspd=Math.min(jdist/55,1)*maxSpd;
        player.angle=jang+Math.PI/2;
        player.vx+=(Math.cos(jang)*jspd-player.vx)*accel;
        player.vy+=(Math.sin(jang)*jspd-player.vy)*accel;
      } else {
        player.vx*=friction; player.vy*=friction;
      }
    } else {
      // Mouse follow
      const dx=mouse.x-player.x, dy=mouse.y-player.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if (dist>6) {
        const ang=Math.atan2(dy,dx);
        player.angle=ang+Math.PI/2;
        const spd=Math.min(dist*0.10,maxSpd);
        player.vx+=(Math.cos(ang)*spd-player.vx)*accel;
        player.vy+=(Math.sin(ang)*spd-player.vy)*accel;
      } else {
        player.vx*=friction; player.vy*=friction;
      }
    }
    player.x=Math.max(player.w/2,Math.min(W-player.w/2,player.x+player.vx));
    player.y=Math.max(player.h/2,Math.min(H-player.h/2,player.y+player.vy));
    const spd2=Math.sqrt(player.vx*player.vx+player.vy*player.vy);
    if (frame%4===0&&spd2>1) spawnDust(player.x,player.y+10);

    // â”€â”€ Spawning â”€â”€
    if (++copTimer>=lvl.spawnRate) { spawnCop(); copTimer=0; }
    if (++powerupTimer>=400) { if(powerups.length<3) spawnPowerup(); powerupTimer=0; }

    // â”€â”€ Cops â”€â”€
    const freezeMult=activeEffects.freeze>0?0.3:1;
    cops.forEach(cop=>{
      cop.age++;
      if (activeEffects.ghost>0) {
        cop.vx+=(Math.random()-0.5)*0.5; cop.vy+=(Math.random()-0.5)*0.5;
        cop.vx*=0.95; cop.vy*=0.95;
      } else {
        const ca=Math.atan2(player.y-cop.y,player.x-cop.x);
        cop.angle=ca+Math.PI/2;
        cop.vx+=(Math.cos(ca)*cop.speed*freezeMult-cop.vx)*0.15;
        cop.vy+=(Math.sin(ca)*cop.speed*freezeMult-cop.vy)*0.15;
      }
      cop.x+=cop.vx; cop.y+=cop.vy; cop.lt++;
      if (frame%7===0) spawnDust(cop.x,cop.y+10,'#b09040');
    });
    cops=cops.filter(c=>c.age<c.lifetime);
    for (let i=0;i<cops.length;i++) for (let j=i+1;j<cops.length;j++) separateCops(cops[i],cops[j]);

    // â”€â”€ Powerup tick â”€â”€
    powerups.forEach(p=>p.life--);
    powerups=powerups.filter(p=>p.life>0);
    powerups=powerups.filter(p=>{
      if (Math.hypot(p.x-player.x,p.y-player.y)<22) {
        activeEffects[p.type]=p.duration; spawnDust(p.x,p.y,p.glow); return false;
      }
      return true;
    });
    if(activeEffects.shield>0)activeEffects.shield--;
    if(activeEffects.speed>0) activeEffects.speed--;
    if(activeEffects.freeze>0)activeEffects.freeze--;
    if(activeEffects.ghost>0) activeEffects.ghost--;

    // â”€â”€ Collision â”€â”€
    if (activeEffects.ghost===0) {
      for (const cop of cops) {
        if (rectsOverlap(cop.x,cop.y,cop.w,cop.h,player.x,player.y,player.w,player.h)) {
          if (activeEffects.shield>0) {
            activeEffects.shield=0; shieldHit=true;
            setTimeout(()=>shieldHit=false,300);
            const ba=Math.atan2(cop.y-player.y,cop.x-player.x);
            cop.vx=Math.cos(ba)*4; cop.vy=Math.sin(ba)*4;
            spawnDust(player.x,player.y,'#00cfff'); break;
          } else {
            spawnExplosion(player.x,player.y); spawnExplosion(cop.x,cop.y);
            if (score>highScores[currentLevel]) highScores[currentLevel]=score;
            state='dead';
            gtag('event','game_over',{game:'Desert Chase',level:currentLevel,score:score});
            break;
          }
        }
      }
    }

    // â”€â”€ Win â”€â”€
    if (state==='playing'&&score>=lvl.goal) {
      if (score>highScores[currentLevel]) highScores[currentLevel]=score;
      if (!levelsBeaten[currentLevel]) {
        levelsBeaten[currentLevel]=true;
        newUnlockNames = CARS.filter(c=>c.unlockLevel===currentLevel).map(c=>c.name);
      }
      state='win';
      gtag('event','game_win',{game:'Desert Chase',level:currentLevel,score:score});
    }

    if (frame%60===0) score++;
  }

  // â”€â”€ Particles â”€â”€
  dustParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=0.92;p.vy*=0.92;p.life-=p.decay;});
  dustParticles=dustParticles.filter(p=>p.life>0);
  explosions.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=0.94;p.vy*=0.94;p.life-=p.decay;});
  explosions=explosions.filter(p=>p.life>0);

  // â”€â”€ Draw â”€â”€
  drawDesert();
  drawPowerups();

  dustParticles.forEach(p=>{
    ctx.globalAlpha=p.life*0.4; ctx.fillStyle=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1;

  if (activeEffects.ghost>0)  { ctx.fillStyle='rgba(180,100,255,0.07)'; ctx.fillRect(0,0,W,H); }
  if (activeEffects.freeze>0) { ctx.fillStyle='rgba(0,200,255,0.06)';   ctx.fillRect(0,0,W,H); }

  if (state==='playing'||state==='dead'||state==='win') {
    cops.forEach(cop=>{
      const fade=Math.min(1,(cop.lifetime-cop.age)/120);
      ctx.globalAlpha=Math.max(0.2,fade);
      drawCopCar(cop.x,cop.y,cop.angle,cop.lt);
      ctx.globalAlpha=1;
    });
    if (activeEffects.ghost>0) ctx.globalAlpha=0.45;
    drawPlayerCar(player.x,player.y,player.angle);
    ctx.globalAlpha=1;
    if (activeEffects.shield>0) drawShield(player.x,player.y,shieldHit?32:22);
  }

  explosions.forEach(p=>{
    ctx.globalAlpha=p.life*0.9; ctx.fillStyle=p.color;
    ctx.shadowBlur=14; ctx.shadowColor=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1; ctx.shadowBlur=0;

  if (state==='playing'||state==='dead'||state==='win') drawHUD();
  if (isMobile&&state==='playing') drawJoystick();
  if (state==='dead') drawGameOver();
  if (state==='win')  drawWinScreen();

  // Intro tip
  if (state==='playing'&&frame<220) {
    ctx.globalAlpha=Math.min(1,(220-frame)/60);
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(W/2-170,H/2+60,340,46);
    ctx.fillStyle='#fff'; ctx.font='13px Courier New'; ctx.textAlign='center';
    ctx.fillText(isMobile?'Use the joystick to drive!':'Move your mouse to drive!',W/2,H/2+82);
    ctx.fillStyle='#aaffcc'; ctx.font='11px Courier New';
    ctx.fillText('Collect glowing orbs for power-ups!',W/2,H/2+99);
    ctx.textAlign='left'; ctx.globalAlpha=1;
  }
}

loop();
</script>
</body>
</html>
