<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P1VFNJ21V0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-P1VFNJ21V0');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9556113318001178"
     crossorigin="anonymous"></script>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸª¨</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOVA STRIKE</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#000;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    font-family:'Rajdhani',sans-serif;
    overflow:hidden;
  }
  #wrap {
    position:relative;
    width:480px;
    height:680px;
  }
  canvas {
    display:block;
    width:480px;
    height:680px;
    max-width:100vw;
    max-height:calc(100vh - 20px);
    touch-action:none;
    border:1px solid #1a1a2e;
    box-shadow: 0 0 60px rgba(0,200,255,0.15), 0 0 120px rgba(0,200,255,0.05);
  }
</style>
</head>
<body>
<!-- LOADING SCREEN -->
<div id="loadingScreen" style="position:fixed;inset:0;z-index:9999;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.5s ease;">
  <div style="font-family:'Cinzel',serif;font-size:2.5rem;font-weight:900;color:#00e5ff;text-shadow:0 0 20px rgba(0,229,255,0.6);letter-spacing:0.1em;">ðŸª¨ GAMECAVE</div>
  <div style="margin-top:1rem;font-family:'Nunito',sans-serif;font-size:1rem;color:#5a5a7a;letter-spacing:0.15em;text-transform:uppercase;">Loadingâ€¦</div>
  <div style="margin-top:1.5rem;width:120px;height:4px;background:#1a1a2e;border-radius:2px;overflow:hidden;">
    <div id="loadBar" style="height:100%;background:#00e5ff;width:0%;transition:width 0.7s ease;border-radius:2px;"></div>
  </div>
</div>
<script>
  document.getElementById('loadBar').style.width = '100%';
  window.addEventListener('load', () => {
    setTimeout(() => {
      const ls = document.getElementById('loadingScreen');
      ls.style.opacity = '0';
      setTimeout(() => ls.style.display = 'none', 500);
    }, 400);
  });
</script>
<div id="wrap">
  <a href="index.html" style="position:fixed;top:8px;left:8px;z-index:100;font-family:Cinzel,serif;font-weight:900;font-size:0.7rem;color:#e8a020;text-decoration:none;text-shadow:0 0 8px rgba(232,160,32,0.4);padding:3px 8px;background:rgba(0,0,0,0.7);border:1px solid #4a3820;border-radius:3px;letter-spacing:0.08em;">ðŸª¨ GAMECAVE</a>
  <canvas id="c"></canvas>
</div>
<script>
// â”€â”€ SOUND ENGINE â”€â”€
const sfx = (() => {
  let ctx;
  function ensure() { if (!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)(); return ctx; }
  function play(name) {
    try {
      const c = ensure();
      const g = c.createGain();
      g.connect(c.destination);
      const o = c.createOscillator();
      o.connect(g);
      const t = c.currentTime;
      if (name==='start')  { o.frequency.setValueAtTime(440,t); o.frequency.linearRampToValueAtTime(880,t+0.15); g.gain.setValueAtTime(0.25,t); g.gain.linearRampToValueAtTime(0,t+0.2); o.start(t); o.stop(t+0.2); }
      else if (name==='score'||name==='point') { o.frequency.setValueAtTime(660,t); o.frequency.linearRampToValueAtTime(880,t+0.08); g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.12); o.start(t); o.stop(t+0.12); }
      else if (name==='die'||name==='over') { o.type='sawtooth'; o.frequency.setValueAtTime(330,t); o.frequency.linearRampToValueAtTime(110,t+0.3); g.gain.setValueAtTime(0.3,t); g.gain.linearRampToValueAtTime(0,t+0.35); o.start(t); o.stop(t+0.35); }
      else if (name==='shoot') { o.type='square'; o.frequency.setValueAtTime(880,t); o.frequency.linearRampToValueAtTime(440,t+0.08); g.gain.setValueAtTime(0.15,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(t); o.stop(t+0.1); }
      else if (name==='explode') { o.type='sawtooth'; o.frequency.setValueAtTime(200,t); o.frequency.linearRampToValueAtTime(50,t+0.25); g.gain.setValueAtTime(0.35,t); g.gain.linearRampToValueAtTime(0,t+0.3); o.start(t); o.stop(t+0.3); }
      else if (name==='powerup') { o.frequency.setValueAtTime(440,t); o.frequency.linearRampToValueAtTime(1320,t+0.2); g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.25); o.start(t); o.stop(t+0.25); }
      else if (name==='win') { [440,550,660,880].forEach((f,i)=>{ const o2=c.createOscillator(); o2.connect(g); o2.frequency.value=f; o2.start(t+i*0.1); o2.stop(t+i*0.1+0.15); }); g.gain.setValueAtTime(0.22,t); g.gain.linearRampToValueAtTime(0,t+0.55); o.disconnect(); }
    } catch(e) {}
  }
  return { play };
})();

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = 480;
canvas.height = 680;
const W = 480, H = 680, CX = W/2;

// â”€â”€ SHIP SKINS â”€â”€
const SKINS = [
  { name:'VIPER',   color:'#00e5ff', accent:'#ffffff', trail:'#0077ff' },
  { name:'PHANTOM', color:'#ff3cac', accent:'#ffffff', trail:'#cc0088' },
  { name:'TITAN',   color:'#39ff14', accent:'#ffffff', trail:'#00bb00' },
  { name:'SHADOW',  color:'#bb86fc', accent:'#ffffff', trail:'#7c4dff' },
  { name:'INFERNO', color:'#ff6b35', accent:'#ffee00', trail:'#ff2200' },
  { name:'AURORA',  color:'#00ffcc', accent:'#ffffff', trail:'#00aaaa' },
];

// â”€â”€ LEVEL NAMES â”€â”€
const LEVEL_NAMES = ['FRONTIER SPACE','DANGER ZONE','NEBULA DRIFT','DEEP SPACE','VOID SECTOR','APEX GAUNTLET'];
function getLevelName(lv){ return LEVEL_NAMES[Math.min(lv-1, LEVEL_NAMES.length-1)]; }

// â”€â”€ STATE â”€â”€
let state = 'menu';
let chosenSkin = 0;
let score = 0, lives = 3, wave = 1;
let hiScore = +localStorage.getItem('ns2_hi')||0;
let shakeX=0, shakeY=0, shakeDur=0;

// Upgrade system
const UPGRADE_POOL = [
  {id:'speed',  name:'SPEED BOOST',  desc:'+30% movement speed',        icon:'ðŸš€', color:'#00e5ff'},
  {id:'rof',    name:'RAPID FIRE',   desc:'Permanently faster shooting', icon:'âš¡', color:'#ffcc00'},
  {id:'spread', name:'SPREAD SHOT',  desc:'Fire extra side bullets',     icon:'ðŸ’¥', color:'#ff6600'},
  {id:'life',   name:'EXTRA LIFE',   desc:'+1 life (max 7)',             icon:'â¤ï¸', color:'#ff3366'},
  {id:'shield', name:'BARRIER',      desc:'Full shield for next wave',   icon:'ðŸ›¡', color:'#00ccff'},
  {id:'power',  name:'POWER SHOT',   desc:'Bullets do 2 HP damage',     icon:'ðŸ”¥', color:'#ff4400'},
  {id:'score',  name:'SCORE BOOST',  desc:'+50% score multiplier',       icon:'âœ¦', color:'#ffdd00'},
  {id:'multi',  name:'MULTI-SHOT',   desc:'Fire 5 bullets at once',      icon:'ðŸŒŸ', color:'#cc88ff'},
];
let upgradeChoices = [], upgradeSelectedIdx = 0;
let playerUpgrades = {};

// Level & Boss state
let level = 1;
let levelBanner = 0;   // frames to show level transition banner
let boss = null;        // boss entity (null when no boss active)
let bossWarning = 0;   // frames to show boss warning

// â”€â”€ STARS â”€â”€
const stars = Array.from({length:130}, ()=>({
  x: Math.random()*W, y: Math.random()*H,
  r: Math.random()*1.5+0.3,
  speed: Math.random()*0.9+0.15,
  phase: Math.random()*Math.PI*2
}));

// â”€â”€ PLAYER â”€â”€
let player, bullets, eBullets, enemies, particles, powerups, trails, divers;

function makePlayer(){
  return {x:CX, y:H-80, speed:4.8,
    shootTimer:0, invincible:0, shield:0, rapidFire:0, dead:false};
}

// â”€â”€ UTILS â”€â”€
function rand(a,b){ return a+Math.random()*(b-a); }
function randInt(a,b){ return Math.floor(rand(a,b+1)); }
function shake(amt,dur){ shakeDur=dur; shakeX=(Math.random()-0.5)*amt; shakeY=(Math.random()-0.5)*amt; }
function burst(x,y,color,n=12){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, s=rand(1,4.5);
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:rand(1.5,4),life:1,color,fade:rand(0.02,0.045)});
  }
}

let tick = 0;

// â”€â”€ WAVE / LEVEL HELPERS â”€â”€
function isBossWave(w){ return w>0 && w%5===0; }
function getEnemyTypes(){
  if(wave<3) return ['basic','fast'];
  if(wave<5) return ['basic','fast','tank'];
  if(wave<7) return ['basic','fast','tank','bomber'];
  if(wave<10) return ['basic','fast','tank','bomber','sniper'];
  if(wave<13) return ['basic','fast','tank','bomber','sniper','stealth'];
  return ['basic','fast','tank','bomber','sniper','stealth','zigzag'];
}
function getRandomUpgrades(n){
  const pool=[...UPGRADE_POOL];
  for(let i=pool.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [pool[i],pool[j]]=[pool[j],pool[i]];
  }
  return pool.slice(0,n);
}
function selectUpgrade(idx){
  if(idx<0||idx>=upgradeChoices.length) return;
  const upg=upgradeChoices[idx];
  playerUpgrades[upg.id]=(playerUpgrades[upg.id]||0)+1;
  if(upg.id==='speed') player.speed=Math.min(player.speed*1.3,12);
  else if(upg.id==='life') lives=Math.min(lives+1,7);
  else if(upg.id==='shield') player.shield=600;
  sfx.play('powerup');
  state='playing';
  spawnWave();
}

// â”€â”€ SPAWN WAVE â”€â”€
const ROWS=4, COLS=9;
function spawnWave(){
  enemies=[]; divers=[];
  if(isBossWave(wave)){
    spawnBoss();
    bossWarning = 120;
    return;
  }
  const types = getEnemyTypes();
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(r===0 && c%3!==1) continue;
      const type = types[randInt(0,types.length-1)];
      const hx = 45 + c*(W-90)/(COLS-1);
      const hy = 75 + r*52;
      const hp = type==='tank'?3 : (type==='bomber'||type==='sniper')?2 : 1;
      enemies.push({
        x:hx, y:-60-r*55,
        hx, hy,
        type, hp,
        inFormation:false,
        enterT: r*16+c*5,
        t:0, animT:Math.random()*Math.PI*2,
        diving:false, divePath:[], divePathIdx:0,
        shootTimer:randInt(60,200),
        w:26, h:26,
        // Sniper-specific
        charging:false, chargeTimer:0, chargeTarget:null
      });
    }
  }
}

// â”€â”€ BOSS â”€â”€
function spawnBoss(){
  const bossNum = Math.floor(wave/5);
  const maxHp = 40 + bossNum * 20;
  boss = {
    x: CX, y: 110,
    vx: 1.2 + bossNum * 0.15,
    hp: maxHp, maxHp,
    attackTimer: 0,
    animT: 0
  };
}

function updateBoss(){
  if(!boss) return;
  boss.animT += 0.05;
  boss.x += boss.vx;
  if(boss.x < 75 || boss.x > W-75) boss.vx *= -1;

  boss.attackTimer++;
  const phase2 = boss.hp <= boss.maxHp/2;
  const attackRate = phase2 ? 65 : 95;

  if(boss.attackTimer >= attackRate){
    boss.attackTimer = 0;
    const numShots = phase2 ? 8 : 5;
    for(let i=0;i<numShots;i++){
      const angle = (Math.PI/(numShots-1))*i;
      const vx = Math.cos(angle-Math.PI/2)*3;
      const vy = Math.sin(angle-Math.PI/2)*3;
      eBullets.push({x:boss.x, y:boss.y+32, vx, vy});
    }
    if(phase2){
      const ang = Math.atan2(player.y-boss.y, player.x-boss.x);
      eBullets.push({x:boss.x-52,y:boss.y+15,vx:Math.cos(ang)*3.5,vy:Math.sin(ang)*3.5});
      eBullets.push({x:boss.x+52,y:boss.y+15,vx:Math.cos(ang)*3.5,vy:Math.sin(ang)*3.5});
    }
  }
}

function buildDivePath(e){
  const path=[];
  const steps=90;
  const cp1x=e.x+rand(-120,120), cp1y=e.y+rand(90,200);
  const cp2x=player.x+rand(-80,80), cp2y=player.y-rand(60,140);
  const ex=e.hx+rand(-15,15), ey=-90;
  for(let i=0;i<=steps;i++){
    const t=i/steps, it=1-t;
    path.push({
      x:it*it*it*e.x+3*it*it*t*cp1x+3*it*t*t*cp2x+t*t*t*ex,
      y:it*it*it*e.y+3*it*it*t*cp1y+3*it*t*t*cp2y+t*t*t*ey
    });
  }
  return path;
}

function resetGame(){
  sfx.play('start');
  score=0; lives=3; wave=1; level=1; levelBanner=0; boss=null; bossWarning=0;
  playerUpgrades={};
  player=makePlayer();
  bullets=[]; eBullets=[]; particles=[]; powerups=[]; trails=[]; divers=[];
  spawnWave();
}

// â”€â”€ INPUT â”€â”€
const keys={};
document.addEventListener('keydown',e=>{ keys[e.key]=true; if(e.key===' ')e.preventDefault(); });
document.addEventListener('keyup',e=>{ keys[e.key]=false; });

// â”€â”€ TOUCH CONTROLS â”€â”€
let touchActive = false;
let touchX = 240, touchY = 500;
const isMobileDevice = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;

canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  touchActive = true;
  const r = canvas.getBoundingClientRect();
  const scaleX = 480 / r.width;
  const scaleY = 680 / r.height;
  const t = e.changedTouches[0];
  touchX = (t.clientX - r.left) * scaleX;
  touchY = (t.clientY - r.top) * scaleY;

  // Menu/gameover/customize tap handling
  if (state === 'menu') {
    if (touchY > 370 && touchY < 420) { state = 'playing'; resetGame(); gtag('event','game_start',{game:'Nova Strike'}); }
    else if (touchY > 430 && touchY < 470) { state = 'customize'; }
  } else if (state === 'gameover') {
    if (touchY > 400 && touchY < 450) { state = 'playing'; resetGame(); gtag('event','game_start',{game:'Nova Strike'}); }
  } else if (state === 'customize') {
    // Tap on ship cards to select
    const cols = 3;
    for (let i = 0; i < SKINS.length; i++) {
      const col = i % cols, row = Math.floor(i / cols);
      const sx = 80 + col * 160, sy = 155 + row * 200;
      if (touchX > sx - 52 && touchX < sx + 52 && touchY > sy - 65 && touchY < sy + 83) {
        chosenSkin = i;
      }
    }
    if (touchY > 620) { state = 'playing'; resetGame(); gtag('event','game_start',{game:'Nova Strike'}); }
  } else if (state === 'upgrade') {
    for (let i = 0; i < upgradeChoices.length; i++) {
      const cardY = 158 + i * 158;
      if (touchY > cardY - 58 && touchY < cardY + 58) { selectUpgrade(i); }
    }
  }
}, { passive: false });

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  const r = canvas.getBoundingClientRect();
  const scaleX = 480 / r.width;
  const scaleY = 680 / r.height;
  const t = e.changedTouches[0];
  touchX = (t.clientX - r.left) * scaleX;
  touchY = (t.clientY - r.top) * scaleY;
}, { passive: false });

canvas.addEventListener('touchend', e => {
  e.preventDefault();
  touchActive = false;
}, { passive: false });


// â”€â”€ DRAW HELPERS â”€â”€
function hexRgb(h){ return [parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)]; }

function drawShip(x,y,skinIdx,sc=1,engine=true){
  const s=SKINS[skinIdx];
  ctx.save();
  ctx.translate(x,y); ctx.scale(sc,sc);
  if(engine){
    const [r,g,b]=hexRgb(s.trail);
    const g2=ctx.createRadialGradient(0,16,0,0,16,22);
    g2.addColorStop(0,`rgba(${r},${g},${b},0.9)`);
    g2.addColorStop(1,'transparent');
    ctx.fillStyle=g2; ctx.fillRect(-22,8,44,34);
  }
  ctx.shadowBlur=20; ctx.shadowColor=s.color; ctx.fillStyle=s.color;
  ctx.beginPath();
  ctx.moveTo(0,-18); ctx.lineTo(-14,14); ctx.lineTo(-6,9); ctx.lineTo(0,15);
  ctx.lineTo(6,9); ctx.lineTo(14,14); ctx.closePath(); ctx.fill();
  ctx.shadowBlur=8; ctx.shadowColor='#fff'; ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.arc(0,-3,5,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=0.5; ctx.strokeStyle=s.accent; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(-11,8); ctx.lineTo(-14,14); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(11,8); ctx.lineTo(14,14); ctx.stroke();
  ctx.globalAlpha=1; ctx.shadowBlur=0; ctx.restore();
}

function drawEnemy(e){
  ctx.save();
  ctx.translate(e.x,e.y);
  const pulse=0.92+Math.sin(e.animT*3)*0.08;
  if(e.type==='basic'){
    ctx.shadowBlur=14; ctx.shadowColor='#ff3333'; ctx.fillStyle='#ff3333';
    ctx.save(); ctx.scale(pulse,pulse);
    ctx.beginPath();
    ctx.moveTo(0,-12); ctx.lineTo(-9,-4); ctx.lineTo(-13,5);
    ctx.lineTo(-7,12); ctx.lineTo(0,8); ctx.lineTo(7,12);
    ctx.lineTo(13,5); ctx.lineTo(9,-4); ctx.closePath(); ctx.fill();
    ctx.fillStyle='#ffee00'; ctx.shadowColor='#ffee00'; ctx.shadowBlur=8;
    ctx.beginPath(); ctx.arc(-4,-2,2.5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(4,-2,2.5,0,Math.PI*2); ctx.fill();
    ctx.restore();
  } else if(e.type==='fast'){
    ctx.shadowBlur=12; ctx.shadowColor='#ff9900'; ctx.fillStyle='#ff9900';
    ctx.save(); ctx.scale(pulse,pulse);
    ctx.beginPath();
    ctx.moveTo(0,-13); ctx.lineTo(-5,-2); ctx.lineTo(-12,3);
    ctx.lineTo(-5,8); ctx.lineTo(0,13); ctx.lineTo(5,8);
    ctx.lineTo(12,3); ctx.lineTo(5,-2); ctx.closePath(); ctx.fill();
    ctx.fillStyle='#fff'; ctx.shadowColor='#fff'; ctx.shadowBlur=4;
    ctx.beginPath(); ctx.arc(-3,-1,2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(3,-1,2,0,Math.PI*2); ctx.fill();
    ctx.restore();
  } else if(e.type==='tank'){
    const c=e.hp===3?'#cc00ff':e.hp===2?'#aa00cc':'#880099';
    ctx.shadowBlur=16; ctx.shadowColor=c; ctx.fillStyle=c;
    ctx.save(); ctx.scale(pulse*1.15,pulse*1.15);
    ctx.beginPath(); ctx.arc(0,0,13,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#ff88ff'; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.stroke();
    ctx.fillStyle='#ffaaff'; ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2); ctx.fill();
    ctx.restore();
  } else if(e.type==='bomber'){
    // Hexagonal bomber â€” lime-yellow, drops spread bombs
    const c='#aaff00';
    ctx.shadowBlur=14; ctx.shadowColor=c; ctx.fillStyle=c;
    ctx.save(); ctx.scale(pulse*1.1,pulse*1.1);
    // Hexagon body
    ctx.beginPath();
    for(let i=0;i<6;i++){
      const a=Math.PI/6+i*Math.PI/3;
      i===0 ? ctx.moveTo(Math.cos(a)*13,Math.sin(a)*13) : ctx.lineTo(Math.cos(a)*13,Math.sin(a)*13);
    }
    ctx.closePath(); ctx.fill();
    // Inner darker hex
    ctx.fillStyle='#446600'; ctx.shadowBlur=0;
    ctx.beginPath();
    for(let i=0;i<6;i++){
      const a=Math.PI/6+i*Math.PI/3;
      i===0 ? ctx.moveTo(Math.cos(a)*7,Math.sin(a)*7) : ctx.lineTo(Math.cos(a)*7,Math.sin(a)*7);
    }
    ctx.closePath(); ctx.fill();
    // Cannon nubs
    ctx.fillStyle='#ffff44'; ctx.shadowColor='#ffff44'; ctx.shadowBlur=6;
    ctx.fillRect(-8,10,5,8);
    ctx.fillRect(3,10,5,8);
    ctx.restore();
  } else if(e.type==='sniper'){
    // Elongated diamond â€” blue, charges before firing precise shots
    const c=e.charging?'#ff5544':'#3399ff';
    const gc=e.charging?'#ff8877':'#66bbff';
    ctx.shadowBlur=14; ctx.shadowColor=c; ctx.fillStyle=c;
    ctx.save(); ctx.scale(pulse,pulse);
    // Elongated diamond body
    ctx.beginPath();
    ctx.moveTo(0,-17);  ctx.lineTo(-9,-2);
    ctx.lineTo(-6,12);  ctx.lineTo(0,17);
    ctx.lineTo(6,12);   ctx.lineTo(9,-2);
    ctx.closePath(); ctx.fill();
    // Inner glowing stripe
    ctx.fillStyle=gc; ctx.shadowColor=gc; ctx.shadowBlur=6;
    ctx.beginPath();
    ctx.moveTo(0,-12); ctx.lineTo(-4,0); ctx.lineTo(0,12); ctx.lineTo(4,0);
    ctx.closePath(); ctx.fill();
    // Charging ring
    if(e.charging){
      const cp=e.chargeTimer/60;
      ctx.globalAlpha=cp*0.75;
      ctx.strokeStyle='#ff2200'; ctx.lineWidth=2;
      ctx.shadowColor='#ff2200'; ctx.shadowBlur=14;
      ctx.beginPath(); ctx.arc(0,0,12+cp*7,0,Math.PI*2); ctx.stroke();
      ctx.globalAlpha=1;
    }
    ctx.restore();
  } else if(e.type==='stealth'){
    // Ghost-like, semi-transparent teal enemy
    ctx.globalAlpha=0.22+Math.sin(e.animT*2.5)*0.18;
    ctx.shadowBlur=14; ctx.shadowColor='#44ffcc'; ctx.fillStyle='#44ffcc';
    ctx.save(); ctx.scale(pulse,pulse);
    ctx.beginPath();
    ctx.moveTo(0,-14); ctx.lineTo(-10,3); ctx.lineTo(-6,12);
    ctx.lineTo(0,8);   ctx.lineTo(6,12); ctx.lineTo(10,3);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='#aaffee'; ctx.shadowBlur=4;
    ctx.beginPath(); ctx.arc(0,-3,3.5,0,Math.PI*2); ctx.fill();
    ctx.restore();
    ctx.globalAlpha=1;
  } else if(e.type==='zigzag'){
    // Arrow/lightning shape â€” magenta, erratic movement
    ctx.shadowBlur=12; ctx.shadowColor='#ff44ff'; ctx.fillStyle='#ff44ff';
    ctx.save(); ctx.scale(pulse,pulse);
    ctx.beginPath();
    ctx.moveTo(0,-14); ctx.lineTo(-12,4); ctx.lineTo(-4,1);
    ctx.lineTo(0,14);  ctx.lineTo(4,1);  ctx.lineTo(12,4);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='#ffaaff'; ctx.shadowColor='#ffaaff'; ctx.shadowBlur=5;
    ctx.beginPath(); ctx.arc(0,-4,3,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  ctx.shadowBlur=0; ctx.restore();
}

function drawBoss(b){
  if(!b) return;
  const pulse=0.95+Math.sin(b.animT*2)*0.05;
  const phase2=b.hp<=b.maxHp/2;
  const bodyColor=phase2?'#cc0033':'#0044cc';
  const wingColor=phase2?'#990022':'#003399';
  const glowColor=phase2?'#ff2244':'#2266ff';

  ctx.save(); ctx.translate(b.x,b.y); ctx.scale(pulse,pulse);
  ctx.shadowBlur=28; ctx.shadowColor=glowColor;

  // Wings
  ctx.fillStyle=wingColor;
  ctx.beginPath(); ctx.moveTo(-32,-14); ctx.lineTo(-70,8); ctx.lineTo(-68,26); ctx.lineTo(-32,20); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(32,-14); ctx.lineTo(70,8); ctx.lineTo(68,26); ctx.lineTo(32,20); ctx.closePath(); ctx.fill();

  // Main body
  ctx.fillStyle=bodyColor;
  ctx.beginPath();
  ctx.moveTo(0,-30); ctx.lineTo(-32,-10); ctx.lineTo(-36,26);
  ctx.lineTo(0,32);  ctx.lineTo(36,26);  ctx.lineTo(32,-10);
  ctx.closePath(); ctx.fill();

  // Centre core
  ctx.fillStyle='#ffffff'; ctx.shadowColor='#ffffff'; ctx.shadowBlur=18;
  ctx.beginPath(); ctx.arc(0,0,11,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=phase2?'#ff2244':'#00aaff';
  ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();

  // Cannon ports
  ctx.fillStyle='#ff5500'; ctx.shadowColor='#ff5500'; ctx.shadowBlur=8;
  ctx.beginPath(); ctx.arc(-20,20,5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(20,20,5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0,28,5,0,Math.PI*2); ctx.fill();
  if(phase2){
    ctx.fillStyle='#ff2200'; ctx.shadowColor='#ff2200';
    ctx.beginPath(); ctx.arc(-52,16,4,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(52,16,4,0,Math.PI*2); ctx.fill();
  }

  ctx.shadowBlur=0; ctx.restore();
}

function drawBullet(b,enemy=false){
  ctx.save(); ctx.shadowBlur=12;
  if(enemy){
    if(b.type==='bomb'){
      ctx.shadowColor='#aaff00'; ctx.fillStyle='#ccff44';
      ctx.beginPath(); ctx.arc(b.x,b.y,5,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#ffff88'; ctx.shadowBlur=0;
      ctx.fillRect(b.x-2,b.y-1,4,2); ctx.fillRect(b.x-1,b.y-2,2,4);
    } else if(b.type==='sniper'){
      ctx.shadowColor='#3399ff'; ctx.fillStyle='#66ccff';
      ctx.save(); ctx.translate(b.x,b.y);
      const ang=Math.atan2(b.vy,b.vx)+Math.PI/2;
      ctx.rotate(ang);
      ctx.fillRect(-1.5,-10,3,20);
      ctx.fillStyle='#fff'; ctx.fillRect(-0.5,-10,1,6);
      ctx.restore();
    } else {
      ctx.shadowColor='#ff3333'; ctx.fillStyle='#ff5555';
      ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fill();
    }
  } else {
    const s=SKINS[chosenSkin];
    ctx.shadowColor=s.color; ctx.fillStyle=s.color;
    ctx.fillRect(b.x-2,b.y-9,4,14);
    ctx.fillStyle='#fff'; ctx.shadowColor='#fff';
    ctx.fillRect(b.x-1,b.y-9,2,6);
  }
  ctx.shadowBlur=0; ctx.restore();
}

function drawPowerup(p){
  ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.t*0.025);
  const cols={life:'#ff3366',rapid:'#ffcc00',shield:'#00ccff'};
  const c=cols[p.type]||'#fff';
  ctx.shadowBlur=18; ctx.shadowColor=c;
  const g=ctx.createRadialGradient(0,0,2,0,0,13);
  g.addColorStop(0,c); g.addColorStop(1,'transparent');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,13,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold 13px sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.shadowBlur=0;
  ctx.fillText(p.type==='life'?'â™¥':p.type==='rapid'?'âš¡':'ðŸ›¡',0,1);
  ctx.restore();
}

function drawStarfield(){
  ctx.fillStyle='#000010'; ctx.fillRect(0,0,W,H);
  stars.forEach(s=>{
    s.y+=s.speed; if(s.y>H){s.y=0;s.x=Math.random()*W;}
    ctx.globalAlpha=0.3+Math.sin(s.phase+=0.02)*0.2;
    ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1;
}

function drawHUD(){
  const s=SKINS[chosenSkin];
  ctx.save();
  ctx.font='bold 14px Orbitron'; ctx.fillStyle=s.color; ctx.shadowBlur=8; ctx.shadowColor=s.color;
  ctx.textAlign='left'; ctx.fillText('SCORE  '+score,14,26);
  ctx.textAlign='right'; ctx.fillText('HI  '+Math.max(score,hiScore),W-14,26);
  for(let i=0;i<lives;i++){
    ctx.save(); ctx.translate(14+i*24,H-22); ctx.scale(0.48,0.48);
    drawShip(0,0,chosenSkin,1,false); ctx.restore();
  }
  // Level display
  ctx.textAlign='center'; ctx.font='11px Rajdhani'; ctx.fillStyle='#555'; ctx.shadowBlur=0;
  if(boss){
    ctx.fillStyle='#ff3355'; ctx.shadowBlur=6; ctx.shadowColor='#ff3355';
    ctx.font='bold 11px Orbitron';
    ctx.fillText('BOSS WAVE',CX,H-13);
    ctx.shadowBlur=0;
  } else {
    ctx.fillText('LEVEL '+level+'  â€¢  WAVE '+wave,CX,H-13);
  }
  // Boss HP bar
  if(boss){
    const barW=220, barH=11;
    const bx=CX-barW/2, by=40;
    const phase2=boss.hp<=boss.maxHp/2;
    const barColor=phase2?'#ff2244':'#2266ff';
    ctx.fillStyle='#220011'; ctx.fillRect(bx,by,barW,barH);
    ctx.fillStyle=barColor; ctx.shadowBlur=8; ctx.shadowColor=barColor;
    ctx.fillRect(bx,by,barW*(boss.hp/boss.maxHp),barH);
    ctx.shadowBlur=0;
    ctx.strokeStyle='#666'; ctx.lineWidth=1; ctx.strokeRect(bx,by,barW,barH);
    ctx.font='bold 9px Orbitron'; ctx.fillStyle='#fff'; ctx.textAlign='center';
    ctx.fillText('BOSS  '+boss.hp+'/'+boss.maxHp,CX,by+barH+11);
  }
  ctx.restore();
}

// â”€â”€ UPGRADE SCREEN â”€â”€
function drawUpgradeScreen(){
  drawStarfield();
  ctx.save(); ctx.textAlign='center';
  ctx.font='bold 22px Orbitron'; ctx.fillStyle='#00e5ff'; ctx.shadowBlur=20; ctx.shadowColor='#00e5ff';
  ctx.fillText('WAVE '+(wave-1)+' COMPLETE!',CX,68);
  ctx.shadowBlur=0; ctx.font='bold 13px Orbitron'; ctx.fillStyle='#ffcc00'; ctx.shadowBlur=8; ctx.shadowColor='#ffcc00';
  ctx.fillText('CHOOSE AN UPGRADE',CX,100);
  ctx.shadowBlur=0;
  upgradeChoices.forEach((upg,i)=>{
    const cardY=158+i*158;
    const sel=i===upgradeSelectedIdx;
    ctx.globalAlpha=sel?0.32:0.10;
    ctx.fillStyle=upg.color;
    ctx.fillRect(44,cardY-58,W-88,116);
    ctx.globalAlpha=1;
    if(sel){
      ctx.strokeStyle=upg.color; ctx.lineWidth=2;
      ctx.shadowBlur=14; ctx.shadowColor=upg.color;
      ctx.strokeRect(44,cardY-58,W-88,116);
      ctx.shadowBlur=0;
    }
    // Icon
    ctx.font='34px sans-serif'; ctx.textAlign='left';
    ctx.fillText(upg.icon,72,cardY+12);
    // Name
    ctx.font='bold 15px Orbitron'; ctx.fillStyle=sel?upg.color:'#fff';
    ctx.shadowBlur=sel?8:0; ctx.shadowColor=upg.color;
    ctx.fillText(upg.name,122,cardY-14);
    ctx.shadowBlur=0;
    // Desc
    ctx.font='13px Rajdhani'; ctx.fillStyle='#999';
    ctx.fillText(upg.desc,122,cardY+12);
    // Current stacks if any
    const stacks=playerUpgrades[upg.id]||0;
    if(stacks>0){
      ctx.font='11px Orbitron'; ctx.fillStyle=upg.color;
      ctx.fillText('Ã—'+stacks+' active',122,cardY+32);
    }
    // Key hint
    ctx.textAlign='right';
    ctx.font='bold 13px Orbitron'; ctx.fillStyle='#555';
    ctx.fillText('['+(i+1)+']',W-58,cardY-14);
    ctx.textAlign='center';
  });
  ctx.shadowBlur=0; ctx.font='12px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText(isMobileDevice?'TAP A CARD TO SELECT':'1 / 2 / 3  OR  â†‘â†“ + ENTER / SPACE',CX,H-20);
  ctx.restore();
}

// â”€â”€ SCREENS â”€â”€
function drawMenu(){
  drawStarfield();
  ctx.save(); ctx.textAlign='center';
  ctx.font='900 58px Orbitron'; ctx.shadowBlur=50; ctx.shadowColor='#00e5ff'; ctx.fillStyle='#00e5ff';
  ctx.fillText('NOVA',CX,200);
  ctx.fillStyle='#fff'; ctx.shadowColor='#fff'; ctx.shadowBlur=20;
  ctx.fillText('STRIKE',CX,268);
  ctx.shadowBlur=0; ctx.font='14px Rajdhani'; ctx.fillStyle='#666';
  ctx.fillText('HI-SCORE: '+hiScore,CX,310);
  const p=0.8+Math.sin(Date.now()*0.004)*0.2;
  ctx.globalAlpha=p;
  ctx.font='bold 18px Orbitron'; ctx.fillStyle='#00e5ff'; ctx.shadowBlur=14; ctx.shadowColor='#00e5ff';
  ctx.fillText(isMobileDevice?'[ TAP TO START ]':'[ PRESS SPACE TO START ]',CX,400);
  ctx.globalAlpha=1; ctx.shadowBlur=0;
  ctx.font='13px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText(isMobileDevice?'TAP BELOW TO CUSTOMIZE':'C  â†’  CUSTOMIZE SHIP',CX,450);
  drawShip(CX,540,chosenSkin,2.2,false);
  ctx.font='bold 12px Orbitron'; ctx.fillStyle=SKINS[chosenSkin].color;
  ctx.shadowBlur=8; ctx.shadowColor=SKINS[chosenSkin].color;
  ctx.fillText(SKINS[chosenSkin].name,CX,590);
  ctx.restore();
}

function drawCustomize(){
  drawStarfield();
  ctx.save(); ctx.textAlign='center';
  ctx.font='bold 30px Orbitron'; ctx.fillStyle='#fff'; ctx.shadowBlur=20; ctx.shadowColor='#fff';
  ctx.fillText('CHOOSE YOUR SHIP',CX,55);
  const cols=3;
  for(let i=0;i<SKINS.length;i++){
    const col=i%cols, row=Math.floor(i/cols);
    const x=80+col*160, y=155+row*200;
    const sel=i===chosenSkin;
    ctx.globalAlpha=sel?0.25:0.07;
    ctx.fillStyle=SKINS[i].color;
    ctx.fillRect(x-52,y-65,104,148);
    ctx.globalAlpha=1;
    if(sel){
      ctx.strokeStyle=SKINS[i].color; ctx.lineWidth=2; ctx.shadowBlur=14; ctx.shadowColor=SKINS[i].color;
      ctx.strokeRect(x-52,y-65,104,148);
    }
    drawShip(x,y,i,1.5,false);
    ctx.shadowBlur=sel?10:0; ctx.shadowColor=SKINS[i].color;
    ctx.font=(sel?'bold ':'')+'12px Orbitron';
    ctx.fillStyle=sel?SKINS[i].color:'#666';
    ctx.fillText(SKINS[i].name,x,y+65);
    if(sel){
      ctx.shadowBlur=0; ctx.font='11px Rajdhani'; ctx.fillStyle='#aaa';
      ctx.fillText('â† â†’  to change',x,y+82);
    }
  }
  ctx.shadowBlur=0;
  ctx.font='bold 15px Orbitron'; ctx.fillStyle='#00e5ff'; ctx.shadowBlur=10; ctx.shadowColor='#00e5ff';
  ctx.fillText(isMobileDevice?'[ TAP BOTTOM TO PLAY ]':'[ SPACE ]  PLAY',CX,H-58);
  ctx.shadowBlur=0; ctx.font='12px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText('ESC  â†’  BACK',CX,H-30);
  ctx.restore();
}

function drawGameOver(){
  drawStarfield();
  ctx.save(); ctx.textAlign='center';
  ctx.font='bold 50px Orbitron'; ctx.fillStyle='#ff3366'; ctx.shadowBlur=30; ctx.shadowColor='#ff3366';
  ctx.fillText('GAME OVER',CX,220);
  ctx.shadowBlur=0; ctx.font='22px Rajdhani'; ctx.fillStyle='#aaa';
  ctx.fillText('SCORE: '+score,CX,280);
  if(score>0&&score>=hiScore){
    ctx.fillStyle='#ffcc00'; ctx.font='bold 16px Orbitron'; ctx.shadowBlur=10; ctx.shadowColor='#ffcc00';
    ctx.fillText('âœ¦  NEW HIGH SCORE  âœ¦',CX,318);
  }
  ctx.shadowBlur=0; ctx.font='14px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText('HI-SCORE: '+Math.max(score,hiScore),CX,352);
  const p=0.65+Math.sin(Date.now()*0.004)*0.35;
  ctx.globalAlpha=p;
  ctx.font='bold 18px Orbitron'; ctx.fillStyle='#00e5ff'; ctx.shadowBlur=12; ctx.shadowColor='#00e5ff';
  ctx.fillText(isMobileDevice?'[ TAP TO PLAY AGAIN ]':'[ SPACE ]  PLAY AGAIN',CX,428);
  ctx.globalAlpha=1; ctx.shadowBlur=0;
  ctx.font='13px Rajdhani'; ctx.fillStyle='#444';
  ctx.fillText('C  â†’  CHANGE SHIP',CX,468);
  ctx.restore();
}

// â”€â”€ LEVEL BANNER OVERLAY â”€â”€
function drawLevelBanner(){
  if(levelBanner<=0 && bossWarning<=0) return;
  const isBoss=bossWarning>0;
  const timer=isBoss?bossWarning:levelBanner;
  const totalDur=isBoss?120:180;
  const fadeFrames=25;
  const elapsed=totalDur-timer;
  let a;
  if(elapsed<fadeFrames) a=elapsed/fadeFrames;
  else if(timer<fadeFrames) a=timer/fadeFrames;
  else a=1;

  ctx.save();
  ctx.globalAlpha=a*0.88;
  ctx.fillStyle='#000'; ctx.fillRect(0,H/2-70,W,140);
  ctx.globalAlpha=a;

  if(isBoss){
    const pulse=0.6+Math.sin(Date.now()*0.015)*0.4;
    ctx.globalAlpha=a*Math.max(0.3,pulse);
    ctx.font='bold 13px Orbitron'; ctx.fillStyle='#ff2244'; ctx.textAlign='center';
    ctx.shadowBlur=20; ctx.shadowColor='#ff2244';
    ctx.fillText('WARNING',CX,H/2-30);
    ctx.globalAlpha=a;
    ctx.font='bold 36px Orbitron'; ctx.fillStyle='#ff5566';
    ctx.fillText('BOSS APPROACHING',CX,H/2+12);
    ctx.font='14px Rajdhani'; ctx.fillStyle='#ff9900'; ctx.shadowBlur=0;
    ctx.fillText('LEVEL '+level+' GUARDIAN',CX,H/2+44);
  } else {
    ctx.font='bold 13px Orbitron'; ctx.fillStyle='#666'; ctx.textAlign='center'; ctx.shadowBlur=0;
    ctx.fillText('LEVEL '+level,CX,H/2-22);
    ctx.font='bold 32px Orbitron'; ctx.fillStyle='#00e5ff';
    ctx.shadowBlur=28; ctx.shadowColor='#00e5ff';
    ctx.fillText(getLevelName(level),CX,H/2+20);
    ctx.shadowBlur=0; ctx.font='12px Rajdhani'; ctx.fillStyle='#555';
    ctx.fillText(getEnemyTypes().join(' Â· ').toUpperCase(),CX,H/2+48);
  }
  ctx.restore();
}

// â”€â”€ UPDATE â”€â”€
function update(){
  tick++;

  if(state==='menu'){
    if(keys[' ']){ state='playing'; resetGame(); gtag('event','game_start',{game:'Nova Strike'}); keys[' ']=false; return; }
    if(keys['c']||keys['C']){ state='customize'; keys['c']=keys['C']=false; return; }
    return;
  }
  if(state==='customize'){
    if(keys['ArrowRight']||keys['d']){ chosenSkin=(chosenSkin+1)%SKINS.length; keys['ArrowRight']=keys['d']=false; }
    if(keys['ArrowLeft']||keys['a']){ chosenSkin=(chosenSkin+SKINS.length-1)%SKINS.length; keys['ArrowLeft']=keys['a']=false; }
    if(keys[' ']){ state='playing'; resetGame(); gtag('event','game_start',{game:'Nova Strike'}); keys[' ']=false; return; }
    if(keys['Escape']){ state='menu'; keys['Escape']=false; return; }
    return;
  }
  if(state==='gameover'){
    if(keys[' ']){ state='playing'; resetGame(); gtag('event','game_start',{game:'Nova Strike'}); keys[' ']=false; return; }
    if(keys['c']||keys['C']){ state='customize'; keys['c']=keys['C']=false; return; }
    return;
  }
  if(state==='upgrade'){
    if(keys['1']||keys['Numpad1']){ selectUpgrade(0); keys['1']=keys['Numpad1']=false; return; }
    if(keys['2']||keys['Numpad2']){ selectUpgrade(1); keys['2']=keys['Numpad2']=false; return; }
    if(keys['3']||keys['Numpad3']){ selectUpgrade(2); keys['3']=keys['Numpad3']=false; return; }
    if(keys['ArrowUp']||keys['w']){ upgradeSelectedIdx=(upgradeSelectedIdx+upgradeChoices.length-1)%upgradeChoices.length; keys['ArrowUp']=keys['w']=false; }
    if(keys['ArrowDown']||keys['s']){ upgradeSelectedIdx=(upgradeSelectedIdx+1)%upgradeChoices.length; keys['ArrowDown']=keys['s']=false; }
    if(keys[' ']||keys['Enter']){ selectUpgrade(upgradeSelectedIdx); keys[' ']=keys['Enter']=false; return; }
    return;
  }

  // â”€â”€ PLAYING â”€â”€
  // Countdown timers
  if(levelBanner>0) levelBanner--;
  if(bossWarning>0) bossWarning--;

  // Player move
  // Keyboard movement
  if((keys['ArrowLeft']||keys['a'])&&player.x>26) player.x-=player.speed;
  if((keys['ArrowRight']||keys['d'])&&player.x<W-26) player.x+=player.speed;
  if((keys['ArrowUp']||keys['w'])&&player.y>H/2) player.y-=player.speed;
  if((keys['ArrowDown']||keys['s'])&&player.y<H-28) player.y+=player.speed;
  // Touch movement â€” glide toward finger
  if(touchActive) {
    const dx = touchX - player.x, dy = touchY - 40 - player.y;
    const dist = Math.sqrt(dx*dx+dy*dy);
    if(dist > 4) {
      player.x += (dx/dist) * Math.min(player.speed, dist);
      player.y += (dy/dist) * Math.min(player.speed, dist);
    }
    player.x = Math.max(26, Math.min(W-26, player.x));
    player.y = Math.max(H/2, Math.min(H-28, player.y));
  }

  // Trail
  if(tick%3===0){
    const s=SKINS[chosenSkin];
    trails.push({x:player.x+(Math.random()-0.5)*8,y:player.y+16,
      vx:(Math.random()-0.5)*0.4,vy:rand(1,2.5),life:1,r:rand(1,3),color:s.trail});
  }

  // Shoot
  const baseRate=Math.max(5,13-(playerUpgrades.rof||0)*2);
  const rate=player.rapidFire>0?5:baseRate;
  player.shootTimer++;
  if(player.shootTimer>=rate&&(keys[' ']||touchActive)){
    player.shootTimer=0;
    sfx.play('shoot');
    const dmg=(playerUpgrades.power||0)>0?2:1;
    bullets.push({x:player.x,y:player.y-18,speed:12,dmg});
    if(player.rapidFire>0||(playerUpgrades.spread||0)>0||(playerUpgrades.multi||0)>0){
      bullets.push({x:player.x-11,y:player.y-10,speed:12,dx:-0.6,dmg});
      bullets.push({x:player.x+11,y:player.y-10,speed:12,dx:0.6,dmg});
    }
    if((playerUpgrades.multi||0)>0){
      bullets.push({x:player.x-22,y:player.y-6,speed:12,dx:-1.3,dmg});
      bullets.push({x:player.x+22,y:player.y-6,speed:12,dx:1.3,dmg});
    }
  }

  // Move bullets
  bullets=bullets.filter(b=>{b.y-=b.speed;if(b.dx)b.x+=b.dx;return b.y>-10&&b.x>-10&&b.x<W+10;});
  eBullets=eBullets.filter(b=>{b.x+=b.vx;b.y+=b.vy;return b.y<H+10&&b.x>-10&&b.x<W+10;});

  // Timers
  if(player.invincible>0) player.invincible--;
  if(player.shield>0) player.shield--;
  if(player.rapidFire>0) player.rapidFire--;

  // Formation oscillation
  const formX=Math.sin(tick*0.013)*24;
  const formY=Math.sin(tick*0.008)*7;

  // Enemy update
  enemies.forEach(e=>{
    e.animT+=0.05; e.t++;
    if(e.diving){
      const spd=e.type==='fast'?2.5:e.type==='bomber'?1.5:1.8;
      e.divePathIdx+=spd;
      if(e.divePathIdx>=e.divePath.length-1){
        e.diving=false; e.inFormation=true;
        e.x=e.hx+formX; e.y=e.hy+formY;
      } else {
        const idx=Math.floor(e.divePathIdx);
        const next=Math.min(idx+1,e.divePath.length-1);
        const frac=e.divePathIdx-idx;
        e.x=e.divePath[idx].x*(1-frac)+e.divePath[next].x*frac;
        e.y=e.divePath[idx].y*(1-frac)+e.divePath[next].y*frac;
        // Shoot during dive
        if(e.type==='bomber'){
          if(Math.random()<0.005){
            [-0.55,0,0.55].forEach(ox=>{
              eBullets.push({x:e.x,y:e.y,vx:ox*2,vy:2.8,type:'bomb'});
            });
          }
        } else if(Math.random()<0.003&&e.type!=='tank'){
          const ang=Math.atan2(player.y-e.y,player.x-e.x);
          eBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*3.2,vy:Math.sin(ang)*3.2});
        }
      }
    } else if(!e.inFormation){
      if(e.t<e.enterT) return;
      const tx=e.hx+formX, ty=e.hy+formY;
      const dx=tx-e.x, dy=ty-e.y, d=Math.sqrt(dx*dx+dy*dy);
      const spd=3.5+wave*0.18;
      if(d<spd+2){ e.x=tx; e.y=ty; e.inFormation=true; }
      else { e.x+=dx/d*spd; e.y+=dy/d*spd; }
    } else {
      // zigzag enemies get extra sinusoidal x offset in formation
      const zzOff=e.type==='zigzag'?Math.sin(tick*0.05+e.animT)*32:0;
      e.x=e.hx+formX+zzOff; e.y=e.hy+formY;
      // Dive attempt (snipers/stealth don't dive; bombers dive rarely)
      const noDive=e.type==='sniper'||e.type==='stealth'||e.charging;
      if(!noDive){
        const diveChance=(0.00025+wave*0.0001)*(divers.length<3?1:0)*(e.type==='bomber'?0.5:1);
        if(Math.random()<diveChance&&e.y>0&&e.y<H-80){
          e.diving=true; e.inFormation=false;
          e.divePath=buildDivePath(e); e.divePathIdx=0;
          divers.push(e);
        }
      }
      // Shooting by type
      if(e.type==='sniper'){
        if(e.charging){
          e.chargeTimer++;
          if(e.chargeTimer>=60){
            if(e.chargeTarget&&e.y>0){
              const ang=Math.atan2(e.chargeTarget.y-e.y,e.chargeTarget.x-e.x);
              eBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*5,vy:Math.sin(ang)*5,type:'sniper'});
            }
            e.charging=false; e.chargeTimer=0;
          }
        } else {
          e.shootTimer--;
          if(e.shootTimer<=0&&e.y>0){
            e.shootTimer=randInt(160,310-Math.min(wave,20)*5);
            e.charging=true; e.chargeTimer=0;
            e.chargeTarget={x:player.x,y:player.y};
          }
        }
      } else if(e.type==='bomber'){
        e.shootTimer--;
        if(e.shootTimer<=0&&e.y>0){
          e.shootTimer=randInt(140,260-Math.min(wave,15)*5);
          [-0.5,0,0.5].forEach(ox=>{
            eBullets.push({x:e.x,y:e.y,vx:ox*1.6,vy:3,type:'bomb'});
          });
        }
      } else if(e.type==='stealth'){
        e.shootTimer--;
        if(e.shootTimer<=0&&e.y>0){
          e.shootTimer=randInt(140,280-Math.min(wave,15)*6);
          const ang=Math.atan2(player.y-e.y,player.x-e.x);
          eBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*2.4,vy:Math.sin(ang)*2.4});
        }
      } else if(e.type==='zigzag'){
        e.shootTimer--;
        if(e.shootTimer<=0&&e.y>0){
          e.shootTimer=randInt(100,220-Math.min(wave,15)*6);
          const ang=Math.atan2(player.y-e.y,player.x-e.x);
          eBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*2.8,vy:Math.sin(ang)*2.8});
        }
      } else {
        // basic, fast, tank
        e.shootTimer--;
        if(e.shootTimer<=0&&e.y>0){
          e.shootTimer=randInt(130,290-Math.min(wave,18)*7);
          const ang=Math.atan2(player.y-e.y,player.x-e.x);
          eBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*2.6,vy:Math.sin(ang)*2.6});
        }
      }
    }
  });

  // Boss update
  updateBoss();

  // Clean divers
  divers=divers.filter(d=>d.diving);

  // Bullet-enemy collisions
  for(let bi=bullets.length-1;bi>=0;bi--){
    const b=bullets[bi];
    // Check boss
    if(boss&&Math.abs(b.x-boss.x)<42&&Math.abs(b.y-boss.y)<36){
      bullets.splice(bi,1);
      boss.hp-=(b.dmg||1);
      burst(b.x,b.y,'#4488ff',6);
      if(boss.hp<=0){
        burst(boss.x,boss.y,'#ffffff',40);
        burst(boss.x,boss.y,'#4488ff',25);
        for(let i=0;i<3;i++){
          const t=['life','rapid','shield'][i];
          powerups.push({x:boss.x+rand(-30,30),y:boss.y,type:t,vy:1.5,t:0});
        }
        const scoreBonus=Math.round((2000+Math.floor(wave/5)*500)*(1+(playerUpgrades.score||0)*0.5));
        score+=scoreBonus;
        sfx.play('explode');
        shake(16,30);
        boss=null;
        const oldLevel=Math.ceil(wave/3);
        wave++;
        const newLevel=Math.ceil(wave/3);
        level=newLevel;
        if(newLevel>oldLevel){ levelBanner=180; }
        upgradeChoices=getRandomUpgrades(3); upgradeSelectedIdx=0; state='upgrade';
      }
      break;
    }
    // Check regular enemies
    for(let ei=enemies.length-1;ei>=0;ei--){
      const e=enemies[ei];
      if(Math.abs(b.x-e.x)<15&&Math.abs(b.y-e.y)<15){
        bullets.splice(bi,1);
        e.hp-=(b.dmg||1);
        const hitCol=e.type==='bomber'?'#aaff00':e.type==='sniper'?'#3399ff':e.type==='stealth'?'#44ffcc':e.type==='zigzag'?'#ff44ff':e.type==='tank'?'#cc00ff':'#ff4444';
        burst(e.x,e.y,hitCol,8);
        if(e.hp<=0){
          const pts=e.type==='tank'?150:e.type==='bomber'?100:e.type==='sniper'?120:e.type==='stealth'?80:e.type==='zigzag'?90:e.type==='fast'?75:50;
          score+=Math.round(pts*(1+(playerUpgrades.score||0)*0.5));
          sfx.play('explode');
          burst(e.x,e.y,hitCol,18);
          if(Math.random()<0.12){
            const t=['life','rapid','shield'][randInt(0,2)];
            powerups.push({x:e.x,y:e.y,type:t,vy:1.5,t:0});
          }
          enemies.splice(ei,1);
          shake(4,8);
        }
        break;
      }
    }
  }

  // Enemy bullet - player
  if(player.invincible<=0){
    for(let i=eBullets.length-1;i>=0;i--){
      const b=eBullets[i];
      if(Math.abs(b.x-player.x)<16&&Math.abs(b.y-player.y)<14){
        eBullets.splice(i,1);
        if(player.shield>0){ player.shield=0; shake(6,12); }
        else { hitPlayer(); }
      }
    }
    // Enemy body collision (diving)
    enemies.forEach(e=>{
      if(e.diving&&Math.abs(e.x-player.x)<20&&Math.abs(e.y-player.y)<20){
        if(player.shield>0){ player.shield=0; shake(8,14); }
        else { hitPlayer(); }
      }
    });
    // Boss body collision
    if(boss&&Math.abs(boss.x-player.x)<48&&Math.abs(boss.y-player.y)<40){
      if(player.shield>0){ player.shield=0; shake(10,16); }
      else { hitPlayer(); }
    }
  }

  // Powerups
  for(let i=powerups.length-1;i>=0;i--){
    const p=powerups[i]; p.y+=p.vy; p.t++;
    if(Math.abs(p.x-player.x)<22&&Math.abs(p.y-player.y)<22){
      if(p.type==='life') lives=Math.min(lives+1,5);
      else if(p.type==='rapid') player.rapidFire=300;
      else player.shield=400;
      burst(p.x,p.y,'#ffff00',12);
      sfx.play('powerup');
      powerups.splice(i,1);
    } else if(p.y>H+20) powerups.splice(i,1);
  }

  // Particles & trails
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=p.fade; if(p.life<=0)particles.splice(i,1);
  }
  for(let i=trails.length-1;i>=0;i--){
    const t=trails[i]; t.x+=t.vx; t.y+=t.vy; t.life-=0.045; if(t.life<=0)trails.splice(i,1);
  }

  // Shake decay
  if(shakeDur>0) shakeDur--;
  else { shakeX*=0.75; shakeY*=0.75; }

  // Next wave â€” advance when all enemies AND boss are gone
  if(enemies.length===0&&!boss){
    sfx.play('win');
    const oldLevel=Math.ceil(wave/3);
    wave++;
    const newLevel=Math.ceil(wave/3);
    level=newLevel;
    if(newLevel>oldLevel){ levelBanner=180; }
    upgradeChoices=getRandomUpgrades(3); upgradeSelectedIdx=0; state='upgrade';
  }
}

function hitPlayer(){
  lives--;
  burst(player.x,player.y,SKINS[chosenSkin].color,22);
  shake(10,20);
  player.invincible=160;
  if(lives<=0){
    hiScore=Math.max(score,hiScore);
    localStorage.setItem('ns2_hi',hiScore);
    sfx.play('die');
    state='gameover';
    gtag('event','game_over',{game:'Nova Strike',score:score,wave:wave});
  }
}

// â”€â”€ RENDER GAME â”€â”€
function renderGame(){
  drawStarfield();
  ctx.save();
  if(shakeDur>0||Math.abs(shakeX)>0.1) ctx.translate(shakeX,shakeY);

  trails.forEach(t=>{
    ctx.globalAlpha=t.life*0.55;
    ctx.fillStyle=t.color; ctx.shadowBlur=6; ctx.shadowColor=t.color;
    ctx.beginPath(); ctx.arc(t.x,t.y,t.r,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1; ctx.shadowBlur=0;

  particles.forEach(p=>{
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color; ctx.shadowBlur=10; ctx.shadowColor=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1; ctx.shadowBlur=0;

  // Sniper telegraph lines
  enemies.forEach(e=>{
    if(e.type==='sniper'&&e.charging&&e.chargeTarget){
      const cp=e.chargeTimer/60;
      ctx.save();
      ctx.globalAlpha=cp*0.65;
      ctx.strokeStyle='#ff3300'; ctx.lineWidth=1.5;
      ctx.shadowBlur=8; ctx.shadowColor='#ff3300';
      ctx.setLineDash([5,5]);
      ctx.beginPath(); ctx.moveTo(e.x,e.y); ctx.lineTo(e.chargeTarget.x,e.chargeTarget.y);
      ctx.stroke(); ctx.setLineDash([]);
      ctx.restore();
    }
  });

  powerups.forEach(drawPowerup);
  eBullets.forEach(b=>drawBullet(b,true));
  bullets.forEach(b=>drawBullet(b,false));
  enemies.forEach(drawEnemy);
  drawBoss(boss);

  // Player
  if(!player.dead){
    const show=player.invincible<=0||Math.floor(player.invincible/6)%2===0;
    if(show){
      if(player.shield>0){
        ctx.save(); ctx.globalAlpha=0.28+Math.sin(Date.now()*0.012)*0.12;
        ctx.strokeStyle='#00ccff'; ctx.lineWidth=3; ctx.shadowBlur=22; ctx.shadowColor='#00ccff';
        ctx.beginPath(); ctx.arc(player.x,player.y,30,0,Math.PI*2); ctx.stroke();
        ctx.globalAlpha=1; ctx.restore();
      }
      drawShip(player.x,player.y,chosenSkin,1,true);
    }
  }

  ctx.restore();
  drawHUD();
  drawLevelBanner();
}

// â”€â”€ MAIN LOOP â”€â”€
resetGame();
function loop(){
  requestAnimationFrame(loop);
  update();
  if(state==='menu') drawMenu();
  else if(state==='customize') drawCustomize();
  else if(state==='playing') renderGame();
  else if(state==='gameover') drawGameOver();
  else if(state==='upgrade') drawUpgradeScreen();
}
loop();
</script>
</body>
</html>
