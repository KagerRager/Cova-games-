<!DOCTYPE html>
<html lang="en">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P1VFNJ21V0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-P1VFNJ21V0');</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9556113318001178" crossorigin="anonymous"></script>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™®</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crystal Miner ‚Äì GameCave</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:#060310;}
body{display:flex;flex-direction:column;font-family:'Nunito',sans-serif;}
.topbar{flex-shrink:0;background:rgba(6,3,16,0.96);border-bottom:2px solid #1e1038;padding:0.6rem 1.2rem;display:flex;align-items:center;justify-content:space-between;z-index:10;}
.logo{font-family:'Cinzel',serif;font-size:1.1rem;font-weight:900;color:#e8a020;text-decoration:none;letter-spacing:0.08em;}
.logo span{color:#ffcc55;}
.back{color:#9a8870;text-decoration:none;font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;padding:0.35rem 0.9rem;border:1px solid #2a1850;border-radius:3px;transition:all .15s;}
.back:hover{color:#ffcc55;border-color:#9b5de5;}
canvas{display:block;flex:1;touch-action:none;cursor:crosshair;}
</style>
</head>
<body>
<div class="topbar">
  <a class="logo" href="index.html">ü™® GAME<span>CAVE</span></a>
  <a class="back" href="index.html">‚Üê Back</a>
</div>
<canvas id="c"></canvas>
<script>
'use strict';
const C = document.getElementById('c');
const X = C.getContext('2d');
let W, H;

function resize() {
  const rect = C.getBoundingClientRect();
  W = C.width  = window.innerWidth;
  H = C.height = window.innerHeight - rect.top;
  if(phase==='play') buildLayout();
}
resize();
window.addEventListener('resize', () => { resize(); if(phase!=='play') drawMenu(); else draw(); });

/* ‚îÄ‚îÄ‚îÄ GEM DEFINITIONS ‚îÄ‚îÄ‚îÄ */
const GDEFS = [
  {e:'üíé', col:'#3db8a0', glow:'61,184,160',  hp:1, pts:50,  name:'Crystal'},
  {e:'üíú', col:'#9b59b6', glow:'155,89,182',   hp:2, pts:35,  name:'Amethyst'},
  {e:'üî¥', col:'#e74c3c', glow:'231,76,60',    hp:2, pts:40,  name:'Ruby'},
  {e:'üíõ', col:'#e8a020', glow:'232,160,32',   hp:1, pts:25,  name:'Topaz'},
  {e:'üîµ', col:'#2980b9', glow:'41,128,185',   hp:3, pts:60,  name:'Sapphire'},
  {e:'üíö', col:'#27ae60', glow:'39,174,96',    hp:1, pts:20,  name:'Emerald'},
  {e:'üåü', col:'#f1c40f', glow:'241,196,15',   hp:1, pts:100, name:'Star Gem'},
];

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
const HUD_H = 72;
const TIMER_H = 14;
const PADDING = 12;
let COLS, ROWS, CELL, GRID_X, GRID_Y, GRID_W, GRID_H;

function buildLayout() {
  const availW = W - PADDING*2;
  const availH = H - HUD_H - TIMER_H - PADDING*3 - 50; // 50 for bottom breathing room
  // Pick cols/rows to fill the space nicely
  COLS = Math.min(6, Math.max(3, Math.round(Math.sqrt(availW/availH * 20))));
  ROWS = Math.min(5, Math.max(3, Math.round(availH/availW * COLS * (availH/availW))));
  CELL = Math.min(Math.floor(availW/COLS)-4, Math.floor(availH/ROWS)-4, 88);
  GRID_W = COLS * CELL + (COLS-1) * 4;
  GRID_H = ROWS * CELL + (ROWS-1) * 4;
  GRID_X = (W - GRID_W) / 2;
  GRID_Y = HUD_H + TIMER_H + PADDING * 2;
}

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
let gems=[], parts=[], score=0, hi=parseInt(localStorage.getItem('crystalminer_hi'))||0, wave=1;
let timerMax=0, timerLeft=0, timerLastMs=0;
let running=false, phase='menu', raf=0;
let shake=0, transitioning=false;
let waveFlashA=0, waveFlashTxt='';

function startWave() {
  gems = [];
  const maxG = Math.min(wave, GDEFS.length);
  // For wave 1 use only gems hp=1. More variety as waves grow.
  const pool = GDEFS.slice(0, maxG);
  const total = COLS * ROWS;
  const count = Math.min(Math.floor(total*0.55) + wave*2, total - 1);
  const indices = shuffle([...Array(total).keys()]).slice(0, count);

  indices.forEach(i => {
    const base = pool[Math.floor(Math.random()*pool.length)];
    gems[i] = {
      ...base,
      cracked: 0,
      alive: true,
      sealed: false,
      pulse: Math.random()*Math.PI*2,
      shake: 0,
      hitFlash: 0,
    };
  });

  timerMax   = Math.max(8000, 22000 - wave*1600);
  timerLeft  = timerMax;
  timerLastMs = 0;
}

function shuffle(a) {
  for(let i=a.length-1;i>0;i--) {
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ‚îÄ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ */
function burst(x,y,col,n,spd) {
  spd=spd||6;
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, s=spd*(0.3+Math.random());
    parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:1.5+Math.random()*4,col,a:1,d:0.025+Math.random()*0.02,type:'dot'});
  }
}

function shard(x,y,col,n) {
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, s=3+Math.random()*6;
    parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,w:2+Math.random()*5,h:1+Math.random()*2,col,a:1,d:0.03,rot:Math.random()*Math.PI*2,vr:(Math.random()-0.5)*0.3,type:'shard'});
  }
}

function popTxt(x,y,txt,col,big) {
  parts.push({x,y,vx:(Math.random()-0.5)*0.6,vy:-3,col,a:1,d:0.02,txt,sz:big?26:18,type:'txt'});
}

/* ‚îÄ‚îÄ‚îÄ HIT A GEM ‚îÄ‚îÄ‚îÄ */
function hitGem(idx) {
  const g = gems[idx];
  if(!g || !g.alive || !running || transitioning) return;

  g.cracked++;
  g.shake = 10;
  g.hitFlash = 1;
  shake = 4;

  const cx = GRID_X + (idx%COLS)*(CELL+4) + CELL/2;
  const cy = GRID_Y + Math.floor(idx/COLS)*(CELL+4) + CELL/2;

  burst(cx, cy, g.col, 6, 3);

  if(g.cracked >= g.hp) {
    // MINED!
    g.alive = false;
    shard(cx, cy, g.col, 14);
    burst(cx, cy, g.col, 22, 8);
    burst(cx, cy, '#fff', 8, 5);
    const isStar = g.name === 'Star Gem';
    score += g.pts;
    if(score > hi) { hi = score; localStorage.setItem('crystalminer_hi', hi); }
    popTxt(cx, cy-40, '+'+g.pts+(isStar?' ‚≠ê':''), g.col, isStar);
    shake = isStar ? 12 : 5;
    gtag('event','gem_mined',{game:'Crystal Miner',gem:g.name,pts:g.pts});

    // Check if wave is clear
    const alive = gems.filter(g => g && g.alive).length;
    if(alive === 0) advanceWave();
  }
}

function advanceWave() {
  transitioning = true;
  wave++;
  waveFlashTxt = 'WAVE ' + wave + ' ‚õè';
  waveFlashA = 1;
  burst(W/2, H/2, '#e8a020', 35, 11);
  burst(W/2, H/2, '#ffcc55', 20, 8);
  setTimeout(() => {
    buildLayout();
    startWave();
    transitioning = false;
  }, 900);
}

/* ‚îÄ‚îÄ‚îÄ SEAL (timer expired) ‚îÄ‚îÄ‚îÄ */
function sealAll() {
  running = false;
  const alive = gems.map((g,i)=>g&&g.alive?i:-1).filter(i=>i>=0);
  let i=0;
  const seq = setInterval(() => {
    if(i >= alive.length) {
      clearInterval(seq);
      setTimeout(() => { phase='over'; drawGameOver(); }, 500);
      return;
    }
    const g = gems[alive[i]];
    if(g) { g.alive=false; g.sealed=true; shake=3; }
    i++;
  }, 55);
  gtag('event','game_over',{game:'Crystal Miner',score,wave});
}

/* ‚îÄ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ‚îÄ */
function update(ms) {
  if(!running || transitioning) return;

  // Timer
  if(timerLastMs) {
    timerLeft -= ms - timerLastMs;
    if(timerLeft <= 0) { timerLeft=0; sealAll(); return; }
  }
  timerLastMs = ms;

  // Gem pulses & shakes
  gems.forEach(g => {
    if(!g) return;
    g.pulse += 0.06;
    if(g.shake > 0) g.shake = Math.max(0, g.shake - 1.5);
    if(g.hitFlash > 0) g.hitFlash = Math.max(0, g.hitFlash - 0.1);
  });

  // Particles
  parts.forEach(p => {
    p.x += p.vx; p.y += p.vy;
    if(p.type==='dot'||p.type==='shard') { p.vx*=0.88; p.vy+=0.1; }
    if(p.type==='shard') p.rot+=p.vr;
    p.a -= p.d;
  });
  parts = parts.filter(p => p.a > 0);

  if(shake > 0) shake = Math.max(0, shake-1.2);
  if(waveFlashA > 0) waveFlashA -= 0.015;
}

/* ‚îÄ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ */
function draw(ms) {
  X.save();
  if(shake>0) {
    const s=shake*0.5;
    X.translate((Math.random()-0.5)*s,(Math.random()-0.5)*s);
  }

  // BG
  const bg=X.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#060310'); bg.addColorStop(1,'#0c0520');
  X.fillStyle=bg; X.fillRect(0,0,W,H);

  // Subtle rock grain
  X.strokeStyle='rgba(255,255,255,0.012)'; X.lineWidth=1;
  for(let i=0;i<12;i++){
    const rx=i*(W/11);
    X.beginPath(); X.moveTo(rx+Math.sin(i)*15,0); X.lineTo(rx+Math.sin(i+1)*15,H); X.stroke();
  }

  // ‚îÄ‚îÄ GRID CELLS ‚îÄ‚îÄ
  for(let i=0; i<ROWS*COLS; i++) {
    const col = i%COLS, row = Math.floor(i/COLS);
    const cx = GRID_X + col*(CELL+4);
    const cy = GRID_Y + row*(CELL+4);
    const g = gems[i];

    // Empty cell bg
    X.fillStyle='rgba(15,8,30,0.85)';
    X.beginPath(); X.roundRect(cx,cy,CELL,CELL,8); X.fill();
    X.strokeStyle='rgba(40,20,70,0.6)'; X.lineWidth=1;
    X.beginPath(); X.roundRect(cx,cy,CELL,CELL,8); X.stroke();

    if(!g) continue;

    if(g.sealed) {
      // Sealed in stone
      X.fillStyle='rgba(18,10,32,0.9)';
      X.beginPath(); X.roundRect(cx,cy,CELL,CELL,8); X.fill();
      X.font=`${CELL*0.44}px serif`;
      X.textAlign='center'; X.textBaseline='middle';
      X.fillText('ü™®', cx+CELL/2, cy+CELL/2);
      continue;
    }

    if(!g.alive) continue;

    const sx = g.shake>0 ? (Math.random()-0.5)*g.shake : 0;
    const sy = g.shake>0 ? (Math.random()-0.5)*g.shake : 0;
    const sc = 0.9 + Math.sin(g.pulse)*0.07;
    const ccx = cx+CELL/2+sx, ccy = cy+CELL/2+sy;

    // Glow behind cell
    const gl=X.createRadialGradient(ccx,ccy,0,ccx,ccy,CELL*0.75);
    gl.addColorStop(0,`rgba(${g.glow},0.22)`); gl.addColorStop(1,'transparent');
    X.fillStyle=gl; X.beginPath(); X.arc(ccx,ccy,CELL*0.75,0,Math.PI*2); X.fill();

    // Cell border color-tinted
    X.strokeStyle = g.col + '66'; X.lineWidth=2;
    X.beginPath(); X.roundRect(cx+1,cy+1,CELL-2,CELL-2,7); X.stroke();

    // Hit flash overlay
    if(g.hitFlash>0) {
      X.globalAlpha=g.hitFlash*0.4;
      X.fillStyle='#fff';
      X.beginPath(); X.roundRect(cx+1,cy+1,CELL-2,CELL-2,7); X.fill();
      X.globalAlpha=1;
    }

    // Crack lines on face
    if(g.cracked>0) {
      X.save(); X.translate(ccx,ccy);
      X.globalAlpha=0.55;
      X.strokeStyle='rgba(0,0,0,0.9)'; X.lineWidth=2;
      // fixed crack pattern based on cracked count so it doesn't shimmer
      for(let c=0;c<g.cracked*3;c++){
        const seed=c*137.5+i*53.1;
        const ang=seed%(Math.PI*2);
        const len=8+((seed*7)%16);
        const ox=(((seed*13)%20)-10);
        const oy=(((seed*17)%20)-10);
        X.beginPath(); X.moveTo(ox,oy); X.lineTo(ox+Math.cos(ang)*len,oy+Math.sin(ang)*len); X.stroke();
      }
      X.globalAlpha=1; X.restore();
    }

    // Emoji
    X.save(); X.translate(ccx,ccy); X.scale(sc,sc);
    X.font=`${CELL*0.48}px serif`;
    X.textAlign='center'; X.textBaseline='middle';
    X.fillText(g.e, 0, 0);
    X.restore();

    // HP indicator dots (top of cell)
    if(g.hp>1){
      const dotR=4, dotSpacing=11, startX=ccx-((g.hp-1)*dotSpacing)/2;
      for(let d=0;d<g.hp;d++){
        X.fillStyle = d<g.cracked ? 'rgba(255,255,255,0.15)' : g.col;
        X.beginPath(); X.arc(startX+d*dotSpacing, cy+8, dotR, 0, Math.PI*2); X.fill();
      }
    }
  }

  // Particles
  parts.forEach(p => {
    X.globalAlpha=Math.max(0,p.a);
    if(p.type==='txt'){
      X.font=`bold ${p.sz}px Cinzel,serif`;
      X.textAlign='center'; X.textBaseline='middle';
      X.fillStyle=p.col; X.fillText(p.txt,p.x,p.y);
    } else if(p.type==='shard'){
      X.save(); X.translate(p.x,p.y); X.rotate(p.rot);
      X.fillStyle=p.col; X.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      X.restore();
    } else {
      X.fillStyle=p.col; X.beginPath(); X.arc(p.x,p.y,p.r,0,Math.PI*2); X.fill();
    }
  });
  X.globalAlpha=1;

  // Wave transition flash
  if(waveFlashA>0) {
    X.globalAlpha=waveFlashA*0.15;
    X.fillStyle='#e8a020'; X.fillRect(0,0,W,H);
    X.globalAlpha=waveFlashA;
    X.font=`bold ${Math.min(40,W*0.09)}px Cinzel,serif`;
    X.textAlign='center'; X.textBaseline='middle'; X.fillStyle='#ffcc55';
    X.fillText(waveFlashTxt, W/2, H/2);
    X.globalAlpha=1;
  }

  // ‚îÄ‚îÄ TIMER BAR ‚îÄ‚îÄ
  const tbX=GRID_X, tbY=HUD_H+PADDING, tbW=GRID_W, tbH=TIMER_H;
  X.fillStyle='rgba(0,0,0,0.5)'; X.beginPath(); X.roundRect(tbX,tbY,tbW,tbH,6); X.fill();
  const pct = timerLeft/timerMax;
  const tc = pct>0.5 ? '#3db8a0' : pct>0.25 ? '#e8a020' : '#e74c3c';
  X.fillStyle=tc; X.beginPath(); X.roundRect(tbX,tbY,tbW*pct,tbH,6); X.fill();
  if(pct<0.25){ // danger glow
    X.shadowColor=tc; X.shadowBlur=12;
    X.fillStyle=tc; X.beginPath(); X.roundRect(tbX,tbY,tbW*pct,tbH,6); X.fill();
    X.shadowBlur=0;
  }

  // ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
  X.fillStyle='rgba(6,3,16,0.93)'; X.fillRect(0,0,W,HUD_H);
  X.strokeStyle='rgba(30,16,56,0.9)'; X.lineWidth=1.5;
  X.beginPath(); X.moveTo(0,HUD_H); X.lineTo(W,HUD_H); X.stroke();

  const p=16;
  X.textBaseline='top';

  X.textAlign='left';
  X.font='bold 10px Nunito,sans-serif'; X.fillStyle='#9a8870'; X.fillText('SCORE',p,p);
  X.font='bold 26px Cinzel,serif'; X.fillStyle='#ffcc55'; X.fillText(score,p,p+13);

  X.textAlign='center';
  X.font='bold 10px Nunito,sans-serif'; X.fillStyle='#9a8870'; X.fillText('BEST',W/2,p);
  X.font='bold 20px Cinzel,serif'; X.fillStyle='#e8a020'; X.fillText(hi,W/2,p+13);

  X.textAlign='center';
  X.font='bold 10px Nunito,sans-serif'; X.fillStyle='#9a8870'; X.fillText('WAVE',W*0.72,p);
  X.font='bold 20px Cinzel,serif'; X.fillStyle='#9b59b6'; X.fillText(wave,W*0.72,p+13);

  const alive=gems.filter(g=>g&&g.alive).length;
  X.textAlign='right';
  X.font='bold 10px Nunito,sans-serif'; X.fillStyle='#9a8870'; X.fillText('LEFT',W-p,p);
  X.font='bold 20px Cinzel,serif'; X.fillStyle='#3db8a0'; X.fillText(alive,W-p,p+13);

  X.restore();
}

function drawMenu() {
  const bg=X.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#060310'); bg.addColorStop(1,'#0c0520');
  X.fillStyle=bg; X.fillRect(0,0,W,H);

  // Decorative gem grid in bg
  X.globalAlpha=0.06;
  const ges=['üíé','üíú','üîµ','üíõ','üíö'];
  X.font=`${Math.min(40,W/12)}px serif`;
  X.textAlign='center'; X.textBaseline='middle';
  for(let i=0;i<25;i++){
    X.fillStyle='#fff';
    X.fillText(ges[i%ges.length],(i%5)*(W/4)+W/8,Math.floor(i/5)*(H/6)+H/12);
  }
  X.globalAlpha=1;

  X.textAlign='center'; X.textBaseline='middle';
  X.font=`bold ${Math.min(48,W*0.1)}px Cinzel,serif`;
  X.shadowColor='#9b59b6'; X.shadowBlur=35; X.fillStyle='#e8a020';
  X.fillText('CRYSTAL MINER', W/2, H*0.36);
  X.shadowBlur=0;

  X.font=`${Math.min(15,W*0.038)}px Nunito,sans-serif`; X.fillStyle='#9a8870';
  X.fillText('Mine every gem before the cave seals them in stone!', W/2, H*0.47);
  X.fillText('Tough gems (üîµ üî¥ üíú) need multiple hits ‚Äî crack dots show HP', W/2, H*0.53);
  X.fillText('üåü Star Gems worth 100 pts ‚Äî appear from Wave 7', W/2, H*0.59);

  drawButton(W/2, H*0.71, '‚õè  START MINING', '#9b59b6', '#3db8a0');
}

function drawGameOver() {
  X.fillStyle='rgba(0,0,0,0.82)'; X.fillRect(0,0,W,H);
  X.textAlign='center'; X.textBaseline='middle';

  X.font=`bold ${Math.min(46,W*0.1)}px Cinzel,serif`;
  X.shadowColor='#9b59b6'; X.shadowBlur=28; X.fillStyle='#e74c3c';
  X.fillText('CAVE SEALED!', W/2, H*0.3);
  X.shadowBlur=0;

  X.font=`bold ${Math.min(26,W*0.065)}px Nunito,sans-serif`; X.fillStyle='#f0e6d0';
  X.fillText('Score  ' + score, W/2, H*0.42);
  X.fillText('Best   ' + hi,    W/2, H*0.50);

  X.font=`${Math.min(15,W*0.038)}px Nunito,sans-serif`; X.fillStyle='#9a8870';
  X.fillText('Wave reached: ' + wave, W/2, H*0.58);
  const msg=score>=1000?'Master Miner! üèÜ':score>=500?'Solid haul ‚õè':'The cave won this time...';
  X.fillText(msg, W/2, H*0.64);

  drawButton(W/2, H*0.75, '‚õè  MINE AGAIN', '#9b59b6', '#3db8a0');
}

function drawButton(cx,cy,label,c1,c2){
  const bw=Math.min(270,W*0.65), bh=54, bx=cx-bw/2, by=cy-bh/2;
  const g=X.createLinearGradient(bx,cy,bx+bw,cy);
  g.addColorStop(0,c1); g.addColorStop(1,c2);
  X.fillStyle=g; X.beginPath(); X.roundRect(bx,by,bw,bh,bh/2); X.fill();
  X.font='bold 17px Cinzel,serif'; X.fillStyle='#f0e6d0';
  X.textAlign='center'; X.textBaseline='middle'; X.fillText(label,cx,cy);
}

/* ‚îÄ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ */
function gameLoop(ms) {
  update(ms);
  draw(ms);
  if(running || transitioning) raf=requestAnimationFrame(gameLoop);
}

/* ‚îÄ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ */
function getCell(ex,ey){
  const col=Math.floor((ex-GRID_X)/(CELL+4));
  const row=Math.floor((ey-GRID_Y)/(CELL+4));
  if(col<0||col>=COLS||row<0||row>=ROWS) return -1;
  // Make sure the tap is actually inside the cell (not in the gap)
  const cx=GRID_X+col*(CELL+4), cy=GRID_Y+row*(CELL+4);
  if(ex<cx||ex>cx+CELL||ey<cy||ey>cy+CELL) return -1;
  return row*COLS+col;
}

C.addEventListener('pointerdown', e => {
  const r=C.getBoundingClientRect();
  const ex=e.clientX-r.left, ey=e.clientY-r.top;
  if(phase!=='play'){ startGame(); return; }
  const idx=getCell(ex,ey);
  if(idx>=0) hitGem(idx);
},{passive:true});

function startGame(){
  cancelAnimationFrame(raf);
  score=0; wave=1; phase='play'; running=true; transitioning=false;
  parts=[]; timerLastMs=0;
  buildLayout(); startWave();
  gtag('event','game_start',{game:'Crystal Miner'});
  raf=requestAnimationFrame(gameLoop);
}

phase='menu'; buildLayout(); drawMenu();
</script>
</body>
</html>
