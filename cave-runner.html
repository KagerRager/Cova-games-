<!DOCTYPE html>
<html lang="en">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P1VFNJ21V0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-P1VFNJ21V0');</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9556113318001178" crossorigin="anonymous"></script>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™®</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cave Runner ‚Äì GameCave</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{--gold:#e8a020;--gold2:#ffcc55;--ember:#ff6a00;--bg:#0d0a07;--card:#211a12;--border:#4a3820;--crystal:#3db8a0;--text:#f0e6d0;--muted:#9a8870;}
  *{box-sizing:border-box;margin:0;padding:0;}
  @media(pointer:coarse){body{cursor:auto!important;}}
  body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}
  body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 60%,rgba(232,160,32,0.05) 0%,transparent 50%);pointer-events:none;z-index:0;}

  /* NAV */
  .topbar{background:rgba(13,10,7,0.95);border-bottom:2px solid var(--border);padding:0.7rem 1.5rem;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;position:relative;z-index:10;}
  .logo{font-family:'Cinzel',serif;font-size:1.2rem;font-weight:900;color:var(--gold);text-shadow:0 0 12px rgba(232,160,32,0.4);text-decoration:none;letter-spacing:0.08em;}
  .logo span{color:var(--gold2);}
  .back-btn{color:var(--muted);text-decoration:none;font-size:0.8rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;transition:color 0.15s;padding:0.4rem 1rem;border:1px solid var(--border);border-radius:3px;}
  .back-btn:hover{color:var(--gold2);border-color:var(--gold);}

  /* MAIN */
  .main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.5rem;gap:1rem;position:relative;z-index:1;}

  /* HUD */
  .hud{display:flex;gap:2rem;align-items:center;justify-content:center;flex-wrap:wrap;}
  .stat-box{text-align:center;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:0.5rem 1.2rem;}
  .stat-val{font-family:'Cinzel',serif;font-size:1.8rem;font-weight:700;color:var(--gold);line-height:1;text-shadow:0 0 10px rgba(232,160,32,0.4);}
  .stat-label{font-size:0.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-top:0.15rem;}

  /* CANVAS */
  canvas{display:block;border:2px solid var(--border);border-radius:4px;box-shadow:0 0 30px rgba(232,160,32,0.08);max-width:100%;}

  /* CONTROLS */
  .controls{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;justify-content:center;}
  .btn{font-family:'Nunito',sans-serif;font-weight:800;font-size:0.85rem;letter-spacing:0.06em;text-transform:uppercase;padding:0.6rem 1.8rem;border-radius:4px;border:none;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;}
  .btn:hover{transform:translateY(-2px);}
  .btn-gold{background:linear-gradient(135deg,var(--gold),var(--ember));color:#1a0e00;box-shadow:0 4px 0 #5a3000;}
  .btn-gold:hover{box-shadow:0 6px 0 #5a3000;}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
  .btn-ghost:hover{color:var(--gold2);border-color:var(--gold);}

  .hint{font-size:0.75rem;color:var(--muted);letter-spacing:0.05em;}

  /* JUMP BTN (mobile) */
  .jump-btn{width:80px;height:60px;background:var(--card);border:2px solid var(--border);border-radius:6px;color:var(--gold2);font-size:1.4rem;cursor:pointer;transition:background 0.1s;display:flex;align-items:center;justify-content:center;}
  .jump-btn:active{background:var(--gold);color:#1a0e00;}
</style>
</head>
<body>
<!-- LOADING SCREEN -->
<div id="loadingScreen" style="position:fixed;inset:0;z-index:9999;background:#0d0a07;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.5s ease;">
  <div style="font-family:'Cinzel',serif;font-size:2.5rem;font-weight:900;color:#e8a020;text-shadow:0 0 20px rgba(232,160,32,0.6);letter-spacing:0.1em;">ü™® GAMECAVE</div>
  <div style="margin-top:1rem;font-family:'Nunito',sans-serif;font-size:1rem;color:#9a8870;letter-spacing:0.15em;text-transform:uppercase;">Loading‚Ä¶</div>
  <div style="margin-top:1.5rem;width:120px;height:4px;background:#211a12;border-radius:2px;overflow:hidden;">
    <div id="loadBar" style="height:100%;background:#e8a020;width:0%;transition:width 0.7s ease;border-radius:2px;"></div>
  </div>
</div>
<script>
  document.getElementById('loadBar').style.width = '100%';
  window.addEventListener('load', () => {
    setTimeout(() => {
      const ls = document.getElementById('loadingScreen');
      ls.style.opacity = '0';
      setTimeout(() => ls.style.display = 'none', 500);
    }, 400);
  });
</script>

<div class="topbar">
  <a class="logo" href="index.html">ü™® GAME<span>CAVE</span></a>
  <a class="back-btn" href="index.html">‚Üê Back</a>
</div>

<div class="main">
  <div class="hud">
    <div class="stat-box"><div class="stat-val" id="scoreVal">0</div><div class="stat-label">Score</div></div>
    <div class="stat-box"><div class="stat-val" id="hiVal">0</div><div class="stat-label">Best</div></div>
    <div class="stat-box"><div class="stat-val" id="levelVal">1</div><div class="stat-label">Level</div></div>
  </div>

  <canvas id="c" width="560" height="220"></canvas>

  <div class="controls">
    <button class="btn btn-gold" id="startBtn" onclick="startGame()">‚ñ∂ Start</button>
    <button class="jump-btn" id="jumpBtn">‚Üë</button>
    <span class="hint">Space / Tap to jump</span>
  </div>
  <div style="display:flex;align-items:center;justify-content:center;gap:0.6rem;flex-wrap:wrap;margin-top:0.2rem;">
    <span style="font-size:0.65rem;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;">Explorer:</span>
    <button id="pc0" onclick="playerColor='#c87832';updatePC(0)" style="width:26px;height:26px;border-radius:50%;background:#c87832;border:3px solid #fff;cursor:pointer;outline:none;" title="Brown"></button>
    <button id="pc1" onclick="playerColor='#3a8050';updatePC(1)" style="width:26px;height:26px;border-radius:50%;background:#3a8050;border:3px solid transparent;cursor:pointer;outline:none;" title="Green"></button>
    <button id="pc2" onclick="playerColor='#6040a0';updatePC(2)" style="width:26px;height:26px;border-radius:50%;background:#6040a0;border:3px solid transparent;cursor:pointer;outline:none;" title="Purple"></button>
    <button id="pc3" onclick="playerColor='#c03030';updatePC(3)" style="width:26px;height:26px;border-radius:50%;background:#c03030;border:3px solid transparent;cursor:pointer;outline:none;" title="Red"></button>
    <button id="pc4" onclick="playerColor='#208080';updatePC(4)" style="width:26px;height:26px;border-radius:50%;background:#208080;border:3px solid transparent;cursor:pointer;outline:none;" title="Teal"></button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ SOUND ENGINE ‚îÄ‚îÄ
const sfx = (() => {
  let ctx;
  function ensure() { if (!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)(); return ctx; }
  function play(name) {
    try {
      const c = ensure();
      const g = c.createGain();
      g.connect(c.destination);
      const o = c.createOscillator();
      o.connect(g);
      const t = c.currentTime;
      if (name==='start') {
        o.frequency.setValueAtTime(440,t); o.frequency.linearRampToValueAtTime(880,t+0.15);
        g.gain.setValueAtTime(0.25,t); g.gain.linearRampToValueAtTime(0,t+0.2); o.start(t); o.stop(t+0.2);
      } else if (name==='score'||name==='point') {
        o.frequency.setValueAtTime(660,t); o.frequency.linearRampToValueAtTime(880,t+0.08);
        g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.12); o.start(t); o.stop(t+0.12);
      } else if (name==='coin') {
        // bright ding for coin collect
        o.type='triangle'; o.frequency.setValueAtTime(1047,t); o.frequency.linearRampToValueAtTime(1319,t+0.07);
        g.gain.setValueAtTime(0.22,t); g.gain.linearRampToValueAtTime(0,t+0.12); o.start(t); o.stop(t+0.12);
      } else if (name==='die'||name==='over'||name==='hit') {
        o.type='sawtooth'; o.frequency.setValueAtTime(330,t); o.frequency.linearRampToValueAtTime(110,t+0.3);
        g.gain.setValueAtTime(0.3,t); g.gain.linearRampToValueAtTime(0,t+0.35); o.start(t); o.stop(t+0.35);
      } else if (name==='jump') {
        o.frequency.setValueAtTime(300,t); o.frequency.linearRampToValueAtTime(600,t+0.1);
        g.gain.setValueAtTime(0.18,t); g.gain.linearRampToValueAtTime(0,t+0.12); o.start(t); o.stop(t+0.12);
      } else if (name==='land') {
        // thud when landing
        o.type='triangle'; o.frequency.setValueAtTime(180,t); o.frequency.linearRampToValueAtTime(80,t+0.08);
        g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(t); o.stop(t+0.1);
      } else if (name==='nearMiss') {
        // whoosh near-miss
        o.type='sine'; o.frequency.setValueAtTime(600,t); o.frequency.linearRampToValueAtTime(200,t+0.12);
        g.gain.setValueAtTime(0.08,t); g.gain.linearRampToValueAtTime(0,t+0.15); o.start(t); o.stop(t+0.15);
      } else if (name==='levelup') {
        // ascending fanfare
        [523,659,784,1047].forEach((f,i)=>{ const o2=c.createOscillator(); o2.connect(g); o2.type='triangle'; o2.frequency.value=f; o2.start(t+i*0.08); o2.stop(t+i*0.08+0.1); });
        g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.45); o.disconnect();
      } else if (name==='click') {
        o.frequency.setValueAtTime(800,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.05); o.start(t); o.stop(t+0.05);
      }
    } catch(e) {}
  }
  return { play };
})();

// ‚îÄ‚îÄ PLAYER COLOR ‚îÄ‚îÄ
let playerColor = '#c87832';
function updatePC(idx) {
  document.querySelectorAll('[id^="pc"]').forEach((b,i) => {
    b.style.border = i === idx ? '3px solid #fff' : '3px solid transparent';
  });
}

const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const GROUND_Y   = H - 50;
const PLAYER_W   = 32, PLAYER_H = 32;
const PLAYER_X   = 80;
const GRAVITY    = 0.6;
const JUMP_FORCE = -13;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let player, obstacles, particles, coins, score, coinScore, hi, level, lastLevel, speed, frameCount, running, animId, spawnTimer, coinTimer;
hi = parseInt(localStorage.getItem('caverunner_hi')) || 0;

function initState() {
  player    = { y: GROUND_Y - PLAYER_H, vy: 0, onGround: true, jumpCount: 0 };
  obstacles = [];
  particles = [];
  coins     = [];
  score     = 0;
  coinScore = 0;
  level     = 1;
  speed     = 4;
  frameCount = 0;
  spawnTimer = 0;
  coinTimer  = 0;
  lastLevel  = 1;
}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
function spawnParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 5,
      vy: Math.random() * -4 - 1,
      life: 1,
      color,
      size: Math.random() * 4 + 2
    });
  }
}

function updateParticles() {
  particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 0.04; });
  particles = particles.filter(p => p.life > 0);
}

function drawParticles() {
  particles.forEach(p => {
    ctx.globalAlpha = p.life;
    ctx.fillStyle   = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;
}

// ‚îÄ‚îÄ CAVE BG ‚îÄ‚îÄ
function drawBg() {
  // Sky gradient
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, '#0a0704');
  grad.addColorStop(1, '#1a1208');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, W, H);

  // Distant stalactites
  ctx.fillStyle = '#1e1610';
  for (let i = 0; i < 12; i++) {
    const sx = (i * 52 - (frameCount * speed * 0.2) % 52 + W) % W;
    const sh = 20 + (i * 17) % 30;
    ctx.beginPath();
    ctx.moveTo(sx - 12, 0);
    ctx.lineTo(sx + 12, 0);
    ctx.lineTo(sx, sh);
    ctx.closePath();
    ctx.fill();
  }

  // Torch glow (left side)
  const flicker = 0.7 + Math.sin(frameCount * 0.15) * 0.3;
  const torchGrad = ctx.createRadialGradient(30, GROUND_Y - 10, 0, 30, GROUND_Y - 10, 60 * flicker);
  torchGrad.addColorStop(0, 'rgba(255,150,20,0.25)');
  torchGrad.addColorStop(1, 'transparent');
  ctx.fillStyle = torchGrad;
  ctx.fillRect(0, 0, W, H);

  // Ground
  const groundGrad = ctx.createLinearGradient(0, GROUND_Y, 0, H);
  groundGrad.addColorStop(0, '#3a2810');
  groundGrad.addColorStop(1, '#1a1208');
  ctx.fillStyle = groundGrad;
  ctx.fillRect(0, GROUND_Y, W, H - GROUND_Y);

  // Ground highlight
  ctx.fillStyle = 'rgba(232,160,32,0.15)';
  ctx.fillRect(0, GROUND_Y, W, 2);

  // Scrolling ground pebbles
  ctx.fillStyle = '#2a1e0e';
  for (let i = 0; i < 8; i++) {
    const px = ((i * 80 + 20) - (frameCount * speed) % 640 + 640) % 640;
    ctx.beginPath();
    ctx.ellipse(px, GROUND_Y + 8, 6, 3, 0, 0, Math.PI * 2);
    ctx.fill();
  }
}

// ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ
function drawPlayer() {
  const px = PLAYER_X, py = player.y;

  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.beginPath();
  ctx.ellipse(px + PLAYER_W/2, GROUND_Y + 4, PLAYER_W/2, 5, 0, 0, Math.PI*2);
  ctx.fill();

  // Body ‚Äî little cave explorer torch-lit
  ctx.fillStyle = playerColor;
  ctx.fillRect(px + 6, py + 8, 20, 22); // torso

  // Head
  ctx.fillStyle = '#e8b870';
  ctx.beginPath();
  ctx.arc(px + 16, py + 8, 10, 0, Math.PI * 2);
  ctx.fill();

  // Helmet
  ctx.fillStyle = '#5a3820';
  ctx.fillRect(px + 6, py - 2, 20, 10);
  ctx.fillStyle = '#e8a020';
  ctx.fillRect(px + 8, py - 4, 16, 6);

  // Torch glow around player
  const pg = ctx.createRadialGradient(px+16, py+16, 0, px+16, py+16, 35);
  pg.addColorStop(0, 'rgba(232,160,32,0.12)');
  pg.addColorStop(1, 'transparent');
  ctx.fillStyle = pg;
  ctx.fillRect(px - 20, py - 20, PLAYER_W + 40, PLAYER_H + 40);
}

// ‚îÄ‚îÄ OBSTACLES ‚îÄ‚îÄ
function spawnObstacle() {
  const type = Math.random() < 0.4 ? 'stalactite' : 'rock';
  const h = type === 'rock' ? 25 + Math.floor(Math.random() * 30) : 30 + Math.floor(Math.random() * 25);
  const w = type === 'rock' ? 28 + Math.floor(Math.random() * 20) : 22;
  obstacles.push({
    x: W + 20, w, h, type,
    y: type === 'rock' ? GROUND_Y - h : 0,
    color: type === 'rock' ? '#4a3020' : '#2a1e10',
    scored: false
  });
}

function drawObstacles() {
  obstacles.forEach(ob => {
    if (ob.type === 'rock') {
      // Rock shadow
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.beginPath();
      ctx.ellipse(ob.x + ob.w/2, GROUND_Y + 4, ob.w/2, 4, 0, 0, Math.PI*2);
      ctx.fill();
      // Rock body
      ctx.fillStyle = ob.color;
      ctx.beginPath();
      ctx.moveTo(ob.x + ob.w*0.1, ob.y + ob.h);
      ctx.lineTo(ob.x, ob.y + ob.h*0.7);
      ctx.lineTo(ob.x + ob.w*0.2, ob.y + ob.h*0.3);
      ctx.lineTo(ob.x + ob.w*0.5, ob.y);
      ctx.lineTo(ob.x + ob.w*0.8, ob.y + ob.h*0.2);
      ctx.lineTo(ob.x + ob.w, ob.y + ob.h*0.6);
      ctx.lineTo(ob.x + ob.w*0.9, ob.y + ob.h);
      ctx.closePath();
      ctx.fill();
      ctx.strokeStyle = 'rgba(232,160,32,0.1)';
      ctx.lineWidth = 1;
      ctx.stroke();
    } else {
      // Stalactite (hanging from ceiling)
      ctx.fillStyle = ob.color;
      ctx.beginPath();
      ctx.moveTo(ob.x, 0);
      ctx.lineTo(ob.x + ob.w, 0);
      ctx.lineTo(ob.x + ob.w/2, ob.h);
      ctx.closePath();
      ctx.fill();
      ctx.strokeStyle = 'rgba(232,160,32,0.15)';
      ctx.lineWidth = 1;
      ctx.stroke();
      // Drip
      ctx.fillStyle = 'rgba(61,184,160,0.4)';
      ctx.beginPath();
      ctx.arc(ob.x + ob.w/2, ob.h + 4, 3, 0, Math.PI*2);
      ctx.fill();
    }
  });
}

// ‚îÄ‚îÄ COINS ‚îÄ‚îÄ
function spawnCoin() {
  // Coins float at mid-air height
  const coinY = GROUND_Y - PLAYER_H - 20 - Math.floor(Math.random() * 50);
  coins.push({ x: W + 20, y: coinY, r: 8, alive: true, pulse: Math.random() * Math.PI * 2 });
}

function drawCoins() {
  coins.forEach(cn => {
    if (!cn.alive) return;
    cn.pulse += 0.1;
    const sc = 0.85 + Math.sin(cn.pulse) * 0.15;
    const x = cn.x, y = cn.y;
    // Glow
    const cg = ctx.createRadialGradient(x, y, 0, x, y, cn.r * 2.5 * sc);
    cg.addColorStop(0, 'rgba(255,204,0,0.55)');
    cg.addColorStop(1, 'transparent');
    ctx.fillStyle = cg;
    ctx.beginPath(); ctx.arc(x, y, cn.r * 2.5 * sc, 0, Math.PI*2); ctx.fill();
    // Coin body
    ctx.fillStyle = '#ffcc00';
    ctx.beginPath(); ctx.arc(x, y, cn.r * sc, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#ffe066';
    ctx.beginPath(); ctx.arc(x - 2, y - 2, cn.r * 0.38 * sc, 0, Math.PI*2); ctx.fill();
    // Rim
    ctx.strokeStyle = '#e8a020';
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(x, y, cn.r * sc, 0, Math.PI*2); ctx.stroke();
  });
}

// ‚îÄ‚îÄ COLLISION ‚îÄ‚îÄ
function checkCollision() {
  const px = PLAYER_X + 6, py = player.y + 2, pw = PLAYER_W - 10, ph = PLAYER_H - 4;

  // Near-miss detection (obstacle passed very close without hitting; ~5-20 px window behind player)
  const NEAR_MISS_NEAR = 5, NEAR_MISS_FAR = 20;
  obstacles.forEach(ob => {
    if (!ob.nearMissChecked && ob.x + ob.w < PLAYER_X - NEAR_MISS_NEAR && ob.x + ob.w > PLAYER_X - NEAR_MISS_FAR) {
      ob.nearMissChecked = true;
      sfx.play('nearMiss');
    }
  });

  return obstacles.some(ob => {
    if (ob.type === 'rock') {
      return px < ob.x + ob.w && px + pw > ob.x && py + ph > ob.y && py < ob.y + ob.h;
    } else {
      // stalactite ‚Äî use simple rect of tip area
      const tipX = ob.x + ob.w*0.25, tipW = ob.w*0.5;
      return px < tipX + tipW && px + pw > tipX && py < ob.h && py + ph > 0;
    }
  });
}

// ‚îÄ‚îÄ DRAW SCORE ‚îÄ‚îÄ
function drawHUD() {
  ctx.fillStyle = 'rgba(232,160,32,0.7)';
  ctx.font = 'bold 14px Cinzel, serif';
  ctx.textAlign = 'right';
  ctx.fillText('LVL ' + level, W - 10, 22);
  if (coinScore > 0) {
    ctx.fillStyle = 'rgba(255,204,0,0.85)';
    ctx.font = 'bold 13px Nunito, sans-serif';
    ctx.fillText('ü™ô ' + coinScore, W - 10, 42);
  }
  ctx.textAlign = 'left';
}

// ‚îÄ‚îÄ GAME OVER SCREEN ‚îÄ‚îÄ
function drawGameOver() {
  ctx.fillStyle = 'rgba(0,0,0,0.75)';
  ctx.fillRect(0, 0, W, H);

  ctx.font = 'bold 28px Cinzel, serif';
  ctx.textAlign = 'center';
  ctx.fillStyle = '#e8a020';
  ctx.fillText('GAME OVER', W/2, H/2 - 30);

  ctx.font = '14px Nunito, sans-serif';
  ctx.fillStyle = '#f0e6d0';
  ctx.fillText('Score: ' + score + (coinScore > 0 ? '  ü™ô ' + coinScore + ' coins' : ''), W/2, H/2 + 2);

  ctx.font = '12px Nunito, sans-serif';
  ctx.fillStyle = '#9a8870';
  ctx.fillText('Press Start to try again', W/2, H/2 + 26);
  ctx.textAlign = 'left';
}

function drawIdle() {
  drawBg();
  ctx.font = 'bold 18px Cinzel, serif';
  ctx.textAlign = 'center';
  ctx.fillStyle = 'rgba(232,160,32,0.85)';
  ctx.fillText('CAVE RUNNER', W/2, H/2 - 15);
  ctx.font = '13px Nunito, sans-serif';
  ctx.fillStyle = '#9a8870';
  ctx.fillText('Press ‚ñ∂ Start or SPACE to begin', W/2, H/2 + 14);
  ctx.textAlign = 'left';
}

// ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ
function loop() {
  if (!running) return;
  frameCount++;

  // Increase speed & level
  speed = 4 + Math.floor(score / 15) * 0.5;
  const newLevel = Math.floor(score / 15) + 1;
  if (newLevel > lastLevel) {
    lastLevel = newLevel;
    sfx.play('levelup');
  }
  level = newLevel;
  document.getElementById('levelVal').textContent = level;

  // Spawn obstacles
  const gap = Math.max(55, 100 - score * 0.8);
  spawnTimer++;
  if (spawnTimer > gap) {
    spawnObstacle();
    spawnTimer = 0;
  }

  // Spawn coins (every 90-120 frames)
  coinTimer++;
  if (coinTimer > 90 + Math.floor(Math.random() * 30)) {
    spawnCoin();
    coinTimer = 0;
  }

  // Move obstacles & coins
  obstacles.forEach(ob => ob.x -= speed);
  obstacles = obstacles.filter(ob => ob.x > -60);
  coins.forEach(cn => cn.x -= speed);
  coins = coins.filter(cn => cn.x > -20);

  // Coin collection
  const px = PLAYER_X + 6, py2 = player.y + 2, pw = PLAYER_W - 10, ph = PLAYER_H - 4;
  coins.forEach(cn => {
    if (!cn.alive) return;
    const dist = Math.hypot(PLAYER_X + PLAYER_W/2 - cn.x, player.y + PLAYER_H/2 - cn.y);
    if (dist < cn.r + PLAYER_W * 0.55) {
      cn.alive = false;
      coinScore++;
      sfx.play('coin');
      spawnParticles(cn.x, cn.y, '#ffcc00', 8);
    }
  });

  // Score
  obstacles.forEach(ob => {
    if (!ob.scored && ob.x + ob.w < PLAYER_X) {
      ob.scored = true;
      score++;
      sfx.play('score');
      document.getElementById('scoreVal').textContent = score;
      if (score > hi) {
        hi = score;
        localStorage.setItem('caverunner_hi', hi);
        document.getElementById('hiVal').textContent = hi;
      }
    }
  });

  // Physics
  const wasOnGround = player.onGround;
  if (!player.onGround) {
    player.vy += GRAVITY;
    player.y  += player.vy;
    if (player.y >= GROUND_Y - PLAYER_H) {
      player.y        = GROUND_Y - PLAYER_H;
      player.vy       = 0;
      player.onGround = true;
      player.jumpCount = 0;
      spawnParticles(PLAYER_X + 16, GROUND_Y, '#c87832', 5);
      if (!wasOnGround) sfx.play('land');
    }
  }

  updateParticles();

  // Collision
  if (checkCollision()) {
    spawnParticles(PLAYER_X + 16, player.y + 16, '#e8a020', 20);
    spawnParticles(PLAYER_X + 16, player.y + 16, '#ff6a00', 12);
    endGame();
    return;
  }

  // Draw
  drawBg();
  drawObstacles();
  drawCoins();
  drawParticles();
  drawPlayer();
  drawHUD();

  animId = requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ JUMP ‚îÄ‚îÄ
function jump() {
  if (!running) { startGame(); return; }
  if (player.jumpCount < 2) {
    sfx.play('jump');
    player.vy       = JUMP_FORCE + (player.jumpCount * 2);
    player.onGround = false;
    player.jumpCount++;
    spawnParticles(PLAYER_X + 16, player.y + PLAYER_H, '#9a8870', 6);
  }
}

function startGame() {
  cancelAnimationFrame(animId);
  initState();
  running = true;
  sfx.play('start');
  gtag('event','game_start',{game:'Cave Runner'});
  document.getElementById('startBtn').textContent = '‚Ü∫ Restart';
  loop();
}

function endGame() {
  running = false;
  cancelAnimationFrame(animId);
  sfx.play('die');
  gtag('event','game_over',{game:'Cave Runner',score:score});
  drawGameOver();
  document.getElementById('startBtn').textContent = '‚ñ∂ Start';
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); jump(); }
});
document.getElementById('jumpBtn').addEventListener('click', jump);
canvas.addEventListener('click', jump);

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
initState();
drawIdle();
</script>
</body>
</html>
